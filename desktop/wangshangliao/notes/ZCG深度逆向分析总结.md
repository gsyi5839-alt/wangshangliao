# ZCG 招财狗软件深度逆向分析总结

## 📋 概述

本文档总结了对 `C:\zcg25.12.11` 旧版招财狗软件的深度逆向分析结果，为新版 WSLFramework 的协议重写提供完整参考。

---

## 🔗 一、核心通信协议

### 1.1 HPSocket TCP 配置
```
端口: 14745
PackHeaderFlag: 0xFF
MaxPackSize: 0x100000 (1MB)
通信模式: PACK模式
```

### 1.2 消息格式
消息采用自定义日志格式：
```
RQQ:机器人QQ
群:群号
fromQQ:发送者QQ
beingQQ:被操作QQ
备注:备注信息
数据:数据内容
内容:消息内容
```

---

## 📡 二、API 调用规范

### 2.1 调用格式
```
API名称|参数1|参数2|...|返回结果:Base64编码
```

### 2.2 主要 API 列表

| API名称 | 参数 | 说明 |
|---------|------|------|
| `取当群` | 机器人ID | 获取当前群 |
| `机器_读取机器账号` | 无 | 获取机器人账号 |
| `发送群消息(文本版)` | 机器人ID\|内容\|群ID\|类型\|@标记 | 发送群消息 |
| `发送好友消息` | 机器人ID\|内容\|好友ID | 发送私聊消息 |
| `ww_群禁言解禁` | 机器人ID\|群ID\|操作(1禁/2解) | 群禁言控制 |
| `ww_修改群片` | 机器人ID\|群ID\|成员ID\|新名片 | 修改群名片 |
| `ww_ID查询` | 机器人ID\|查询ID | 查询用户信息 |
| `ww_是否朋友及是否好友_查询` | 机器人ID\|查询ID\|类型 | 检查好友关系 |
| `ww_获取群成员` | 机器人ID\|群ID | 获取群成员列表 |
| `ww_xp登陆接口` | 用户名\|密码等 | 登录验证 |

---

## 📨 三、NIM 消息结构

### 3.1 消息类型码
| 码值 | 类型 | 说明 |
|------|------|------|
| 1001 | P2P | 点对点私聊 |
| 1002 | TEAM | 群聊消息 |
| 1003 | FRIEND_NOTIFY | 好友通知 |
| 1015 | SYSTEM | 系统通知 |

### 3.2 msg_type 字段
| 值 | 类型 |
|-----|------|
| 0 | 文本消息 |
| 1 | 图片消息 |
| 5 | 通知消息 |
| 100 | 自定义消息 |

### 3.3 msg_attach.b 结构
URL-safe Base64 编码的 Protobuf 数据：
```
头部(12字节):
  - 4字节: 魔数 (如 0x0985E20F)
  - 2字节: 版本
  - 2字节: 消息类型
  - 4字节: 数据长度

数据部分:
  - Protobuf 编码的消息内容
  - 可能包含嵌入的 JSON 数据
```

### 3.4 群通知类型
| 通知标识 | 说明 | 关键字段 |
|----------|------|----------|
| `NOTIFY_TYPE_GROUP_MUTE_1` | 群禁言 | team_info.mute_all=1 |
| `NOTIFY_TYPE_GROUP_MUTE_0` | 群解禁 | team_info.mute_all=0 |
| `NOTIFY_TYPE_USER_UPDATE_NAME` | 修改名片 | groupId, nicknameCiphertext |

---

## 🔐 四、加密与编码

### 4.1 配置文件加密
INI 文件值加密规则：
- **数字**: 每位数字 + 0x20，然后十六进制编码，后缀 `20CB5D79B`
- **文本**: GBK 编码 → XOR 混淆 → 十六进制编码
- **布尔**: `ACC920CB5D79B`(false), `C5F620CB5D79B`(true)

### 4.2 昵称加密
`nickname_ciphertext` 使用 AES-128 加密，Base64 编码

### 4.3 数据库加密
`.db` 文件为加密的 SQLite 数据库，无法直接读取

---

## 🎮 五、游戏功能逻辑

### 5.1 开奖周期
- **周期时长**: 210 秒
- **封盘时间**: 开奖前 30 秒
- **倒计时提醒**: 40 秒时发送

### 5.2 消息流程
```
1. 开盘 → 解除禁言
2. 等待投注 (180秒)
3. 40秒倒计时提醒
4. 封盘 → 全体禁言
5. 等待开奖
6. 发送开奖结果
7. 发送账单
8. 返回步骤1
```

### 5.3 开奖消息格式
```
开:7+8+3=18 DAS 期3382926期
```

### 5.4 账单格式
```
開:7 + 8 + 3 = 18 DAS SZ B
殺賬:0  赔分:0
----------------------

----------------------
ls:09 17 13 10 13 05 08 17 22 11 
大小总ls:L B H H H B B B H B 
β维ls:9 4 6 2 7 2 3 9 8 2 
加顺子历史开奖 -- -- -- -- -- -- -- -- -- 
```

---

## 💰 六、上下分与余额

### 6.1 余额查询命令
- `1` - 查询余额
- `2` - 查询历史
- `查` / `余额` - 查询余额

### 6.2 余额查询响应
```
[LQ:@QQ号] (短ID)
老板，您的账户还是零！
当前余额:0
```

### 6.3 上下分命令
- 上分: `c金额`, `+金额`
- 下分: `下金额`, `-金额`

### 6.4 下注命令
| 命令 | 类型 |
|------|------|
| d/D + 金额 | 大 |
| x/X + 金额 | 小 |
| da/DA + 金额 | 大单 |
| ds/DS + 金额 | 大双 |
| xa/XA + 金额 | 小单 |
| xs/XS/xd/XD + 金额 | 小双 |
| bz/BZ + 金额 | 豹子 |
| sz/SZ + 金额 | 顺子 |
| dz/DZ + 金额 | 对子 |

### 6.5 下注失败响应（余额不足）
```
[LQ:@QQ号] (短ID)
余额不足，上分后录取:XD500 DAS500 XS500
```

---

## 👥 七、好友与成员管理

### 7.1 好友申请处理
- 收到 `friendApply` 通知
- 自动同意（如开启）
- 发送欢迎消息

### 7.2 好友欢迎消息
```
娜一(3240)
欢迎入团，钱不要多，运气要帅…
未开盘期间请先来一波
或业务量已结束
```

### 7.3 新成员处理
- 自动修改群名片为 `昵称`
- 发送群内通知

### 7.4 群名片修改通知
```
娜一号(3240)群名片自动修改为:娜一
```

---

## 📁 八、文件结构

### 8.1 旧软件目录
```
c:\zcg25.12.11\
├── xplugin.exe          # 框架主程序
├── xplugin.dll          # 框架DLL
├── zcg.exe              # 机器人程序
├── HPSocket4C.dll       # 网络通信库
├── sqlite3.dll          # 数据库引擎
├── YX_Clinent\          # NIM客户端
│   ├── 621705120\       # 账号目录
│   └── log1\            # 日志目录
├── zcg\                 # 配置和数据
│   ├── 设置.ini         # 主配置
│   ├── 登录配置.ini     # 登录信息
│   ├── 设置.db          # 加密数据库
│   └── ...
└── zcg收发日志\         # 通信日志
```

### 8.2 日志文件
- `*调用日志.txt` - API 调用记录
- `*传到插件日志.txt` - 原始 NIM 消息
- `*时.log` - 收发日志

---

## 🛠️ 九、已实现服务

| 服务文件 | 功能 |
|----------|------|
| `ZCGProtocol.cs` | ZCG协议常量和消息类 |
| `ZCGApiHandler.cs` | API调用处理器 |
| `ZCGFullApiSpec.cs` | 完整API规范 |
| `NimMessageProcessor.cs` | NIM消息解析器 |
| `PeriodManager.cs` | 开奖周期管理 |
| `ZCGResponseFormatter.cs` | 响应格式化器 |
| `ScoreService.cs` | 上下分服务 |
| `GroupManagementService.cs` | 群管理服务 |
| `TimedMessageService.cs` | 定时消息服务 |
| `SettlementService.cs` | 账单结算服务 |
| `FriendManagementService.cs` | 好友管理服务 |
| `NewMemberService.cs` | 新成员处理服务 |

---

## 📊 十、关键发现

1. **定时轮询**: 每5秒调用 `取当群` 和 `机器_读取机器账号`
2. **禁言参数**: 1=禁言, 2=解禁
3. **私聊后缀**: 私聊响应添加剩余时间后缀
4. **API返回值**: 全部Base64加密
5. **数据库加密**: 无法直接读取，需要特殊密钥

---

## ✅ 总结

本次深度逆向分析覆盖了 ZCG 软件的：
- 核心通信协议
- API 调用格式
- NIM 消息结构
- 加密解密方法
- 游戏逻辑流程
- 用户交互格式

所有关键功能已实现为独立服务类，完全兼容原有协议。

---
*文档生成时间: 2026年1月11日*
