# 旺商聊协议深度分析报告

## 一、通信架构

### 1. 进程关系图
```
┌────────────────────────────────────────────────────────────────┐
│                     旺商聊 Electron App                        │
│  (PID: 23492, 端口: 53930)                                     │
│                                                                │
│  ┌─────────────┐     ┌──────────────┐     ┌────────────────┐  │
│  │   渲染进程   │────▶│   主进程     │────▶│  xclient.node  │  │
│  │  (Vue 3)    │ IPC │(XClientServer)│     │  (原生模块)    │  │
│  └─────────────┘     └──────────────┘     └────────────────┘  │
│                              │                    │            │
└──────────────────────────────│────────────────────│────────────┘
                               │ TCP                │ bindings
                               ▼                    │
                    ┌──────────────────┐            │
                    │   xclient.exe    │◀───────────┘
                    │  (PID: 12760)    │
                    │ Port: 21303/21308│
                    └────────┬─────────┘
                             │
                             ▼
                    ┌──────────────────┐
                    │  NIM 云信服务器   │
                    │ (43.159.95.211)  │
                    └──────────────────┘
```

### 2. 核心端口
| 端口 | 用途 | 协议 |
|------|------|------|
| 21303 | xclient主通信 | 自定义二进制 |
| 21308 | xclient HTTP服务 | HTTP |
| 53930 | Electron与xclient | TCP |

## 二、xclient.node 原生模块

### 1. 导出函数
```javascript
// 从xclient.node导出的三个核心函数
module.exports = {
    xinit,  // 初始化
    xsync,  // 同步执行
    xtask   // 异步任务
};
```

### 2. 函数签名
```javascript
// 初始化 - 传入环境密钥
xinit(key: string): void

// 同步执行 - 用于解码
xsync(type: number, data: ArrayBuffer): any

// 异步任务 - 用于API请求
xtask(excuteType: number, unknown: number, url: string, params: string | null, buffer?: ArrayBuffer): Promise<any>
```

### 3. 调用示例
```javascript
// 来自main/index.js
class XClientServer {
    init() {
        this.x = bindings(process.arch === "x64" ? "xclient" : "mclient");
        this.x.xinit(KEYS[_global.appEnv]);
    }
    
    // 发送请求
    request(a) {
        const { url, params, excuteType = 0 } = a;
        return this.x.xtask(excuteType, 0, url, params);
    }
    
    // 编码消息
    encode(a) {
        const { params } = a;
        const r = JSON.parse(params);
        const e = api.common.Message.create(r);
        const n = api.common.Message.encode(e).finish();
        const u = new Uint8Array(n).buffer;
        return this.x.xtask(1, 0, "encrypt", null, u);
    }
    
    // 解码消息
    decode(a) {
        const { params } = a;
        const r = JSON.parse(params);
        const e = Buffer.from(r, "utf-8");
        const n = new ArrayBuffer(e.length);
        const l = new Uint8Array(n);
        for (let p = 0; p < e.length; ++p) l[p] = e[p];
        return this.x.xsync(1, n);
    }
    
    // 内置命令
    buildIn() {
        return this.x.xtask(1, 0, "buildin", null, null);
    }
    
    // 广播
    broadcast(a) {
        const { params } = a;
        return this.x.xtask(1, 0, "broadcast", params, null);
    }
}
```

## 三、环境密钥 (KEYS)

从逆向分析中提取的环境密钥：

```javascript
const KEYS = {
    development: "AgAAAAAAAAB7w0xkTV3nnZ3HEzpDESHy...",
    staging: "AQAAAAAAAABVZpRGB3OJe9Dyoq00-TJOa2pd5S6a...",
    production: "AQAAAAAAAABVZpRGB3OJe9Dyoq00-TJOa2pd5S6a..."
};
```

**结构分析**：
- 格式：Base64URL编码
- 分段：3段，用`.`分隔
- 第1段：版本/类型标识 (头部值: 1 或 13)
- 第2段：认证数据
- 第3段：签名或额外数据

## 四、IPC 通信协议

### 1. 渲染进程 → 主进程
```javascript
// 发送请求
ipcRenderer.send("xclient", {
    type: "request",
    requestId: "unique-id",
    url: "/v1/group/get-group-list",
    excuteType: 0,  // 0=普通请求, 2=登录请求
    params: JSON.stringify({}),
    key: "request"
});
```

### 2. 消息类型
| type | 用途 | 参数 |
|------|------|------|
| request | API请求 | url, params, excuteType |
| encode | 消息编码 | params (JSON) |
| decode | 消息解码 | params (二进制数据) |
| buildIn | 内置命令 | 无 |
| broadcast | 广播消息 | params |

### 3. 响应格式
```javascript
// 主进程 → 渲染进程
{
    requestId: "unique-id",
    url: "/v1/group/get-group-list",
    code: 200,
    response: JSON.stringify({
        code: 0,
        data: { ... }
    })
}
```

## 五、Protobuf 消息

### 1. 消息类型 (200+)
从逆向分析中提取的主要类型：
- `api.common.Message` - 通用消息
- `api.common.MessageContent` - 消息内容
- `api.common.GroupMember` - 群成员
- `api.common.GroupNotification` - 群通知
- `api.common.BroadcastMessageContext` - 广播上下文

### 2. 编码流程
```javascript
// JavaScript → Protobuf → 二进制
const msg = api.common.Message.create(data);
const encoded = api.common.Message.encode(msg).finish();
const buffer = new Uint8Array(encoded).buffer;

// 通过xclient加密
const encrypted = await this.x.xtask(1, 0, "encrypt", null, buffer);
```

### 3. 解码流程
```javascript
// 二进制 → xclient解密 → Protobuf → JavaScript
const decrypted = this.x.xsync(1, binaryData);
const decoded = api.common.Message.decode(new Uint8Array(decrypted));
```

## 六、API 端点 (200+)

### 完整列表
详见 `WangShangLiaoApiService.cs` 中的 `ApiUrls` 类，包含：
- 群组管理 (50+)
- 好友管理 (20+)
- 用户设置 (30+)
- 消息相关 (10+)
- 朋友圈 (15+)
- RTC通话 (20+)
- 企业功能 (10+)

## 七、直连方案

### 方案一：模拟IPC (推荐)
```csharp
// 直接与旺商聊Electron进程通信
// 需要注入JS代码到渲染进程
```

### 方案二：加载xclient.node
```csharp
// 在C#中加载xclient.node
// 通过P/Invoke调用xinit/xtask/xsync
[DllImport("xclient.node")]
public static extern void xinit(string key);

[DllImport("xclient.node")]
public static extern IntPtr xtask(int excuteType, int unknown, string url, string params);
```

### 方案三：协议逆向
```csharp
// 完全逆向xclient的二进制协议
// 复杂度高，需要分析加密算法
```

## 八、当前限制

1. **端口21303不是HTTP**: 使用自定义二进制协议
2. **加密通信**: 消息经过xclient.node加密
3. **密钥依赖**: 需要正确的环境密钥
4. **Protobuf**: 消息使用Protobuf编码

## 九、建议

1. **优先方案**: 使用现有的CDP方案通过Electron注入JS
2. **替代方案**: 尝试加载xclient.node原生模块
3. **长期方案**: 完全逆向协议实现纯C#客户端

## 十、文件清单

| 文件 | 说明 |
|------|------|
| `XClientService.cs` | TCP直连服务 |
| `NimMessageService.cs` | NIM消息服务 |
| `WangShangLiaoApiService.cs` | API封装 |
| `DirectBotService.cs` | 集成服务 |
| `protocol_test.js` | Node.js协议测试 |
| `advanced_capture.ps1` | 高级抓包工具 |

---

*报告生成时间: 2026-01-10*
*分析工具: PowerShell, Node.js, 静态分析*
