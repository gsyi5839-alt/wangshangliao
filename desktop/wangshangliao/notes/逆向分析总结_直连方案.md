# 旺商聊直连方案 - 逆向分析总结

## 一、通信架构发现

### 1. 通信端口
```
端口21303 - xclient.exe主通信端口 (关键!)
端口21308 - xclient.exe监听端口
```

### 2. 进程关系
```
旺商聊Electron App (PID: 23492)
    ↓ TCP 127.0.0.1:53930 → 127.0.0.1:21303
xclient.exe (PID: 12760)
    ↓ 监听 0.0.0.0:21303, 0.0.0.0:21308
    ↓ 连接云信服务器
NIM云信服务器 (43.159.95.211:443等)
```

### 3. ZCG进程
```
zcg.exe (PID: 8268, 22008)
    ↓ 连接 43.153.236.237:80 (开奖API)
```

## 二、API端点清单 (200+)

### 核心群管理API
| 端点 | 功能 |
|------|------|
| `/v1/group/get-group-members` | 获取群成员 |
| `/v1/group/get-group-info` | 获取群信息 |
| `/v1/group/set-member-mute` | 禁言成员 |
| `/v1/group/member-mute-cancel` | 取消禁言 |
| `/v1/group/remove-group-member` | 移除成员 |
| `/v1/group/set-member-nickname` | 设置昵称 |
| `/v1/group/message-rollback` | 撤回消息 |
| `/v1/group/add-notice` | 添加公告 |
| `/v1/group/get-group-list` | 获取群列表 |
| `/v1/group/get-group-history-message` | 历史消息 |

### 好友管理API
| 端点 | 功能 |
|------|------|
| `/v1/friend/get-friend-list` | 好友列表 |
| `/v1/friend/friend-apply-handler` | 处理申请 |
| `/v1/friend/friend-apply-list` | 申请列表 |

### 用户设置API
| 端点 | 功能 |
|------|------|
| `/v1/settings/set-auto-reply` | 自动回复 |
| `/v1/settings/get-sensitive-words` | 敏感词 |
| `/v1/user/login` | 登录 |

## 三、消息协议

### 1. 消息格式 (JSON)
```json
{
    "type": "sendText",
    "requestId": "唯一ID",
    "data": {
        "scene": "team",  // team=群, p2p=私聊
        "to": "目标ID",
        "text": "消息内容"
    },
    "timestamp": 1736505600000
}
```

### 2. Protobuf消息类型
从逆向分析中提取的200+消息类型:
- `api.common.Message` - 通用消息
- `api.common.GroupMember` - 群成员
- `api.common.MessageContent` - 消息内容
- `api.common.GroupNotification` - 群通知
- `api.common.BroadcastMessageContext` - 广播

## 四、已创建的服务

### 1. XClientService.cs
- TCP直连xclient.exe
- JSON消息收发
- 自动重连机制

### 2. NimMessageService.cs  
- NIM消息封装
- 频率限制 (5条/秒)
- 消息去重

### 3. WangShangLiaoApiService.cs
- 200+ API封装
- 群管理/好友管理
- 用户设置

### 4. DirectBotService.cs
- 集成服务
- 消息分发
- 群管理快捷方法

## 五、使用方法

```csharp
// 启动直连机器人
var bot = DirectBotService.Instance;
bot.OnMessageReceived += HandleMessage;
await bot.StartAsync("群ID");

// 发送消息
await bot.SendGroupMessageAsync("Hello!");

// 群管理
await bot.MuteMemberAsync("用户ID", 10);
await bot.KickMemberAsync("用户ID");
```

## 六、与CDP方案对比

| 特性 | CDP方案 | 直连方案 |
|------|---------|----------|
| 延迟 | 50-100ms | 10-30ms |
| 稳定性 | 一般 | 更好 |
| 实现 | 复杂 | 中等 |
| 依赖 | Chrome | xclient |

## 七、文件清单

```
Services/DirectConnection/
├── XClientService.cs          # xclient通信
├── NimMessageService.cs       # NIM消息
├── WangShangLiaoApiService.cs # API封装
└── DirectBotService.cs        # 集成服务

capture_traffic.ps1            # 抓包脚本
DIRECT_CONNECTION_GUIDE.md     # 使用指南
```

## 八、后续优化

1. [ ] 实现Protobuf编解码
2. [ ] 添加消息加密支持
3. [ ] 实现离线消息同步
4. [ ] 添加消息确认机制
5. [ ] 优化重连策略
