# 机器人与程序优化文档

## 一、监控目标

- **群名称**: 天谕2.8(24h)
- **群号**: 333338888
- **内部TeamId**: 21654357327
- **监控账号**: nim-1948408648

---

## 二、机器人技术分析

### 2.1 识别的机器人账号

| 账号ID | 昵称特征 | 类型 |
|--------|----------|------|
| 1930674496 | 77ffe8c0494b2008f883b82deab68463 | 主机器人 |
| 1925123443 | f63026e00eae3f9c07005b2256801463 | 副机器人 |

**昵称特征**: 使用32位MD5哈希作为昵称，用于标识机器人账号

### 2.2 消息协议特征

```
消息类型: custom (非text)
编码方式: Base64 (URL-safe variant)
存储字段: content.b
协议头: "X!I" 前缀
内部格式: Protobuf 二进制协议
```

### 2.3 已解码的消息内容

#### 进群欢迎消息
```
天谕机器进群请+客服 7016123655878237403
```

#### 封盘/开盘通知
```
{mMuteAllMember:true}  管理员开启了禁言
{mMuteAllMember:false} 管理员关闭了禁言
```

### 2.4 运行周期

- 封盘/开盘周期约 **3分钟**
- 自动循环执行
- 深夜仍在运行

---

## 三、我方程序优化内容

### 3.1 新增文件

| 文件路径 | 功能说明 |
|----------|----------|
| `Utils/MessageDecoder.cs` | Base64解码、机器人识别、消息特征分析 |

### 3.2 升级的文件

| 文件路径 | 优化内容 |
|----------|----------|
| `Services/ChatService.cs` | 1. 消息钩子增加content字段捕获<br>2. 新增IndexedDB直读功能<br>3. custom消息自动解码 |
| `Models/ChatMessage.cs` | 新增IsBot、Tags、RawContent字段<br>新增MessageType.Custom枚举 |
| `Services/RunLogService.cs` | 机器人消息标记(🤖)、特征标签显示 |
| `Models/RunLogEntry.cs` | 新增IsBot、Tags字段 |

### 3.3 新增API

```csharp
// IndexedDB直读消息（最可靠的方式）
await ChatService.Instance.StartIndexedDbPollingAsync(targetTeamId: "21654357327");

// 消息解码工具
MessageDecoder.DecodeBase64Content(base64String);
MessageDecoder.IsBotNickname(nickname);
MessageDecoder.AnalyzeMessage(content, nickname, type);
```

---

## 四、待测试内容（白天进行）

### 4.1 需要获取的自动回复内容

- [ ] 玩法说明（大小单双、龙虎、豹子等）
- [ ] 开奖结果格式（如: 1+2+3=6 大单）
- [ ] 下注回复（成功/失败提示）
- [ ] 查账回复（余额、流水）
- [ ] 结算通知（中奖/未中）

### 4.2 测试命令

```powershell
# 启动监控脚本
cd C:\EasyHook-1
pwsh -ExecutionPolicy Bypass -File monitor_ultimate.ps1
```

### 4.3 测试时间建议

- **最佳时段**: 上午10:00 - 晚上22:00
- **原因**: 玩家活跃，有下注和自动回复交互

---

## 五、监控脚本列表

| 脚本名称 | 功能说明 |
|----------|----------|
| `monitor_group_chat.ps1` | 基础群聊监控 |
| `monitor_group_v2.ps1` | 增强版监控（含解码） |
| `monitor_indexeddb.ps1` | IndexedDB直读 |
| `monitor_ultimate.ps1` | 终极版（完整解码+机器人识别） |
| `explore_group_data.ps1` | 探索群组数据结构 |

---

## 六、技术总结

### 竞品优势
1. 使用自定义消息格式，普通工具无法解析
2. MD5哈希昵称，难以人工识别
3. Protobuf协议，数据紧凑高效

### 我方优化后能力
1. ✅ 支持custom消息解码
2. ✅ 自动识别机器人账号
3. ✅ IndexedDB直读（绕过UI层）
4. ✅ 消息特征标签化
5. ⏳ 完整玩法内容（待白天测试）

---

## 七、下一步计划

1. 白天测试获取完整的自动回复模板
2. 根据获取的模板完善 `TemplateEngine.cs`
3. 优化 `RunLogService` 显示格式
4. 测试我方机器人发送消息功能

---

*文档创建时间: 2024年12月28日*
*最后更新: 深夜监控测试完成*

