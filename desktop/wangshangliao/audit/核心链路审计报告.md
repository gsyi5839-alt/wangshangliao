## 核心链路审计报告（桌面端）

本文聚焦“框架服务/客户端通信/消息结构/定时任务/下注结算”等核心链路，目标是把系统从启动到收发消息、到封盘倒计时、到开奖结算的主流程一次性串清楚。

---

## 1. 总体架构（两进程）

- **副框架：`WSLFramework`（`旺商聊框架.exe`）**
  - 对外：监听本地 **HPSocket PACK** 端口（默认 **14746**）给主框架连接。
  - 对内：负责连接旺商聊（当前主路径为 **账号密码登录 + NIM SDK**；CDP 作为兼容/备用；另有“事件驱动 TCP 长连接”实验架构）。
  - 负责：接收群/私聊消息、转发给主框架；并在“开始算账”后驱动倒计时/封盘提醒/核对/卡奖提示等定时广播。

- **主框架：`WangShangLiaoBot`（`旺商聊机器人.exe`）**
  - 连接副框架（HPSocket PACK）。
  - 业务：自动回复、下注解析、账本落地、开奖拉取、结算、UI 展示与操作。

启动脚本会优先启动副框架，再启动主框架（根目录 `startup.cmd`/`run.cmd`）。

---

## 2. 框架间通信（主框架 ↔ 副框架）

### 2.1 通信协议与消息类型

- 副框架侧：`src/WSLFramework/Models/FrameworkMessage.cs`
  - `FrameworkMessageType` 包含 Login/Heartbeat/ApiRequest/SendGroupMessage/ReceiveGroupMessage/StartAccounting/StopAccounting/SyncConfig*/LotteryResult/SealingNotify/PeriodUpdate 等。
  - 还定义 `ZCGMessageQueue`（“消息队列:...★...”）解析与序列化，用于兼容 ZCG 风格消息投递。

- 主框架侧：`src/WangShangLiaoBot/Services/HPSocket/FrameworkClient.cs`
  - 定义了自身的 `FrameworkMessageType` 与 `FrameworkMessage`（JSON 序列化）用于与副框架对话。
  - 事件：`OnMessageReceived`（所有框架消息）、`OnGroupMessageReceived`（收到群消息时触发）。

### 2.2 收到数据后的分流（副框架）

副框架 HPSocket `OnReceive` 入口在 `src/WSLFramework/Services/FrameworkServer.cs`：
- 先 `UTF-8` 解码；
- 按优先级尝试识别：
  1) JSON → `FrameworkMessage.FromJson(...)` 成功则按 `FrameworkMessageType` 走 `ProcessFrameworkMessageAsync(...)`
  2) ZCG 插件投递格式（含“机器人账号=”/“主动账号=”等）→ `ProcessPluginMessageAsync(...)`
  3) ZCG API 格式（包含 `|`）→ `ProcessZCGApiMessageAsync(...)`
  4) 消息队列（`消息队列:` 或包含 `★`）→ `ProcessMessageQueue(...)`
  5) 其余视为未知格式（记录日志）

### 2.3 主框架如何接收副框架消息

主框架 `FrameworkClient` 在 `Client_OnReceive`：
- `UTF-8` → `FrameworkMessage.FromJson` → `OnMessageReceived(message)` → `ProcessMessage(message)`
- 群消息会通过 `OnGroupMessageReceived` 继续对外广播。

主界面 `MainForm` 会订阅并将群消息转成 `ChatMessage`，触发 `ChatService.TriggerMessageReceived(...)`，从而让自动回复/下注处理等业务模块统一走同一条消息入口。

---

## 3. 旺商聊消息来源（副框架：BotLoginService / NIM）

副框架初始化链路在 `src/WSLFramework/Services/FrameworkServer.cs`：
- `InitializeBotLoginService()`：账号密码登录旺商聊（替代 CDP），登录成功后绑定群号，并把群/私聊消息回调转发到：
  - `HandleGroupMessage(groupId, fromId, content)` → `OnWangShangLiaoMessage` + `BroadcastGroupMessage(...)`
  - `HandlePrivateMessage(fromId, toId, content)` → `BroadcastPrivateMessage(...)`
- NIM 发送优先：在 `SendGroupMessageViaCDPAsync` 内有发送优先级（代码注释）：`NimDirectClient > NIM SDK > CDP`，并且 `_useNIMForSending` 默认启用。

---

## 4. “开始算账”后的定时/封盘链路（副框架）

### 4.1 StartAccounting 触发点

副框架在 `FrameworkServer.HandleStartAccountingAsync(...)`（由主框架发 `FrameworkMessageType.StartAccounting`）完成：
- 设置 `_activeGroupId`；
- `TimedMessageService.Instance.AddActiveGroup(groupId)`：把群加入活跃列表；
- `PeriodManager.Start()`：启动 210 秒周期逻辑；
- 启用 `TimedMessageService` 的倒计时/封盘/开奖通知开关；
- 如 NIM 直连已登录：`nimDirect.SetActiveGroup(groupId)`。

### 4.2 周期与消息顺序（完全匹配旧软件）

周期逻辑：`src/WSLFramework/Services/PeriodManager.cs`
- 周期：210 秒（3分30秒）
- 封盘阈值：30 秒（`CLOSE_BET_SECONDS=30`）
- 严格消息顺序（代码内注释）：
  1. 40 秒提醒（含改注提示）
  2. 20 秒提醒
  3. 封盘线（倒计时到 30 秒触发封盘线 + 禁言请求）
  4. 封盘后 10 秒：核对
  5. 封盘后 20 秒：卡奖提示

### 4.3 定时消息发送服务

`src/WSLFramework/Services/TimedMessageService.cs`
- 初始化时订阅 `PeriodManager` 的事件（OnWarning40/OnWarning20/OnBetClose/OnCheckNotify/OnStuckNotify/OnMuteRequest）。
- 发送对象：所有“活跃群”（`_activeGroups`）。
- 发送动作：通过 NIM（优先）或 CDP（备用）把消息发到群里；禁言/解禁通过 `GroupManagementService`。

---

## 5. 主框架业务链路：下注 → 账本 → 开奖 → 结算

### 5.1 消息入口统一化

`src/WangShangLiaoBot/Forms/MainForm.cs` 会把副框架转发来的群消息转换成 `ChatMessage` 并调用：
- `ChatService.Instance.TriggerMessageReceived(chatMessage)`

这意味着下注、自动回复、风控等都只需要订阅 `ChatService.OnMessageReceived` 即可统一处理。

### 5.2 下注账本（BetLedger）

`src/WangShangLiaoBot/Services/Betting/BetLedgerService.cs`
- 启动后订阅：`ChatService.Instance.OnMessageReceived += HandleMessage`
- 过滤：非自己、文本消息、群聊/私聊开关、OnlyMemberBet（私聊下注要求发送者是群成员）等
- 解析：`BetMessageParser.TryParse(...)` 成功后生成 `BetRecord`
- 期号归属：默认使用 `LotteryService.Instance.NextPeriod`（若为空回落 `CurrentPeriod`）
- 重复下注：`RepeatBetMode` 支持 0/1/2/3（其中 **2=算最后一次下注** 会先清理同玩家同期期下注）
- 落盘：`AppendBetRecord(record)` 写入每日账本（具体文件格式由 `DataService` 决定）

### 5.3 下注解析器（BetMessageParser）

`src/WangShangLiaoBot/Services/Betting/BetMessageParser.cs`
- 支持多格式下注：
  - 英文缩写：`XD/XS/DD/DS/D/X/S/DZ/SZ/BZ/JD/JX/BS/HE/Z/...`
  - 中文关键字：大单/对子/顺子/豹子/极大/极小/尾大/边 等
  - ZCG 拼音简写：`da100/x50/dad100/.../long50/hu50` 等
  - 数字下注：`13 100` / `13/100` / `100点13` / `操13/100` 等
- 输出：结构化 `BetItem[]` + 合计金额 + 标准化文本（用于重复判断、回执显示）

### 5.4 开奖来源（LotteryService）

`src/WangShangLiaoBot/Services/LotteryService.cs`
- 定时拉取开奖 API（默认模板 `bcapi.cn`），并实现限频（官方 30 秒 <= 40 次、单次 >= 1 秒）。
- 事件：
  - `OnResultUpdated(LotteryResult)`：开奖更新
  - `OnCountdownUpdated(int)`：倒计时更新
- `MainForm` 会订阅并根据配置选择是否群内播报开奖结果。

### 5.5 结算（BetSettlementService 为主，AutoSettlementService 疑似旧实现）

当前更“融入主框架链路”的结算实现是：
- `src/WangShangLiaoBot/Services/Betting/BetSettlementService.cs`
  - 订阅 `LotteryService.Instance.OnResultUpdated`
  - 读取账本：`BetLedgerService.Instance.ReadBets(day, teamId:null, period)`
  - 对每个群（teamId）分组结算，避免多群混账
  - 对每个玩家汇总 stake/profit，更新 `player.Score` 并持久化
  - 写结算输出（供模板 token 使用），并触发 `OnSettlementComplete(period, playerCount, totalProfit)`

另有 `src/WangShangLiaoBot/Services/Betting/AutoSettlementService.cs`
- 内存维护 `_periodBets`，并在 `ProcessLotteryResultAsync` 内部结算、生成账单、发消息。
- 从当前观察的“事件订阅链路”看，它更像历史/备用实现（是否仍被 UI/服务引用，需要后续对全项目引用关系做一次完整交叉验证）。

### 5.6 赔率配置

两套：
- `OddsConfigService`：简版 `odds-classic.ini`（DxdsOdds 等少量字段）
- `OddsService`：完整版 `odds-full.ini`（全玩法赔率、限额、极值区间、数字赔率表等）

---

## 6. 已确认的潜在风险点（不改代码，仅记录）

1) **配置文件“同名不同格式”风险（副框架）**  
`WSLFramework.Services.ConfigService` 读取的是 GBK 分节 ini；但 `WSLFramework.Forms.LoginDialog` 会以 UTF8 写入 `Account=...` 形式的 `config.ini`。当前 UI 已改用 `AddAccountForm`，但一旦 `LoginDialog` 被再次启用，可能覆盖并破坏配置。

2) **端口语义易混淆（14745 vs 14746）**  
14745 更多出现在 “xplugin 深度连接/本地 TCP 协议”链路；14746 用于主框架↔副框架 HPSocket PACK。两者并非同一端口。

