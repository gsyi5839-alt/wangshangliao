@echo off
chcp 65001 >nul
title 旺商聊机器人 - 启动器 v2.0
color 0A

echo.
echo  ╔═══════════════════════════════════════════════════════════════════╗
echo  ║                                                                   ║
echo  ║     ██╗    ██╗███████╗██╗         ██████╗  ██████╗ ████████╗      ║
echo  ║     ██║    ██║██╔════╝██║         ██╔══██╗██╔═══██╗╚══██╔══╝      ║
echo  ║     ██║ █╗ ██║███████╗██║         ██████╔╝██║   ██║   ██║         ║
echo  ║     ██║███╗██║╚════██║██║         ██╔══██╗██║   ██║   ██║         ║
echo  ║     ╚███╔███╔╝███████║███████╗    ██████╔╝╚██████╔╝   ██║         ║
echo  ║      ╚══╝╚══╝ ╚══════╝╚══════╝    ╚═════╝  ╚═════╝    ╚═╝         ║
echo  ║                                                                   ║
echo  ║                    旺商聊机器人 启动器 v2.0                       ║
echo  ║                      参考 ZCG 架构设计                            ║
echo  ║                                                                   ║
echo  ╚═══════════════════════════════════════════════════════════════════╝
echo.

:: 检查管理员权限
net session >nul 2>&1
if %errorlevel% neq 0 (
    echo  [!] 提示: 建议以管理员身份运行以获得最佳体验
    echo.
)

:: 设置工作目录
cd /d "%~dp0"

:: 读取端口配置
set PORT=14746
if exist "wsl端口.ini" (
    for /f "tokens=2 delims==" %%a in ('findstr /i "端口=" "wsl端口.ini"') do set PORT=%%a
)

:: ============================================================
:: 步骤1: 清理旧进程
:: ============================================================
echo  [1/5] 清理旧进程...
taskkill /F /IM "旺商聊框架.exe" >nul 2>&1
taskkill /F /IM "旺商聊机器人.exe" >nul 2>&1
timeout /t 1 /nobreak >nul
echo        √ 完成
echo.

:: ============================================================
:: 步骤2: 检查文件完整性
:: ============================================================
echo  [2/5] 检查文件完整性...

set FRAMEWORK_PATH=src\WSLFramework\bin\Release\旺商聊框架.exe
set BOT_PATH=src\WangShangLiaoBot\bin\Release\旺商聊机器人.exe

if not exist "%FRAMEWORK_PATH%" (
    echo        × 错误: 找不到副框架 (旺商聊框架.exe)
    echo        请先运行 build.cmd 编译项目
    echo.
    pause
    exit /b 1
)

if not exist "%BOT_PATH%" (
    echo        × 错误: 找不到主框架 (旺商聊机器人.exe)
    echo        请先运行 build.cmd 编译项目
    echo.
    pause
    exit /b 1
)

echo        √ 文件检查通过
echo.

:: ============================================================
:: 步骤3: 启动副框架 (连接旺商聊服务)
:: ============================================================
echo  [3/5] 启动副框架 (连接旺商聊)...
cd /d "%~dp0src\WSLFramework\bin\Release"
start "" "旺商聊框架.exe"
echo        √ 副框架已启动 (监听端口: %PORT%)

:: 等待副框架初始化
echo        等待初始化 (3秒)...
timeout /t 3 /nobreak >nul

:: 检查副框架是否启动成功
tasklist | findstr /I "旺商聊框架.exe" >nul
if %errorlevel% neq 0 (
    echo        × 警告: 副框架可能启动失败
) else (
    echo        √ 副框架运行中
)
echo.

:: ============================================================
:: 步骤4: 启动主框架 (UI界面)
:: ============================================================
echo  [4/5] 启动主框架 (UI界面)...
cd /d "%~dp0src\WangShangLiaoBot\bin\Release"
start "" "旺商聊机器人.exe"
echo        √ 主框架已启动

:: 等待主框架初始化
timeout /t 2 /nobreak >nul

:: 检查主框架是否启动成功
tasklist | findstr /I "旺商聊机器人.exe" >nul
if %errorlevel% neq 0 (
    echo        × 警告: 主框架可能启动失败
) else (
    echo        √ 主框架运行中
)
echo.

:: ============================================================
:: 步骤5: 完成
:: ============================================================
echo  [5/5] 启动完成!
echo.
echo  ╔═══════════════════════════════════════════════════════════════════╗
echo  ║                         启动完成!                                 ║
echo  ╠═══════════════════════════════════════════════════════════════════╣
echo  ║                                                                   ║
echo  ║   架构说明:                                                       ║
echo  ║   ┌─────────────────────────────────────────────────────────────┐ ║
echo  ║   │ 副框架 (旺商聊框架.exe)                                      │ ║
echo  ║   │   - 连接旺商聊，收发消息                                     │ ║
echo  ║   │   - 监听端口: %PORT%                                          │ ║
echo  ║   │                                                             │ ║
echo  ║   │ 主框架 (旺商聊机器人.exe)                                    │ ║
echo  ║   │   - 只连接副框架，不直接连接旺商聊                          │ ║
echo  ║   │   - 用户界面，业务逻辑                                       │ ║
echo  ║   └─────────────────────────────────────────────────────────────┘ ║
echo  ║                                                                   ║
echo  ╠═══════════════════════════════════════════════════════════════════╣
echo  ║   使用说明:                                                       ║
echo  ║   1. 确保旺商聊已启动并登录                                       ║
echo  ║   2. 副框架自动连接旺商聊                                         ║
echo  ║   3. 主框架自动连接副框架                                         ║
echo  ║   4. 在主框架中点击"开始算账"接管群聊                             ║
echo  ╠═══════════════════════════════════════════════════════════════════╣
echo  ║   快捷命令:                                                       ║
echo  ║   run.cmd     - 静默启动 (无窗口)                                 ║
echo  ║   stop.cmd    - 停止所有服务                                      ║
echo  ║   restart.cmd - 重启服务                                          ║
echo  ║   status.cmd  - 查看运行状态                                      ║
echo  ║   build.cmd   - 重新编译                                          ║
echo  ╚═══════════════════════════════════════════════════════════════════╝
echo.

cd /d "%~dp0"
echo  按任意键关闭此窗口...
pause >nul
