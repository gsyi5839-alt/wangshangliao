# 旺商聊握手协议深度分析报告

## 一、网络架构发现

### 1. 实际通信架构
`
┌──────────────────────────────────────────────────────────────────────┐
│                        旺商聊客户端架构                               │
├──────────────────────────────────────────────────────────────────────┤
│  Electron渲染进程                                                    │
│  └── Vue 3 前端 + NIM SDK                                           │
│          ↓ IPC                                                       │
│  Electron主进程                                                      │
│  ├── xclient.node (N-API模块)                                       │
│  └── XClientServer (管理xclient.exe)                                │
│          ↓ TCP (127.0.0.1:21303)                                    │
│  xclient.exe                                                         │
│  ├── 监听 21303 (JSON-RPC服务)                                      │
│  ├── 监听 21308 (HTTP服务)                                          │
│  └── 出站连接:                                                       │
│      ├── 120.233.185.185:443 (HTTPS API服务器)                      │
│      └── 代理 (127.0.0.1:7897)                                       │
│              ↓                                                       │
│      120.236.198.109:47437 (长连接服务器)                           │
└──────────────────────────────────────────────────────────────────────┘
`

### 2. 服务器角色
| 服务器 | 端口 | 协议 | 用途 |
|--------|------|------|------|
| 120.233.185.185 | 443 | HTTPS | API服务器 (认证/配置) |
| 120.236.198.109 | 47437 | TCP (自定义) | 长连接服务器 (消息推送) |

### 3. 本地端口
| 端口 | 监听进程 | 协议 | 用途 |
|------|----------|------|------|
| 21303 | xclient.exe | JSON-RPC over TCP | 与Electron主进程通信 |
| 21308 | xclient.exe | HTTP | 健康检查/内部API |

## 二、握手协议分析

### 1. 端口21303协议 (xclient ↔ Electron)
`
请求格式:
  长度前缀(4字节, 大端序) + JSON内容

JSON结构:
{
    "type": "request",       // 请求类型
    "seq": 1,                // 序列号
    "url": "/v1/xxx",        // API路径
    "params": {}             // 参数
}

响应格式:
{
    "type": "response",
    "seq": 1,
    "code": 200,
    "data": {}
}
`

### 2. 端口47437协议 (xclient ↔ 长连接服务器)
`
连接特点:
  - 通过代理建立 (系统代理或Clash)
  - 非标准TLS (TLS ClientHello无响应)
  - 服务器等待客户端先发送
  - 可能使用自定义加密

推测的协议格式:
  [Header(8-16字节)] + [Encrypted Payload]

Header可能包含:
  - Magic Number (4字节)
  - Version (2字节)
  - Flags (2字节)
  - Payload Length (4字节)
  - Sequence ID (4字节)
`

### 3. HTTPS API服务器 (120.233.185.185:443)
`
用途: 认证、获取配置、初始化
协议: 标准HTTPS
可能的端点:
  - /v1/user/login
  - /v1/settings/get-system-setting
  - /v1/group/get-group-list
`

## 三、关键发现

1. **双服务器架构**: xclient使用两个服务器
   - API服务器: 120.233.185.185:443 (HTTPS)
   - 推送服务器: 120.236.198.109:47437 (自定义协议)

2. **代理透明**: 流量通过系统代理/Clash转发

3. **非标准协议**: 47437端口不使用标准TLS

4. **xclient.node是核心**: 所有加密/编码在xclient.node中实现

## 四、完全逆向所需工作

### 已完成
- [x] 识别服务器地址和端口
- [x] 分析本地端口21303/21308协议
- [x] 实现AES-256-GCM加密 (WslCrypto.cs)
- [x] 实现Protobuf编解码 (WslProtobuf.cs)

### 待完成
- [ ] 抓取47437端口的实际数据包
- [ ] 逆向xclient.node的握手序列
- [ ] 分析自定义协议的加密层
- [ ] 实现纯C#长连接客户端

## 五、建议方案

### 方案A: 中间人抓包 (推荐)
1. 使用mitmproxy或Fiddler拦截HTTPS流量
2. 分析API调用流程
3. 复制请求到C#客户端

### 方案B: Hook xclient.node
1. 使用Frida hook Node.js native模块
2. 拦截xinit/xtask/xsync调用
3. 记录加密前后的数据

### 方案C: 完全逆向xclient.exe
1. 使用IDA Pro分析xclient.exe
2. 逆向网络通信函数
3. 提取协议格式和加密算法

---
*报告生成时间: 2026-01-11 09:17:05*
