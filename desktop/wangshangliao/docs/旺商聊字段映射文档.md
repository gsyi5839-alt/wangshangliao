# 旺商聊字段映射文档

## 概述

本文档记录旺商聊（WangShangLiao）客户端与主框架之间的字段映射关系，特别是在进行群管理操作（踢人、禁言、撤回等）时需要使用的正确字段。

## 核心字段映射

### 1. 用户信息字段 (userInfo)

| 旺商聊字段 | 主框架字段 | 示例值 | 用途 |
|-----------|-----------|--------|------|
| `uid` / `wwid` | `playerId` | 14996839 | 玩家唯一标识（显示用） |
| `nimId` | `nimAccountId` | 1391351554 | NIM账号（**踢人/禁言必须使用**） |
| `nickName` | `playerNick` | logo | 玩家昵称 |
| `accountId` | `loginAccount` | 82840376 | 登录账号 |
| `phone` | `phone` | 15812656092 | 手机号 |
| `avatar` | `avatar` | 9216881327107750058 | 头像ID |
| `level` | `vipLevel` | VL_VIP_0 | VIP等级 |
| `accountState` | `accountState` | ACCOUNT_STATE_GOOD | 账号状态 |

### 2. 群信息字段 (groupList)

| 旺商聊字段 | 主框架字段 | 示例值 | 用途 |
|-----------|-----------|--------|------|
| `groupAccount` | `groupId` | 3962369093 | 群号（**用户看到的**） |
| `groupId` | `teamId` / `internalId` | 1176721 | 群内部ID（**NIM操作必须使用**） |
| `groupCloudId` | `nimTeamId` | 40821608989 | 云端群ID |
| `groupName` | `groupName` | 测试交流群 | 群名称 |
| `groupMemberNum` | `memberCount` | 665 | 成员数量 |
| `me.role` | `myRole` | GROUP_ROLE_ADMIN | 我的角色 |
| `me.selfNickName` | `myNickName` | 知鬼 | 我的群昵称 |

### 3. 群成员字段 (groupMembersMap)

| 旺商聊字段 | 主框架字段 | 示例值 | 用途 |
|-----------|-----------|--------|------|
| `userId` | `playerId` | 9903485 | 成员UID |
| `nimId` | `nimAccountId` | 1948408648 | **NIM账号（踢人/禁言用）** |
| `userNick` | `playerNick` | 法拉利 | 用户昵称 |
| `groupMemberNick` | `groupNick` | 法拉 | 群内昵称 |
| `groupRole` | `role` | GROUP_ROLE_OWNER | 群角色 |
| `accountId` | - | 0 | 登录账号（通常为0，不可靠） |

### 4. 好友字段 (friendList)

| 旺商聊字段 | 主框架字段 | 示例值 | 用途 |
|-----------|-----------|--------|------|
| `uid` | `playerId` | 9903485 | 好友UID |
| `nimId` | `nimAccountId` | 1948408648 | NIM账号 |
| `nickName` | `playerNick` | 法拉利 | 好友昵称 |
| `markName` | `remarkName` | 法拉利 | 备注名 |
| `onlineState` | `onlineState` | ONLINE_STATE_ONLINE | 在线状态 |

## 群管理操作

### 踢人操作

**关键点**：踢人必须使用 `nimId`，而不是 `userId` 或 `accountId`！

```javascript
// 正确方式
window.nim.removeTeamMembers({
    teamId: '1176721',        // 群内部ID，不是群号 3962369093
    accounts: ['1948408648'], // nimId，不是 userId 9903485
    done: function(err) { ... }
});
```

### 禁言操作

```javascript
// 正确方式
window.nim.updateMuteStateInTeam({
    teamId: '1176721',        // 群内部ID
    account: '1948408648',    // nimId
    mute: true,
    duration: 600,            // 禁言时长（秒）
    done: function(err) { ... }
});
```

### 撤回消息

```javascript
// 正确方式
window.nim.deleteMsg({
    msg: {
        idClient: 'xxx',      // 消息客户端ID
        to: '1176721',        // 群内部ID
        scene: 'team'
    },
    done: function(err) { ... }
});
```

## 服务类

### CDPService (WSLFramework)

位置：`WSLFramework/Services/CDPService.cs`

提供以下方法：
- `GetCurrentUserAsync()` - 获取当前登录用户
- `GetGroupListAsync()` - 获取群列表
- `GetGroupMembersAsync(groupInternalId)` - 获取群成员
- `KickMemberAsync(teamInternalId, nimAccountId)` - 踢出成员
- `MuteMemberAsync(teamInternalId, nimAccountId, duration)` - 禁言成员
- `RecallMessageAsync(teamInternalId, idClient)` - 撤回消息

### WslFieldMapper (WSLFramework)

位置：`WSLFramework/Services/WslFieldMapper.cs`

提供 ID 转换和缓存功能：
- `GetNimIdByUidAsync(uid, teamInternalId)` - UID → NimId
- `GetUidByNimIdAsync(nimId, teamInternalId)` - NimId → UID
- `GetMemberInfoAsync(uid, teamInternalId)` - 获取成员详情
- `PreloadGroupMembersAsync(teamInternalId)` - 预加载群成员

## 角色枚举

```
GROUP_ROLE_OWNER  - 群主
GROUP_ROLE_ADMIN  - 管理员
GROUP_ROLE_MEMBER - 普通成员
```

## 在线状态枚举

```
ONLINE_STATE_ONLINE  - 在线
ONLINE_STATE_OFFLINE - 离线
ONLINE_STATE_BUSY    - 忙碌
```

## 注意事项

1. **踢人/禁言操作必须使用 nimId**，不能使用 userId 或 accountId
2. **群操作必须使用 groupId (内部ID)**，不能使用 groupAccount (群号)
3. 群成员的 accountId 字段通常为 0，不可靠
4. 建议在启动时预加载群成员以获取 nimId 映射

## 测试脚本

测试脚本位于：`c:\wangshangliao\test_cdp_*.js`

- `test_cdp_fields.js` - 完整字段分析
- `test_cdp_quick.js` - 快速群成员测试
- `test_cdp_group_management.js` - 群管理功能测试

运行方式：
```bash
cd c:\wangshangliao
node test_cdp_quick.js
```
