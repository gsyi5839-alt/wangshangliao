# 旺商聊逆向分析文档

## 概述

旺商聊是一款基于 **Electron** 框架开发的即时通讯应用，底层使用**网易云信 NIM SDK** 实现消息收发功能。本文档记录了通过逆向分析获取的API接口、加密解密逻辑和功能实现细节。

---

## 目录

1. [应用架构](#应用架构)
2. [调试方法](#调试方法)
3. [昵称加密解密](#昵称加密解密)
4. [NIM SDK API](#nim-sdk-api)
5. [数据存储](#数据存储)
6. [源代码分析方法](#源代码分析方法)

---

## 应用架构

### 技术栈

| 组件 | 技术 |
|------|------|
| 框架 | Electron |
| 前端 | Vue 3 + Pinia |
| UI库 | Element Plus |
| 聊天SDK | 网易云信 NIM SDK |
| 打包工具 | Vite |

### 安装路径

```
C:\Program Files (x86)\wangshangliao_win_online\
├── wangshangliao_win_online.exe    # 主程序
└── resources\
    └── app\
        └── dist\
            ├── index.html          # 入口页面
            └── assets\
                ├── index-*.js      # 主JS文件 (~4MB)
                └── zh-cn-*.js      # 中文语言包+业务逻辑
```

### 主要JS文件

| 文件 | 大小 | 内容 |
|------|------|------|
| `index-c221f02a.js` | ~4.13 MB | 主应用逻辑、Vue组件、56个NIM方法 |
| `zh-cn-acff1ed5.js` | ~3.68 MB | CryptoJS、AES加解密、Pinia Stores |
| `rtcClient-*.js` | ~1.2 MB | 音视频通话RTC功能 |

---

## 调试方法

### 1. 启用Chrome DevTools Protocol (CDP)

```powershell
# 关闭现有进程
taskkill /F /IM wangshangliao_win_online.exe

# 启用远程调试端口
& "C:\Program Files (x86)\wangshangliao_win_online\wangshangliao_win_online.exe" --remote-debugging-port=9222
```

### 2. 获取WebSocket调试URL

```javascript
// 获取CDP目标列表
http://127.0.0.1:9222/json

// 返回示例
[{
    "type": "page",
    "url": "file:///.../index.html#/home/chat/messagesPanel?sessionId=team-40821608989",
    "webSocketDebuggerUrl": "ws://127.0.0.1:9222/devtools/page/..."
}]
```

### 3. 通过CDP执行JavaScript

```javascript
// Node.js 示例
const WebSocket = require('ws');

const ws = new WebSocket(webSocketDebuggerUrl);

// 执行脚本
ws.send(JSON.stringify({
    id: 1,
    method: 'Runtime.evaluate',
    params: {
        expression: 'window.nim.getTeams()',
        returnByValue: true,
        awaitPromise: true
    }
}));
```

---

## 昵称加密解密

### ✅ 已验证的加密配置

旺商聊使用 **AES-256-CBC** 加密用户昵称。

| 参数 | 值 | 说明 |
|------|-----|------|
| **算法** | AES-256-CBC | 256位密钥长度 |
| **密钥** | `d6ba6647b7c43b79d0e42ceb2790e342` | UTF-8编码，32字节 |
| **IV** | `kgWRyiiODMjSCh0m` | UTF-8编码，16字节 |
| **填充** | PKCS7 | 标准填充 |

### 解密验证结果

| 密文 | 解密结果 |
|------|----------|
| `HLF4vIVpTTX9OuKnY1gW6g==` | 挪仇 |
| 群主昵称密文 | 法拉利客服 |

**测试结果**：成功解密 186 名群成员中的 64 人昵称！

### 源代码位置

文件：`zh-cn-acff1ed5.js` (位置: 3458867)

```javascript
// 密钥配置
const key = CryptoJS.enc.Utf8.parse("d6ba6647b7c43b79d0e42ceb2790e342");
const iv = CryptoJS.enc.Utf8.parse("kgWRyiiODMjSCh0m");

// AES对象定义
AES = {
    encrypt: function(g) {
        return CryptoJS.AES.encrypt(g, key, {
            iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        }).toString()
    },
    decrypt: function(g) {
        return CryptoJS.AES.decrypt(g, key, {
            iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        }).toString(CryptoJS.enc.Utf8)
    }
}

// 解密昵称函数
decryptNick = g => {
    if (g != null && g.custom) {
        try {
            const k = JSON.parse(g.custom);
            const i = k.nickname_ciphertext ?? k.nicknameCiphertext;
            i && (g.nick = AES.decrypt(i))
        } catch {}
        return g
    }
}

// 解密群昵称函数
decryptTeamNick = g => {
    if (g != null && g.serverCustom) {
        try {
            const k = JSON.parse(g.serverCustom);
            const i = k.nickname_ciphertext ?? k.nicknameCiphertext;
            return i && (g.name = AES.decrypt(i)), k
        } catch {}
        return g
    }
}

// AES直接解密
AES_decryptNick = (g = "") => isBase64(g) ? AES.decrypt(g) : g
```

### 密文存储位置

| 字段路径 | 说明 |
|----------|------|
| `member.custom.nicknameCiphertext` | 群成员的加密昵称 |
| `member.custom.nickname_ciphertext` | 群成员的加密昵称（兼容） |
| `team.serverCustom.nickname_ciphertext` | 群名称加密 |
| `user.custom.nickname_ciphertext` | 用户资料中的加密昵称 |

### C# 解密实现

```csharp
using System.Security.Cryptography;
using System.Text;

public static class NicknameDecryptor
{
    private static readonly byte[] _aesKey = Encoding.UTF8.GetBytes("d6ba6647b7c43b79d0e42ceb2790e342");
    private static readonly byte[] _aesIv = Encoding.UTF8.GetBytes("kgWRyiiODMjSCh0m");

    public static string Decrypt(string ciphertextBase64)
    {
        if (string.IsNullOrWhiteSpace(ciphertextBase64))
            return null;
        
        try
        {
            byte[] cipherBytes = Convert.FromBase64String(ciphertextBase64);
            
            using (var aes = Aes.Create())
            {
                aes.Key = _aesKey;
                aes.IV = _aesIv;
                aes.Mode = CipherMode.CBC;
                aes.Padding = PaddingMode.PKCS7;
                
                using (var decryptor = aes.CreateDecryptor())
                using (var ms = new MemoryStream(cipherBytes))
                using (var cs = new CryptoStream(ms, decryptor, CryptoStreamMode.Read))
                using (var sr = new StreamReader(cs, Encoding.UTF8))
                {
                    return sr.ReadToEnd();
                }
            }
        }
        catch
        {
            return null;
        }
    }
}
```

### Node.js 解密实现

```javascript
const crypto = require('crypto');

const key = Buffer.from('d6ba6647b7c43b79d0e42ceb2790e342', 'utf8');
const iv = Buffer.from('kgWRyiiODMjSCh0m', 'utf8');

function decrypt(ciphertextBase64) {
    try {
        const decipher = crypto.createDecipheriv('aes-256-cbc', key, iv);
        decipher.setAutoPadding(true);
        let decrypted = decipher.update(Buffer.from(ciphertextBase64, 'base64'));
        decrypted = Buffer.concat([decrypted, decipher.final()]);
        return decrypted.toString('utf8');
    } catch (e) {
        return null;
    }
}

// 使用示例
console.log(decrypt('HLF4vIVpTTX9OuKnY1gW6g==')); // 输出: 挪仇
```

---

## NIM SDK API

### 全局对象

```javascript
window.nim  // NIM SDK 实例
```

### SDK配置信息

| 参数 | 值 |
|------|-----|
| AppKey | `b03cfcd909dbf05c25163cc8c7e7b6cf` |
| Account | 当前登录账号 (如 `1948408648`) |

### 已发现的56个NIM方法

从 `index-c221f02a.js` 中提取的所有NIM SDK方法：

#### 消息相关 (8个)
| 方法 | 说明 |
|------|------|
| `sendText` | 发送文本消息 |
| `sendFile` | 发送文件消息 |
| `sendCustomMsg` | 发送自定义消息 |
| `forwardMsg` | 转发消息 |
| `deleteMsgSelf` | 删除自己的消息 |
| `getHistoryMsgs` | 获取历史消息 |
| `getLocalMsgsByIdClients` | 按ID获取本地消息 |
| `getMsgsByIdServer` | 按服务端ID获取消息 |

#### 群组相关 (15个)
| 方法 | 说明 |
|------|------|
| `getTeam` | 获取群信息 |
| `getTeamMembers` | 获取群成员 |
| `dismissTeam` | 解散群 |
| `leaveTeam` | 退出群 |
| `transferTeam` | 转让群主 |
| `addTeamMembers` | 添加群成员 |
| `removeTeamMembers` | 移除群成员 |
| `addTeamManagers` | 添加管理员 |
| `removeTeamManagers` | 移除管理员 |
| `muteTeamAll` | 全员禁言 |
| `updateInfoInTeam` | 更新群内信息 |
| `acceptTeamInvite` | 接受入群邀请 |
| `rejectTeamInvite` | 拒绝入群邀请 |
| `applyTeam` | 申请入群 |
| `passTeamApply` | 通过入群申请 |
| `rejectTeamApply` | 拒绝入群申请 |

#### 好友相关 (6个)
| 方法 | 说明 |
|------|------|
| `applyFriend` | 申请添加好友 |
| `passFriendApply` | 通过好友申请 |
| `rejectFriendApply` | 拒绝好友申请 |
| `deleteFriend` | 删除好友 |
| `updateFriend` | 更新好友备注 |
| `getRelations` | 获取关系列表 |

#### 用户相关 (3个)
| 方法 | 说明 |
|------|------|
| `getUser` | 获取单个用户 |
| `getUsers` | 批量获取用户 |
| `updateMyInfo` | 更新个人资料 |

#### 会话相关 (8个)
| 方法 | 说明 |
|------|------|
| `getLocalSession` | 获取本地会话 |
| `getLocalSessions` | 获取所有本地会话 |
| `deleteLocalSession` | 删除本地会话 |
| `getServerSessions` | 获取服务端会话 |
| `resetSessionUnread` | 重置未读数 |
| `addStickTopSession` | 置顶会话 |
| `deleteStickTopSession` | 取消置顶 |
| `clearServerHistoryMsgsWithSync` | 清除并同步历史消息 |

#### 黑名单/静音 (2个)
| 方法 | 说明 |
|------|------|
| `markInBlacklist` | 加入黑名单 |
| `markInMutelist` | 加入静音列表 |

#### 消息回执 (2个)
| 方法 | 说明 |
|------|------|
| `sendMsgReceipt` | 发送已读回执 |
| `sendTeamMsgReceipt` | 发送群已读回执 |

#### 信令/通话 (4个)
| 方法 | 说明 |
|------|------|
| `signalingJoinAndAccept` | 加入并接受信令 |
| `signalingLeave` | 离开信令 |
| `signalingCancel` | 取消信令 |
| `signalingControl` | 信令控制 |

#### 其他 (8个)
| 方法 | 说明 |
|------|------|
| `connect` | 连接 |
| `disconnect` | 断开连接 |
| `destroy` | 销毁实例 |
| `previewFile` | 预览文件 |
| `_previewFileNonResume` | 非断点续传预览 |
| `httpRequestProxy` | HTTP代理请求 |
| `subscribeEvent` | 订阅事件 |

### Pinia Stores (7个)

从源代码中发现的状态管理stores：

| Store | 说明 |
|-------|------|
| `useAppStore` | 应用状态 (用户信息、设置、好友列表等) |
| `useCacheStore` | 缓存管理 |
| `useLineStore` | 线路状态 |
| `useMomentStore` | 朋友圈/动态 |
| `useNoticeStore` | 通知管理 |
| `useRtcStore` | 音视频通话状态 |
| `useSdkStore` | SDK状态管理 |

---

## 数据存储

### IndexedDB

数据库名称格式：`nim-{account}`

例如：`nim-1948408648`

#### 数据表结构

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| `user` | 用户信息 | account, nick, avatar, custom |
| `friend` | 好友列表 | account, createTime |
| `team` | 群组信息 | teamId, name, owner, serverCustom |
| `teamMember` | 群成员信息 | teamId, account, nickInTeam, custom |
| `msg` / `msg1` | 消息记录 | from, fromNick, text, time |
| `session` | 会话列表 | id, ack, unread |
| `blacklist` | 黑名单 | account |
| `sysMsg` | 系统消息 | type, from, attach |

### LocalStorage

| 键名 | 说明 |
|------|------|
| `linestate` | 线路状态 |
| `managestate` | 管理状态 |

---

## 功能统计

从源代码搜索统计的功能使用情况：

### 消息功能
| 功能 | 出现次数 |
|------|----------|
| sendText | 31 |
| sendFile | 44 |
| sendCustomMsg | 18 |
| sendTipMsg | 12 |
| forwardMsg | 52 |
| deleteMsg | 326 |
| revokeMsg | 6 |

### 群组功能
| 功能 | 出现次数 |
|------|----------|
| getTeam | 282 |
| getTeamMembers | 50 |
| createTeam | 32 |
| dismissTeam | 40 |
| muteTeamAll | 21 |
| updateTeam | 168 |

### 加密功能
| 功能 | 出现次数 |
|------|----------|
| encrypt | 122 |
| decrypt | 62 |
| AES | 19 |
| CryptoJS | 12 |
| decryptNick | 7 |
| decryptTeamNick | 4 |

### 其他功能
| 功能 | 出现次数 |
|------|----------|
| RTC (音视频) | 2322 |
| Signaling | 477 |
| Moment (朋友圈) | 484 |
| Comment | 902 |
| Login | 929 |
| Token | 1217 |

---

## 源代码分析方法

### PowerShell 搜索命令

```powershell
# 搜索NIM方法
$content = [System.IO.File]::ReadAllText("index-*.js")
$matches = [regex]::Matches($content, "nim\.(\w+)\s*\(")
$matches | ForEach-Object { $_.Groups[1].Value } | Sort-Object -Unique

# 搜索AES配置
$idx = $content.IndexOf("AES={")
$content.Substring($idx, 800)

# 搜索密钥
Select-String -Path "*.js" -Pattern "Utf8\.parse"
```

### Node.js 分析脚本

```javascript
const fs = require('fs');
const content = fs.readFileSync('index-*.js', 'utf8');

// 提取NIM方法
const methods = new Set();
const regex = /nim\.(\w+)\s*\(/g;
let match;
while ((match = regex.exec(content)) !== null) {
    methods.add(match[1]);
}
console.log([...methods].sort());
```

---

## 附录

### A. 消息类型

| type | 说明 |
|------|------|
| `text` | 文本消息 |
| `image` | 图片消息 |
| `audio` | 语音消息 |
| `video` | 视频消息 |
| `file` | 文件消息 |
| `geo` | 地理位置 |
| `custom` | 自定义消息 |
| `tip` | 提示消息 |
| `notification` | 通知消息 |

### B. 群成员类型

| type | 说明 |
|------|------|
| `owner` | 群主 |
| `manager` | 管理员 |
| `normal` | 普通成员 |

### C. 会话ID格式

| 格式 | 说明 | 示例 |
|------|------|------|
| `p2p-{account}` | 私聊会话 | `p2p-1948408648` |
| `team-{teamId}` | 群聊会话 | `team-40821608989` |

### D. WebSocket URLs

| URL | 说明 |
|-----|------|
| `wss://statistic.live.126.net/lps-websocket/websocket/collect` | 统计服务 |

---

## 版本信息

- **文档版本**: 2.0
- **分析日期**: 2026-01-08
- **旺商聊版本**: wangshangliao_win_online
- **NIM SDK**: 网易云信
- **解密验证**: ✅ 已验证成功
