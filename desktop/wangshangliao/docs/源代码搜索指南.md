# 旺商聊源代码搜索指南

## 概述

本文档介绍如何在旺商聊的混淆JS代码中搜索关键逻辑和API。

---

## 文件位置

```
C:\Program Files (x86)\wangshangliao_win_online\resources\app\dist\assets\
├── index-c221f02a.js        # 主应用 (~4.13 MB)
├── zh-cn-acff1ed5.js        # 业务逻辑+加密 (~1.5 MB)
└── *.js                     # 其他模块
```

---

## PowerShell 搜索命令

### 基础搜索

```powershell
# 搜索关键词
Select-String -Path "*.js" -Pattern "keyword"

# 大小写不敏感搜索
Select-String -Path "*.js" -Pattern "keyword" -CaseSensitive:$false

# 搜索多个文件
Select-String -Path "C:\Program Files (x86)\wangshangliao_win_online\resources\app\dist\assets\*.js" -Pattern "keyword"
```

### 获取上下文

```powershell
# 读取文件内容
$content = [System.IO.File]::ReadAllText("path\to\file.js")

# 查找索引
$idx = $content.IndexOf("关键词")

# 获取前后上下文
if ($idx -gt 0) {
    $content.Substring([Math]::Max(0, $idx-500), 1500)
}
```

### 正则表达式搜索

```powershell
# 使用正则匹配
$matches = [regex]::Matches($content, "pattern")

# 遍历匹配结果
foreach ($m in $matches) {
    Write-Host $m.Value
}
```

---

## 常用搜索模式

### 1. 加密解密相关

```powershell
# AES加密配置
Select-String -Path "*.js" -Pattern "AES=\{|AES\s*=\s*\{"

# 密钥和IV
Select-String -Path "*.js" -Pattern "key\s*=.*parse|iv\s*=.*parse"

# CryptoJS方法
Select-String -Path "*.js" -Pattern "CryptoJS\.(AES|MD5|SHA)"

# 解密函数
Select-String -Path "*.js" -Pattern "decrypt|decipher|decryptNick|decryptTeamNick"
```

### 2. NIM SDK API

```powershell
# SDK方法调用
Select-String -Path "*.js" -Pattern "nim\.\w+\s*\("

# 消息相关
Select-String -Path "*.js" -Pattern "sendText|sendImage|getLocalMsgs|getHistoryMsgs"

# 群组相关
Select-String -Path "*.js" -Pattern "getTeams|getTeamMembers|muteTeam|kickTeam"

# 用户相关
Select-String -Path "*.js" -Pattern "getUser|getUsers|updateMyInfo"
```

### 3. 昵称相关

```powershell
# 昵称字段
Select-String -Path "*.js" -Pattern "nickname|nickInTeam|fromNick"

# 昵称密文
Select-String -Path "*.js" -Pattern "nickname_ciphertext|nicknameCiphertext"

# MD5检测
Select-String -Path "*.js" -Pattern "\[a-f0-9\]\{32\}"
```

### 4. 存储相关

```powershell
# IndexedDB
Select-String -Path "*.js" -Pattern "indexedDB|openDatabase"

# LocalStorage
Select-String -Path "*.js" -Pattern "localStorage|sessionStorage"

# 数据库名
Select-String -Path "*.js" -Pattern "nim-\d+"
```

### 5. Vue组件

```powershell
# 组件定义
Select-String -Path "*.js" -Pattern "defineComponent|defineStore"

# Pinia store
Select-String -Path "*.js" -Pattern "useAppStore|useChatStore|useUserStore"

# 计算属性
Select-String -Path "*.js" -Pattern "computed:\s*\{"

# 方法定义
Select-String -Path "*.js" -Pattern "methods:\s*\{"
```

---

## Node.js 动态分析

### CDP连接模板

```javascript
const WebSocket = require('ws');
const http = require('http');

async function connect() {
    // 获取调试目标
    const targets = await new Promise((resolve, reject) => {
        http.get('http://127.0.0.1:9222/json', (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => resolve(JSON.parse(data)));
        }).on('error', reject);
    });
    
    const pageTarget = targets.find(t => 
        t.type === 'page' && t.url.includes('wangshangliao')
    );
    
    if (!pageTarget) {
        throw new Error('WangShangLiao not found');
    }
    
    const ws = new WebSocket(pageTarget.webSocketDebuggerUrl);
    let msgId = 1;
    const pending = new Map();
    
    ws.on('message', (data) => {
        const msg = JSON.parse(data.toString());
        if (msg.id && pending.has(msg.id)) {
            pending.get(msg.id)(msg);
            pending.delete(msg.id);
        }
    });
    
    await new Promise(resolve => ws.on('open', resolve));
    
    async function evaluate(expression, awaitPromise = false) {
        return new Promise((resolve) => {
            const id = msgId++;
            pending.set(id, (result) => {
                resolve(result.result?.result?.value);
            });
            ws.send(JSON.stringify({
                id,
                method: 'Runtime.evaluate',
                params: { expression, returnByValue: true, awaitPromise }
            }));
        });
    }
    
    return { ws, evaluate };
}
```

### 常用分析脚本

#### 列出所有NIM方法

```javascript
const result = await evaluate(`
    Object.keys(window.nim)
        .filter(k => typeof window.nim[k] === 'function')
        .join('\\n')
`);
console.log(result);
```

#### 获取Vue全局属性

```javascript
const result = await evaluate(`
    JSON.stringify(
        Object.keys(
            document.querySelector('#app')?.__vue_app__?.config?.globalProperties || {}
        )
    )
`);
console.log(JSON.parse(result));
```

#### 搜索webpack模块

```javascript
const result = await evaluate(`
(function() {
    var found = [];
    if (window.__webpack_require__) {
        var cache = window.__webpack_require__.c || {};
        Object.keys(cache).forEach(function(id) {
            var mod = cache[id];
            if (mod && mod.exports) {
                var keys = Object.keys(mod.exports || {});
                keys.forEach(function(key) {
                    if (key.toLowerCase().includes('decrypt')) {
                        found.push({ id: id, key: key });
                    }
                });
            }
        });
    }
    return JSON.stringify(found);
})();
`);
console.log(JSON.parse(result));
```

#### 监听网络请求

```javascript
// 启用网络监控
await sendCommand('Network.enable');

ws.on('message', (data) => {
    const msg = JSON.parse(data.toString());
    if (msg.method === 'Network.responseReceived') {
        const url = msg.params?.response?.url || '';
        if (url.includes('nim') || url.includes('api')) {
            console.log('Request:', url);
        }
    }
});
```

---

## 搜索技巧

### 1. 从已知函数入手

如果知道一个函数名（如 `decryptTeamNick`），搜索它的定义和调用：

```powershell
# 搜索定义
Select-String -Path "*.js" -Pattern "decryptTeamNick\s*="

# 搜索调用
Select-String -Path "*.js" -Pattern "decryptTeamNick\s*\("
```

### 2. 从UI文字入手

如果看到界面上显示"群成员"，搜索相关代码：

```powershell
Select-String -Path "*.js" -Pattern "群成员"
```

### 3. 从错误信息入手

如果遇到错误，搜索错误文字：

```powershell
Select-String -Path "*.js" -Pattern "错误信息内容"
```

### 4. 从数据结构入手

如果知道数据字段名，搜索使用位置：

```powershell
Select-String -Path "*.js" -Pattern "\.nickInTeam|\.fromNick"
```

### 5. 使用断点调试

在CDP中设置断点：

```javascript
// 获取脚本ID
await sendCommand('Debugger.enable');

// 设置断点
await sendCommand('Debugger.setBreakpointByUrl', {
    url: 'index.html',
    lineNumber: 100,
    columnNumber: 0
});
```

---

## 重要发现记录

### 加密密钥发现过程

1. 搜索 `nickname_ciphertext`
2. 找到 `decryptNick` 函数
3. 发现调用 `AES.decrypt(i)`
4. 搜索 `AES=` 找到对象定义
5. 获取 `key` 和 `iv` 变量值

```powershell
# 步骤1: 搜索密文字段
Select-String -Path "*.js" -Pattern "nickname_ciphertext"

# 步骤2: 搜索解密函数
Select-String -Path "*.js" -Pattern "decryptNick"

# 步骤3: 搜索AES对象
Select-String -Path "*.js" -Pattern "AES=\{"

# 步骤4: 获取密钥上下文
$content = [System.IO.File]::ReadAllText("zh-cn-*.js")
$idx = $content.IndexOf("AES={encrypt:")
$content.Substring([Math]::Max(0, $idx-500), 1200)
```

### 发现的关键代码

```javascript
// 密钥配置 (zh-cn-*.js)
const key = CryptoJS.enc.Utf8.parse("d6ba6647b7c43b79d0e42ceb2790e342");
const iv = CryptoJS.enc.Utf8.parse("kgWRyiiODMjSCh0m");

// AES对象定义
AES = {
    encrypt: function(g) {
        return CryptoJS.AES.encrypt(g, key, {
            iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        }).toString()
    },
    decrypt: function(g) {
        return CryptoJS.AES.decrypt(g, key, {
            iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        }).toString(CryptoJS.enc.Utf8)
    }
}

// 解密昵称函数
decryptNick = g => {
    if (g != null && g.custom) {
        try {
            const k = JSON.parse(g.custom);
            const i = k.nickname_ciphertext ?? k.nicknameCiphertext;
            i && (g.nick = AES.decrypt(i))
        } catch {}
        return g
    }
}

// 解密群昵称函数
decryptTeamNick = g => {
    if (g != null && g.serverCustom) {
        try {
            const k = JSON.parse(g.serverCustom);
            const i = k.nickname_ciphertext ?? k.nicknameCiphertext;
            return i && (g.name = AES.decrypt(i)), k
        } catch {}
        return g
    }
}
```

---

## 常见问题

### Q: 如何找到混淆后的函数名？

A: 使用功能描述性字符串搜索，如搜索"群成员"、"发送消息"等UI文字。

### Q: 如何处理超大JS文件？

A: 使用流式读取或分段读取：

```powershell
# 读取前10000字符
$content = [System.IO.File]::ReadAllText("large.js")
$content.Substring(0, 10000)
```

### Q: 如何追踪函数调用链？

A: 在CDP中使用调试器：

```javascript
// 启用调试
await sendCommand('Debugger.enable');

// 在函数入口设置断点
await sendCommand('Debugger.setBreakpointByUrl', {
    urlRegex: '.*index.*\\.js',
    lineNumber: 1000
});

// 监听暂停事件
ws.on('message', (data) => {
    const msg = JSON.parse(data.toString());
    if (msg.method === 'Debugger.paused') {
        console.log('Paused at:', msg.params.callFrames[0].location);
    }
});
```

### Q: 如何导出所有API？

A: 运行时枚举：

```javascript
const result = await evaluate(`
    var apis = {};
    ['nim', 'Vue', 'Pinia'].forEach(function(name) {
        if (window[name]) {
            apis[name] = Object.keys(window[name])
                .filter(k => typeof window[name][k] === 'function');
        }
    });
    JSON.stringify(apis, null, 2);
`);
console.log(result);
```

---

## 工具推荐

1. **VSCode** - 大文件搜索
2. **DevTools** - 运行时调试
3. **PowerShell** - 批量搜索
4. **Node.js + ws** - CDP自动化
5. **Prettier** - 格式化混淆代码

