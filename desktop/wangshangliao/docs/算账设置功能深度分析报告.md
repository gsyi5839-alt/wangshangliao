# 算账设置功能深度分析报告

> 生成时间: 2026-01-08
> 项目: WangShangLiaoBot

---

## 一、整体架构

### 主窗体结构

**入口**: `SettingsForm` - 算账设置主窗体

**位置**: `Forms/Settings/SettingsForm.cs`

**包含 10 个 Tab 页面**:
1. 账单设置 (tabBillSettings)
2. 下注处理 (tabBetProcess)
3. 玩法赔率设置 (tabOdds)
4. 自动回复 (tabAutoReply)
5. 黑名单/刷屏检测 (tabBlacklist)
6. 名片 (tabCard)
7. 托管设置 (tabTrustee)
8. 送分活动 (tabBonus)
9. 托设置 (tabTrusteeSettings)
10. 其他设置 (tabOther)

---

## 二、各Tab页功能详解

### Tab 1: 账单设置 ✅ 已实现

**文件位置**: 
- `Forms/Settings/BillSettingsForm.cs`
- `Forms/Settings/BillSettingsForm.Designer.cs`

#### 左侧面板 - 开奖发送设置

| 功能项 | 控件类型 | 配置项 | 默认值 |
|--------|----------|--------|--------|
| 开奖发送 | CheckBox | `EnableLotteryNotify` | - |
| 带8 | CheckBox | `LotteryWith8` | - |
| 图片发送 | CheckBox | `LotteryImageSend` | - |
| 期数 | NumericUpDown | `PeriodCount` | 21期 |
| 取餐码格式 | TextBox | 只读 | `[一区] + [二区] + [三区] = [开奖号码]` |

#### 账单格式设置

| 功能项 | 控件类型 | 配置项 | 范围/默认值 |
|--------|----------|--------|-------------|
| 账单列数 | NumericUpDown | `BillColumns` | 1-10, 默认4 |
| 图片发送 | CheckBox | `BillImageSend` | - |
| 开发账单秒顺回复 | CheckBox | `BillSecondReply` | - |
| 历史格式 | TextBox | - | `[开奖历史]` |

#### 群作业设置

| 功能项 | 控件类型 | 配置项 |
|--------|----------|--------|
| 群作业账单发送 | CheckBox | `GroupTaskSend` |
| 不显示输光玩家 | CheckBox | `HideLostPlayers` |
| 零分不删除账单 | CheckBox | `KeepZeroScoreBill` |
| 只保留近10期群作业 | CheckBox | `KeepRecent10Tasks` |
| 账单玩家进群自动同意 | CheckBox | `AutoApprovePlayer` |
| 账单不足N位补零 | NumericUpDown | `BillMinDigits` |
| 账单小于N隐藏 | NumericUpDown | `BillHideThreshold` |

#### 右侧面板 - 基本设置

| 功能项 | 控件类型 | 配置项 |
|--------|----------|--------|
| 管理旺旺号 | TextBox | `AdminWangWangId` |
| 绑定群号 | TextBox | `GroupId` |

#### 禁言、核对设置

| 功能项 | 控件类型 | 配置项 | 默认值 |
|--------|----------|--------|--------|
| 封盘前N秒禁言 | NumericUpDown | `MuteBeforeSeconds` | 2秒 |
| 计时N秒发送下注数据 | NumericUpDown | `BetDataDelaySeconds` | 10秒 |
| 下注数据图片发送 | CheckBox | `BetDataImageSend` | - |
| 群作业发送通知 | CheckBox | `GroupTaskNotify` | - |

#### 消息反馈设置

| 功能项 | 配置项 |
|--------|--------|
| 反馈旺旺号 | `FeedbackWangWangId` |
| 反馈群号 | `FeedbackGroupId` |
| 反馈到旺旺 | `FeedbackToWangWang` |
| 反馈到群里 | `FeedbackToGroup` |
| 下注核对反馈 | `BetCheckFeedback` |
| 下注汇总反馈 | `BetSummaryFeedback` |
| 开奖盈利反馈 | `ProfitFeedback` |
| 发送账单反馈 | `BillSendFeedback` |

#### 账单替换命令说明

```
[一区]      自动替换为开奖第一个号码
[二区]      自动替换为开奖第二个号码
[三区]      自动替换为开奖第三个号码
[开奖号码]  自动替换为开奖总和号码
[开奖时间]  自动替换为开奖时间
[开奖时间2] 自动替换为开奖时间,小写
[期数]      自动替换为开奖期数,加粗数字
[期数2]     自动替换为开奖期数,正常数字
[开奖历史]  自动替换为开奖历史
[账单]      自动替换为账单,张三100 李四100
[账单2]     自动替换为账单,张三(123456789$)=100
[大小单双]  自动替换为开奖大小单双
[客户人数]  自动替换为客户人数
[总分数]    自动替换为账单总分数
[豹顺对子]  自动替换为豹子顺子对子
[龙虎豹]    自动替换为龙虎豹
[龙虎历史]  自动替换为龙虎豹历史
[中奖玩家]  自动替换为中奖玩家信息
[开奖图]    自动替换为开奖走势图
```

---

### Tab 2: 下注处理 ✅ 已实现

**文件位置**: 
- `Controls/BetProcess/BetBasicSettingsControl.cs`
- `Controls/BetProcess/BetAttackRangeControl.cs`

#### 2.1 基本设置 (BetBasicSettingsControl)

**基本设置 Row 1-2:**
| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| 允许改加注 | `AllowModifyBet` | true |
| 禁止取消 | `ProhibitCancel` | false |
| 下注显示 | `ShowBet` | true |
| 变量先注后分 | `VariableBetLater` | true |
| 上分后自动处理之前下注 | `AutoProcessBeforeScore` | false |
| 发送封盘后上分不用处理之前下注 | `SendSealBeforeProcess` | false |

**重复下注处理 Row 3-4:**
| 模式值 | 说明 |
|--------|------|
| 0 | 算成加注(不推荐) |
| 1 | 同注不算 不同等于加注 |
| 2 | 算最后一次下注(推荐，默认) |
| 3 | 算前第一次下注 |

**模糊匹配 Row 5-6:**
| 设置项 | 说明 |
|--------|------|
| 模糊匹配下注开/关 | `FuzzyMatchEnabled` |
| 模糊匹配支持提醒 | `FuzzyMatchSupportRemind` |
| 无账单下注提醒 | `NoBillRemindEnabled` |
| 无账单提醒内容 | `NoBillRemindContent` |

**组合下注无效 Row 7-10:**
| 设置项 | 说明 |
|--------|------|
| 杀组合下注无效 | `CombinationInvalidEnabled` |
| 杀组合无效提示 | `CombinationInvalidMsg` |
| 多组合下注无效 | `MultiCombinationInvalidEnabled` |
| 多组合无效提示 | `MultiCombinationInvalidMsg` |
| 单注反下注无效 | `SingleOppositeInvalidEnabled` |
| 单注反下注无效提示 | `SingleOppositeInvalidMsg` |
| 最多组合限制启用 | `MaxCombinationEnabled` |
| 最多组合数量 | `MaxCombinationCount` (默认3) |
| 超过组合限制提示 | `MaxCombinationMsg` |

**群开关 Row 11-14:**
| 设置项 | 说明 |
|--------|------|
| 开启仅支持拼音下注 | `PinyinBetOnly` |
| 中文下注处理模式 | 0=有效并提醒, 1=无效并提醒 |
| 拼音提示内容 | `PinyinRemindContent` |
| 接收群聊下注 | `ReceiveGroupBet` |
| 自动禁言解禁群 | `AutoMuteUnmute` |

**好友开关 Row 11-16:**
| 设置项 | 说明 |
|--------|------|
| 开启好友私聊下注 | `EnableFriendChat` |
| 自动同意好友添加 | `AutoAgreeFriend` |
| 只接群成员下注 | `OnlyMemberBet` |
| 私聊下注不在群内反馈 | `FriendBetNotInGroup` |
| 私聊上下分不在群内反馈 | `FriendScoreNotInGroup` |
| 私聊词库在群内反馈 | `FriendQueryInGroup` |

**其他设置 Row 15-16:**
| 设置项 | 默认值 |
|--------|--------|
| 全局图片发送启用 | false |
| 图片文字大小 | 19像素 |
| 历史显示启用 | true |
| 历史显示期数 | 11期 |
| 全局数字小写 | false |
| 大写数字采用①②③ | false |

#### 2.2 攻击范围设置 (BetAttackRangeControl)

**下注范围限制 - 5行配置:**

| 类型 | Min/Max 配置项 | 默认范围 |
|------|----------------|----------|
| **Row 1** | | |
| 单注 | SingleBetMin/Max | 2-3000 |
| 对子 | PairMin/Max | 2-500 |
| 尾单注 | TailSingleMin/Max | 0-0 |
| 大边 | BigEdgeMin/Max | 0-0 |
| **Row 2** | | |
| 组合 | CombinationMin/Max | 2-1000 |
| 顺子 | StraightMin/Max | 2-500 |
| 尾组合 | TailCombinationMin/Max | 0-0 |
| 小边 | SmallEdgeMin/Max | 0-0 |
| **Row 3** | | |
| 数字 | DigitMin/Max | 2-500 |
| 豹子 | LeopardMin/Max | 2-200 |
| 尾数字 | TailDigitMin/Max | 0-0 |
| 边 | EdgeMin/Max | 0-0 |
| **Row 4** | | |
| 极数 | ExtremeMin/Max | 2-500 |
| 半顺 | HalfStraightMin/Max | 0-0 |
| 和 | SumMin/Max | 0-0 |
| 中 | MiddleMin/Max | 0-0 |
| **Row 5** | | |
| 龙虎 | DragonTigerMin/Max | 0-0 |
| 杂 | MixedMin/Max | 0-0 |
| 三军 | ThreeArmyMin/Max | 0-0 |
| 总额封顶 | TotalLimit | 60000 |

**超范围提示**: `@qq 您攻击的[[下注内容]]分数不能[高低],请及时修改攻击`

**服务**: `BetAttackRangeSettingsService`
- `ValidateBetAmount()` - 验证单项下注金额
- `ValidateTotalAmount()` - 验证总额是否超限

---

### Tab 3: 玩法赔率设置 ✅ 已实现

**文件位置**: `Controls/OddsSettingsControl.cs`

#### 子Tab页面列表

| 子Tab | 名称 | 状态 | 控件文件 |
|-------|------|------|----------|
| 1 | 经典玩法 | ✅ 已实现 | `ClassicPlaySettingsControl.cs` |
| 2 | 尾球玩法 | ✅ 已实现 | `TailBallSettingsControl.cs` |
| 3 | 龙虎玩法 | ✅ 已实现 | `DragonTigerSettingsControl.cs` |
| 4 | 三军玩法 | ✅ 已实现 | `ThreeArmySettingsControl.cs` |
| 5 | 定位球玩法 | ✅ 已实现 | `PositionBallSettingsControl.cs` |
| 6 | 其他玩法 | ⏳ 开发中 | `OtherPlaySettingsControl.cs` |

#### 经典玩法设置项

**大-小-单-双超设置**:
- 算总注/算单注 (RadioButton)
- 多档位下注范围设置
- 各档位赔率设置

**豹/顺/对子设置**:
- 开/关
- 对子回本
- 顺子回本
- 豹子回本
- 豹子通杀

**赔率设置**:
- 大小单双赔率
- 大单小双赔率
- 大双小单赔率
- 极大极小赔率
- 特码数字赔率

**极数设置**:
- 极大范围 (22-27)
- 极小范围 (0-5)

**单独数字赔率**:
- 0-9各数字独立赔率配置

#### 定位球玩法设置项

- 开启/关闭开关
- 单注赔率 + 下注范围
- 组合赔率 + 下注范围
- 特码赔率 + 下注范围

**下注格式说明**:
```
1/大/100    1球大，下注100
2/4/100     2球4，下注100
3/456/100   3球4、5、6，各下注100
哈1/大      全下1/大
```

#### 3.2 尾球玩法 (TailBallSettingsControl)

| 设置项 | 配置字段 |
|--------|----------|
| 开启/关闭 | `TailBallEnabled` |
| 尾球玩法不算经典 | `TailBallNotCountClassic` |
| **无13/14赔率** | |
| 大小赔率 | `TailOdds1314BigSmall` |
| 组合赔率 | `TailOdds1314Combo` |
| 特码赔率 | `TailOdds1314Special` |
| **尾球开0/9赔率** | |
| 大小赔率 | `TailOdds09BigSmall` |
| 组合赔率 | `TailOdds09Combo` |
| **有13/14赔率** | |
| 单注/总注 | `TailBetTypeSingle` |
| 超过N1 | `TailBallOver1` |
| 大小赔率 | `TailOddsWith1314BigSmall` |
| 超过N2 | `TailBallOver2` |
| 组合赔率 | `TailOddsWith1314Combo` |
| **其他设置** | |
| 其他玩法计入总额 | `OtherGameCountTotal` |
| 禁止0/9 | `TailForbid09` |
| 前球玩法开启 | `FrontBallEnabled` |
| 中球玩法开启 | `MiddleBallEnabled` |

#### 3.3 龙虎玩法 (DragonTigerSettingsControl)

| 设置项 | 配置字段 |
|--------|----------|
| 开启/关闭 | `DragonTigerEnabled` |
| 模式 | 0=龙虎斗, 1=龙虎豹 |
| **规则设置** | |
| 一区 | `DragonTigerZone1` |
| 比较方式 | `DragonTigerCompare` |
| 二区 | `DragonTigerZone2` |
| 和回本 | `DragonTigerDrawReturn` |
| 豹子通杀 | `DragonTigerLeopardKillAll` |
| **赔率设置** | |
| 龙虎赔率 | `DragonTigerOdds` |
| 和赔率 | `DragonTigerDrawOdds` |
| 超过N金额 | `DragonTigerBetOverAmount` |
| 龙虎赔率2 | `DragonTigerOdds2` |
| 和赔率2 | `DragonTigerDrawOdds2` |
| 豹赔率 | `DragonTigerLeopardOdds` |
| **号码定义** | |
| 龙号码 | `DragonNumbers` |
| 虎号码 | `TigerNumbers` |
| 豹号码 | `LeopardNumbers` |

#### 3.4 三军玩法 (ThreeArmySettingsControl)

| 设置项 | 配置字段 |
|--------|----------|
| 开启/关闭 | `ThreeArmyEnabled` |
| 赔率1 | `ThreeArmyOdds1` |
| 赔率2 | `ThreeArmyOdds2` |
| 赔率3 | `ThreeArmyOdds3` |

---

### Tab 4: 自动回复设置 ✅ 已实现

**文件位置**: `Controls/AutoReplySettingsControl.cs`

#### 支付方式回复模板

| 支付方式 | 发送内容 | 文本内容 | 关键词 |
|----------|----------|----------|--------|
| 财富通 | `CftSendText` | `CftText` | `CftReplyKeywords` |
| 支付宝 | `ZfbSendText` | `ZfbText` | `ZfbReplyKeywords` |
| 微信 | `WxSendText` | `WxText` | `WxReplyKeywords` |

#### 关键词自动回复管理

- DataGridView 列表展示
- 关键词/回复内容 两列
- 添加/修改/删除操作
- 二维码图片导入功能

---

### Tab 5: 黑名单/刷屏检测 ✅ 已实现

**文件位置**: `Controls/BlacklistSpamSettingsControl.cs`

#### 黑名单管理

| 功能 | 说明 |
|------|------|
| 黑名单列表 | DataGridView (序号 + 黑名单号) |
| 被机器人踢出自动加黑名单 | CheckBox，默认开启 |
| 被群管理踢出自动加黑名单 | CheckBox |
| 候选人列表 | ListBox显示被踢用户 |
| 全部删除 | 清空黑名单 |
| 添加黑名单 | 从候选人添加 |
| 移除黑名单 | 从列表移除 |

#### 刷屏检测设置

| 规则 | 控件 | 默认值 |
|------|------|--------|
| 发言字符超过N禁言 | NumericUpDown | 60字符 |
| 发言字符超过N踢出 | NumericUpDown | 80字符 |
| 发言行数超过N禁言 | NumericUpDown | 4行 |
| 图片表情禁言 | CheckBox | 开启 |
| 图片超过N次踢出 | NumericUpDown | 6次 |
| 账单0分发言禁言 | CheckBox | - |
| 违规自动撤回 | CheckBox | - |

**字符计算规则**: 一个汉字=2字符，一个字母=1字符

#### 关键词违规处理

- 关键词列表 (DataGridView)
- 处理方式: 禁言/踢出 (ComboBox)
- 禁言时长: 默认10分钟

---

### Tab 6: 名片设置 ⏳ 待开发

**状态**: 显示 "名片设置开发中..."

---

### Tab 7: 托管设置 ⏳ 待开发

**状态**: 显示 "托管设置开发中..."

---

### Tab 8: 送分活动 ⏳ 待开发

**状态**: 显示 "送分活动设置开发中..."

---

### Tab 9: 托设置 ⏳ 待开发

**状态**: 显示 "托设置开发中..."

---

### Tab 10: 其他设置 ✅ 已实现

**文件位置**: `Controls/OtherSettingsControl.cs`

#### 包含8个子面板

##### 1. 艾特分原因 (`AtReasonPanel.cs`)

| 设置项 | 说明 |
|--------|------|
| 原因列表 | 用"\|"分隔多个原因 |
| 私聊加分群内提醒 | CheckBox |
| 私聊加分允许无理由 | CheckBox |
| 活动分原因 | 用"\|"分隔 |

##### 2. 敏感操作开关 (`SensitiveOperationPanel.cs`)

| 设置项 | 说明 |
|--------|------|
| 原密码 | 密码输入框 |
| 新密码 | 密码输入框 |
| 确认密码 | 密码输入框 |
| 关闭敏感密码 | CheckBox |

##### 3. 结算时间 (`SettlementTimePanel.cs`)

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| 结算时间 | DateTimePicker | 20:00:00 |
| 玩家查询今天数据 | CheckBox | 开启 |
| 查询间隔 | NumericUpDown | 10分钟 |

**服务**: `SettlementTimeService`
```csharp
// 主要方法
SettlementTime      // 结算时间
PlayerQueryEnabled  // 玩家查询开关
PlayerQueryIntervalMinutes  // 查询间隔
IsPastSettlementTime()  // 是否已过结算时间
ShouldQueryTodayData()  // 是否查询今天数据
```

##### 4. 开奖延迟 (`LotteryDelayPanel.cs`)

| 设置项 | 说明 |
|--------|------|
| 延迟开关 | 倒计时/开奖 两种模式 |
| PC蛋蛋延迟 | 0-300秒 |
| 加拿大延迟 | 0-300秒 |
| 比特延迟 | 0-300秒 |
| 北京延迟 | 0-300秒 |
| 自动调整时间 | 开关 |
| 调整间隔 | 1-48小时 |

##### 5. 管理命令替换 (`AdminCommandReplacePanel.cs`)

- 关键词 → 替换词 映射管理
- DataGridView 列表展示
- 支持添加/修改/删除

##### 6. 发送消息替换 (`SendMessageReplacePanel.cs`)

- 发送消息关键词替换
- 支持多行替换内容
- 支持添加/修改/删除

##### 7. 命令说明 (`CommandHelpPanel.cs`)

只读命令帮助文档，包含:
```
开始程序/开始游戏/开机
停止程序/停止游戏/关机

今天[类型]=旺旺号
昨天[类型]=旺旺号
[类型]可为：下注、上下分、艾特分、统计、百分比

今天数据=旺旺号
今天期盈利、昨天期盈利
加黑名单旺旺号、减黑名单旺旺号
改名旺旺号=新名片
旺旺号+-=分数理由

@旺旺+分数
@旺旺改名=新名片
@旺旺加黑名单
@旺旺踢
@旺旺解禁 @旺旺禁言
```

##### 8. 常见问题 (`FaqPanel.cs`)

包含两个子Tab:
- 不处理私聊消息
- 不艾特但显示昵称

---

## 封盘设置 (独立窗体)

**文件位置**: `Controls/SealSettings/SealSettingsControl.cs`

#### 4个游戏Tab页面

| Tab | 游戏类型 |
|-----|----------|
| 1 | PC |
| 2 | 加拿大 |
| 3 | 比特 |
| 4 | 北京 |

#### 每个Tab包含的设置

每个游戏类型都有独立的封盘配置:
- 封盘提醒时间 (如70秒、25秒)
- 私聊发送开关
- 图片发送开关
- 规矩发送时间
- 封盘消息内容

#### 状态栏显示

| 显示项 | 说明 |
|--------|------|
| 玩家人数 | 当前在线玩家数 |
| 总分数 | 所有玩家总积分 |
| 本期盈利 | 当期盈亏 |
| 今天总盈利 | 今日累计盈亏 |

**功能按钮**: 解除禁言

---

## 回水工具 (RebateToolControl)

**文件位置**: `Controls/RebateTool/RebateToolControl.cs`

#### 顶部导航栏

| 控件 | 功能 |
|------|------|
| 快速选择时间 | 今天/昨天/本周/上周/本月/上月 |
| 查询时间 | 起始日期时间 - 结束日期时间 |
| 一键清除数据 | 清空所有记录 |
| 操作记录 | 查看操作日志 |

#### 13个子Tab面板

| Tab | 名称 | 控件文件 | 功能 |
|-----|------|----------|------|
| 0 | 统计所有 | `StatisticsAllPanel` | 所有数据汇总统计 |
| 1 | 回水计算 | `RebateCalcPanel` | 计算玩家回水金额 |
| 2 | 回水设置 | `RebateSettingsPanel` | 配置回水规则 |
| 3 | 单独查询 | `SingleQueryPanel` | 单个玩家查询 |
| 4 | 夜宵计算 | `NightSnackCalcPanel` | 夜宵奖励计算 |
| 5 | 夜宵设置 | `NightSnackSettingsPanel` | 配置夜宵规则 |
| 6 | 上下分记录 | `UpDownRecordPanel` | 充值提现记录 |
| 7 | 艾特分记录 | `AtScoreRecordPanel` | @加减分记录 |
| 8 | 每期盈利 | `PerPeriodProfitPanel` | 每期盈亏明细 |
| 9 | 庄家盈利 | `BankerProfitPanel` | 庄家盈亏统计 |
| 10 | 邀请记录 | `InvitationRecordPanel` | 邀请返利记录 |
| 11 | 记录删除 | `RecordDeletePanel` | 删除指定记录 |
| 12 | 自动反水 | `AutoRebatePanel` | 自动返水设置 |

#### 回水设置详情 (RebateSettingsPanel)

**计算模式** (4种):
- 组合比例计算
- 下注次数计算
- 下注流水计算
- 下注输分计算 (默认)

**范围配置** (8行):
| 下注输分范围 | 回水百分比 |
|--------------|------------|
| 50-500 | 8% |
| 500-1000000 | 10% |
| ... | ... |

**特殊设置**:
| 设置项 | 说明 |
|--------|------|
| 开13/14不计算流水 | 开出13或14时所有下注不计入 |
| 开对/顺/豹不计算流水 | 开出特殊号码时不计入 |
| 开13小单小单、开14大双大双不计算 | 分开处理 |
| 开回本不计算流水 | 开出回本号码时不计入 |
| 所有单注不计入流水 | 单注下注不计入 |
| 无组合时单注不计入 | 仅在无组合情况下 |
| 只计算特码下注流水 | 仅特码计入 |

---

## 三、核心服务分析

### BetSettlementService (算账核心服务)

**文件位置**: `Services/Betting/BetSettlementService.cs`

#### 类结构

```csharp
public sealed class BetSettlementService
{
    // 单例
    private static BetSettlementService _instance;
    public static BetSettlementService Instance => _instance ?? (_instance = new BetSettlementService());
    
    // 状态
    public bool IsRunning { get; private set; }
    
    // 事件
    public event Action<string, int, decimal> OnSettlementComplete;
    
    // 方法
    public void Start();
    public void Stop();
    public string ReadWinnersText(DateTime day, string teamId, string period);
}
```

#### 算账流程

```
┌─────────────────┐
│  LotteryService │
│ OnResultUpdated │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ OnLotteryResult │
│    处理开奖     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ OddsConfigService │
│   读取赔率配置   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ BetLedgerService │
│   读取下注记录   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  按TeamId分组   │
│   计算每组结算   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ BetMessageParser │
│   解析下注内容   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   SettleItem    │
│   计算盈亏      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   DataService   │
│  更新玩家积分   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ WriteSettlement │
│  写入结算文件   │
└────────┬────────┘
         │
         ▼
┌─────────────────────┐
│ OnSettlementComplete │
│     触发事件        │
└─────────────────────┘
```

#### 结算算法

```csharp
private static decimal SettleItem(BetItem it, int sum, string dxds, ClassicOddsConfig odds)
{
    // 大小单双(DXDS)
    if (it.Kind == BetKind.Dxds)
    {
        var win = string.Equals(it.Code, dxds, StringComparison.OrdinalIgnoreCase);
        return win ? it.Amount * odds.DxdsOdds : -it.Amount;
    }
    
    // 大/小
    if (it.Kind == BetKind.BigSmall)
    {
        var bs = sum >= 14 ? "大" : "小";
        var win = string.Equals(it.Code, bs, StringComparison.OrdinalIgnoreCase);
        return win ? it.Amount * odds.DxdsOdds : -it.Amount;
    }
    
    // 单/双
    if (it.Kind == BetKind.OddEven)
    {
        var oe = (sum % 2 == 0) ? "双" : "单";
        var win = string.Equals(it.Code, oe, StringComparison.OrdinalIgnoreCase);
        return win ? it.Amount * odds.DxdsOdds : -it.Amount;
    }
    
    return 0m;
}

// 大小单双码生成
private static string GetDxdsCode(int sum)
{
    var bigSmall = sum >= 14 ? "D" : "X";  // D=大, X=小
    var oddEven = (sum % 2 == 0) ? "S" : "D";  // S=双, D=单
    return bigSmall + oddEven;  // 如: "DS"=大双, "XD"=小单
}
```

#### 结算文件格式

```
期号{period} 号码合计={sum} [{dxds}]
{昵称}({ID前4位}) 盈亏:{profit} 下注:{stake} {分数前}->{分数后}
...
```

**文件路径**: `{DatabaseDir}/Bets/{yyyy-MM-dd}/{teamId}/settle-{period}.txt`

---

### SettlementTimeService (结算时间服务)

**文件位置**: `Services/SettlementTimeService.cs`

```csharp
public sealed class SettlementTimeService
{
    // 属性
    public TimeSpan SettlementTime { get; set; }  // 默认 20:00:00
    public bool PlayerQueryEnabled { get; set; }   // 默认 true
    public int PlayerQueryIntervalMinutes { get; set; }  // 默认 10
    
    // 方法
    public bool IsPastSettlementTime();  // 当前是否已过结算时间
    public DateTime GetTodaySettlementDateTime();  // 今天的结算时间点
    public bool ShouldQueryTodayData();  // 是否应查询今天数据
}
```

---

## 四、数据模型

### SettlementEntry (结算条目)

**文件位置**: `Models/Betting/BetModels.cs`

```csharp
public sealed class SettlementEntry
{
    public string Period { get; set; }      // 期号
    public string PlayerId { get; set; }    // 玩家ID
    public string PlayerNick { get; set; }  // 玩家昵称
    public decimal Stake { get; set; }      // 下注金额
    public decimal Profit { get; set; }     // 盈亏
    public decimal ScoreBefore { get; set; } // 结算前积分
    public decimal ScoreAfter { get; set; }  // 结算后积分
    public string Detail { get; set; }      // 详细明细
}
```

---

## 五、相关服务清单

### 核心算账服务

| 服务名称 | 文件路径 | 功能说明 |
|----------|----------|----------|
| `BetSettlementService` | Services/Betting/BetSettlementService.cs | 算账核心服务 |
| `SettlementTimeService` | Services/SettlementTimeService.cs | 结算时间管理 |
| `OddsConfigService` | Services/OddsConfigService.cs | 赔率配置管理 |
| `BetLedgerService` | Services/Betting/BetLedgerService.cs | 下注记录管理 |
| `BetMessageParser` | Services/Betting/BetMessageParser.cs | 下注消息解析 |

### 下注处理服务

| 服务名称 | 文件路径 | 功能说明 |
|----------|----------|----------|
| `BetProcessSettingsService` | Services/BetProcessSettingsService.cs | 下注处理设置 (30+配置项) |
| `BetAttackRangeSettingsService` | Services/BetAttackRangeSettingsService.cs | 下注范围限制 (5行×4列配置) |

### 通用配置服务

| 服务名称 | 文件路径 | 功能说明 |
|----------|----------|----------|
| `ConfigService` | Services/ConfigService.cs | 主配置管理 |
| `DataService` | Services/DataService.cs | 数据持久化 |
| `SpamSettingsService` | Services/Spam/SpamSettingsService.cs | 刷屏检测配置 |
| `AutoReplyService` | Services/AutoReplyService.cs | 自动回复服务 |

### 其他设置服务

| 服务名称 | 文件路径 | 功能说明 |
|----------|----------|----------|
| `AtReasonService` | Services/AtReasonService.cs | 艾特分原因管理 |
| `SensitiveOperationService` | Services/SensitiveOperationService.cs | 敏感操作密码 |
| `LotteryDelayService` | Services/LotteryDelayService.cs | 开奖延迟配置 |
| `AdminCommandReplaceService` | Services/AdminCommandReplaceService.cs | 管理命令替换 |
| `SendMessageReplaceService` | Services/SendMessageReplaceService.cs | 发送消息替换 |

### 服务配置文件

| 服务 | 配置文件 | 位置 |
|------|----------|------|
| BetProcessSettingsService | `下注处理设置.ini` | DatabaseDir |
| BetAttackRangeSettingsService | `攻击范围设置.ini` | DatabaseDir |
| SealSettingsControl | `seal_settings.xml` | Data/ |

---

## 六、已知问题与待办

### ⚠️ 潜在BUG

1. **OddsSettingsControl.cs 经典玩法保存按钮**
   - 位置: 第143行
   - 问题: 只显示MessageBox，实际未保存数据到配置
   
2. **BillSettingsForm.cs 功能缺失**
   - `btnViewInviteLog_Click`: 显示"功能开发中"
   - `btnSetBetDataContent_Click`: 显示"功能开发中"

### ⏳ 待开发功能

| 模块 | 状态 |
|------|------|
| Tab 6: 名片设置 | 待开发 |
| Tab 7: 托管设置 | 待开发 |
| Tab 8: 送分活动 | 待开发 |
| Tab 9: 托设置 | 待开发 |
| 玩法赔率 - 其他玩法 | 待开发 |

### ✅ 已实现功能 (完整列表)

| 模块 | 状态 | 备注 |
|------|------|------|
| Tab 1: 账单设置 | ✅ | 完整实现 |
| Tab 2: 下注处理 | ✅ | 基本设置+攻击范围 |
| Tab 3: 玩法赔率设置 | ✅ | 经典/尾球/龙虎/三军/定位球 |
| Tab 4: 自动回复设置 | ✅ | 完整实现 |
| Tab 5: 黑名单/刷屏检测 | ✅ | 完整实现 |
| Tab 10: 其他设置 | ✅ | 8个子面板全部实现 |
| 封盘设置 | ✅ | 4种游戏类型 |
| 回水工具 | ✅ | 13个子面板全部实现 |

---

## 七、文件清单

### 窗体文件

```
Forms/Settings/
├── SettingsForm.cs              # 算账设置主窗体
├── SettingsForm.Designer.cs     # 设计器代码
├── BillSettingsForm.cs          # 账单设置窗体
└── BillSettingsForm.Designer.cs # 设计器代码
```

### 控件文件

```
Controls/
├── OddsSettingsControl.cs       # 玩法赔率设置
├── OddsSettingsControl.Designer.cs
├── AutoReplySettingsControl.cs  # 自动回复设置
├── AutoReplySettingsControl.Designer.cs
├── BlacklistSpamSettingsControl.cs  # 黑名单/刷屏检测
├── OtherSettingsControl.cs      # 其他设置主控件
│
├── BetProcess/                  # 下注处理控件
│   ├── BetBasicSettingsControl.cs      # 下注基本设置
│   ├── BetBasicSettingsControl.Designer.cs
│   ├── BetAttackRangeControl.cs        # 攻击范围设置
│   └── BetAttackRangeControl.Designer.cs
│
├── Odds/                        # 赔率子控件
│   ├── ClassicPlaySettingsControl.cs   # 经典玩法
│   ├── TailBallSettingsControl.cs      # 尾球玩法
│   ├── DragonTigerSettingsControl.cs   # 龙虎玩法
│   ├── ThreeArmySettingsControl.cs     # 三军玩法
│   ├── PositionBallSettingsControl.cs  # 定位球玩法
│   └── OtherPlaySettingsControl.cs     # 其他玩法
│
├── SealSettings/                # 封盘设置控件
│   ├── SealSettingsControl.cs   # 封盘设置主控件
│   ├── SealTabPage.cs           # 封盘Tab页
│   ├── SealTabPanel.cs          # 封盘面板
│   └── SealMessagePanel.cs      # 封盘消息面板
│
├── RebateTool/                  # 回水工具控件 (13个面板)
│   ├── RebateToolControl.cs     # 回水工具主控件
│   ├── StatisticsAllPanel.cs    # 统计所有
│   ├── RebateCalcPanel.cs       # 回水计算
│   ├── RebateSettingsPanel.cs   # 回水设置
│   ├── SingleQueryPanel.cs      # 单独查询
│   ├── NightSnackCalcPanel.cs   # 夜宵计算
│   ├── NightSnackSettingsPanel.cs # 夜宵设置
│   ├── UpDownRecordPanel.cs     # 上下分记录
│   ├── AtScoreRecordPanel.cs    # 艾特分记录
│   ├── PerPeriodProfitPanel.cs  # 每期盈利
│   ├── BankerProfitPanel.cs     # 庄家盈利
│   ├── InvitationRecordPanel.cs # 邀请记录
│   ├── RecordDeletePanel.cs     # 记录删除
│   └── AutoRebatePanel.cs       # 自动反水
│
└── OtherSettings/               # 其他设置子面板
    ├── AtReasonPanel.cs         # 艾特分原因
    ├── SensitiveOperationPanel.cs  # 敏感操作开关
    ├── SettlementTimePanel.cs   # 结算时间
    ├── LotteryDelayPanel.cs     # 开奖延迟
    ├── AdminCommandReplacePanel.cs  # 管理命令替换
    ├── SendMessageReplacePanel.cs   # 发送消息替换
    ├── CommandHelpPanel.cs      # 命令说明
    └── FaqPanel.cs              # 常见问题
```

### 服务文件

```
Services/
├── Betting/
│   ├── BetSettlementService.cs  # 算账核心服务
│   ├── BetLedgerService.cs      # 下注记录服务
│   ├── BetMessageParser.cs      # 下注消息解析
│   └── OddsConfigService.cs     # 赔率配置服务
├── Spam/
│   └── SpamSettingsService.cs   # 刷屏检测服务
├── BetProcessSettingsService.cs # 下注处理设置服务
├── BetAttackRangeSettingsService.cs # 攻击范围设置服务
├── SettlementTimeService.cs     # 结算时间服务
├── ConfigService.cs             # 主配置服务
├── DataService.cs               # 数据持久化服务
├── AutoReplyService.cs          # 自动回复服务
├── AtReasonService.cs           # 艾特分原因服务
├── SensitiveOperationService.cs # 敏感操作服务
├── LotteryDelayService.cs       # 开奖延迟服务
├── AdminCommandReplaceService.cs # 管理命令替换服务
└── SendMessageReplaceService.cs  # 发送消息替换服务
```

---

## 八、架构总结

```
┌─────────────────────────────────────────────────────────┐
│                      UI 层 (WinForms)                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │
│  │SettingsForm │ │  Controls   │ │   DataGridView  │   │
│  │  (主窗体)   │ │  (各控件)   │ │   (列表展示)    │   │
│  └──────┬──────┘ └──────┬──────┘ └────────┬────────┘   │
└─────────┼───────────────┼─────────────────┼─────────────┘
          │               │                 │
          ▼               ▼                 ▼
┌─────────────────────────────────────────────────────────┐
│                     服务层 (Services)                    │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────┐  │
│  │BetSettlement   │ │ConfigService  │ │ DataService │  │
│  │   Service      │ │  (配置管理)   │ │ (数据持久化)│  │
│  └────────────────┘ └────────────────┘ └────────────┘  │
└─────────────────────────────────────────────────────────┘
          │               │                 │
          ▼               ▼                 ▼
┌─────────────────────────────────────────────────────────┐
│                     数据层 (Data)                        │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────┐  │
│  │  JSON Config   │ │  Player Data   │ │ Bet Ledger │  │
│  │   (配置文件)   │ │  (玩家数据)   │ │ (下注记录) │  │
│  └────────────────┘ └────────────────┘ └────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 九、功能统计摘要

| 分类 | 数量 | 说明 |
|------|------|------|
| 主Tab页面 | 10个 | 算账设置主窗体 |
| 已实现Tab | 6个 | Tab 1,2,3,4,5,10 |
| 待开发Tab | 4个 | Tab 6,7,8,9 |
| 玩法赔率子Tab | 6个 | 5个已实现 |
| 其他设置子面板 | 8个 | 全部已实现 |
| 回水工具子面板 | 13个 | 全部已实现 |
| 封盘设置Tab | 4个 | PC/加拿大/比特/北京 |
| 核心服务 | 18个 | 见服务清单 |
| 配置文件 | 3个 | ini/xml格式 |
| 控件文件 | 50+个 | 见文件清单 |

---

*文档版本: 2.0*
*最后更新: 2026-01-08*
*更新说明: 深度查看所有功能，补充下注处理、玩法赔率、封盘设置、回水工具等模块详细内容*

