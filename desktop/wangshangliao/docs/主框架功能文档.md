# 旺商聊机器人 - 完整功能文档

> 包含主框架 (WangShangLiaoBot) 和副框架 (WSLFramework) 的全部功能说明

## 功能总览

### 主框架功能清单 (39个模块)

| 序号 | 模块名称 | 核心功能 | 服务类 |
|------|----------|---------|--------|
| 1 | 开奖服务 | 自动获取开奖、倒计时、多彩种 | LotteryService |
| 2 | 下注解析 | 多格式下注识别、玩法支持 | BetMessageParser |
| 3 | 赔率服务 | 赔率配置、限额管理 | OddsService |
| 4 | 结算服务 | 自动结算、特殊规则 | BetSettlementService |
| 5 | 自动结算 | 开奖结算、账单生成 | AutoSettlementService |
| 6 | 下注账本 | 下注记录、重复处理 | BetLedgerService |
| 7 | 上下分 | 余额管理、交易记录 | ScoreService |
| 8 | 自动回复 | 关键词、模板、内部回复 | AutoReplyService |
| 9 | 封盘服务 | 倒计时、禁言、通知 | SealingService |
| 10 | 猜数字 | 猜和值、奖励阶梯 | GuessNumberService |
| 11 | 夜宵返点 | 流水返点、夜宵奖励 | BonusService |
| 12 | 长龙减赔 | 连开减赔、跟踪统计 | DragonReduceService |
| 13 | 刷屏检测 | 违规检测、自动惩罚 | SpeechDetectionService |
| 14 | 锁名片 | 名片监控、修改限制 | CardLockService |
| 15 | 托管服务 | 分段策略、自动下注 | TrusteeService |
| 16 | 托号服务 | 托号管理、自动处理 | ShillService |
| 17 | 进群欢迎 | 私聊/群内欢迎 | WelcomeService |
| 18 | 消息调度 | 处理器链、优先级 | MessageDispatcher |
| 19 | 机器人控制 | 服务整合、启停管理 | BotController |
| 20 | 模板引擎 | 变量替换、消息格式 | TemplateEngine |
| 21 | 账号管理 | 多账号、登录状态 | AccountService |
| 22 | 管理员命令 | 群管命令、权限控制 | AdminCommandService |
| 23 | 下注范围限制 | 玩法限额、超限提示 | BetAttackRangeSettingsService |
| 24 | 下注处理设置 | 下注规则、格式设置 | BetProcessSettingsService |
| 25 | 回水服务 | 4种回水模式、阶梯配置 | RebateService |
| 26 | 图片生成 | 账单/开奖图片生成 | ImageGeneratorService |
| 27 | 垃圾检测 | 关键词规则、违规处理 | SpamDetectionService |
| 28 | 开奖延迟 | 多彩种延迟、时间调整 | LotteryDelayService |
| 29 | 艾特分原因 | 加分原因、活动分类 | AtReasonService |
| 30 | 私聊托服务 | 私聊托号、分段下注 | PrivateShillService |
| 31 | 配置同步 | 主副框架配置同步 | ConfigSyncManager |
| 32 | 敏感操作 | 操作密码、安全验证 | SensitiveOperationService |
| 33 | 二七玩法 | 2/7特殊赔率 | TwoSevenService |
| 34 | 数据服务 | 玩家/日志/统计数据 | DataService |
| 35 | 聊天服务 | CDP/Hook消息通信 | ChatService |
| 36 | 消息模板 | 全场景消息模板 | MessageTemplateService |
| 37 | 发送替换 | 发送前关键词替换 | SendMessageReplaceService |
| 38 | 命令替换 | 命令别名映射 | AdminCommandReplaceService |
| 39 | 结算时间 | 每日结算时间管理 | SettlementTimeService |

### 副框架功能清单 (14个模块)

| 序号 | 模块名称 | 核心功能 | 服务类 |
|------|----------|---------|--------|
| 1 | 框架服务端 | HPSocket通信、ZCG协议 | FrameworkServer |
| 2 | CDP桥接 | WebSocket连接、DOM操作 | CDPBridge |
| 3 | 周期管理 | 期号计算、状态管理 | PeriodManager |
| 4 | 定时消息 | 倒计时、封盘、账单 | TimedMessageService |
| 5 | 群管理 | 禁言、踢人、群名片 | GroupManagementService |
| 6 | 自动回复 | 关键字/正则/精确匹配 | AutoReplyService |
| 7 | NIM服务 | 网易云信SDK集成 | NIMService |
| 8 | 响应格式化 | 消息格式化模板 | ZCGResponseFormatter |
| 9 | 数据存储 | 玩家/下注/历史数据 | ZCGDataStorage |
| 10 | 账号管理 | 登录/登出/凭证 | BotLoginService |
| 11 | 事件驱动 | WSLBotContext事件系统 | EventDriven |
| 12 | 账号管理器 | 多账号配置存储 | AccountManager |
| 13 | 消息加密 | msg_attach.b解码 | MessageEncryption |
| 14 | 直连客户端 | NIM直连尝试(备用) | NimDirectClient |

---

## 目录
1. [系统概述](#系统概述)
2. [主框架功能模块](#主框架功能模块)
3. [副框架功能模块](#副框架功能模块)
4. [详细功能说明](#详细功能说明)
5. [配置说明](#配置说明)
6. [API接口](#api接口)

---

## 系统概述

旺商聊机器人主框架是一个基于 .NET Framework 4.7.2 开发的 Windows Forms 桌面应用程序，主要用于旺商聊聊天群的自动化管理，包括：
- 彩票下注处理与结算
- 上下分管理
- 自动回复
- 群管理功能

### 架构说明
- **主框架 (WangShangLiaoBot)**: 处理核心业务逻辑、用户界面、配置管理
- **副框架 (WSLFramework)**: 处理底层通信、CDP 连接、消息收发

两个框架通过 **HPSocket** TCP 通信（端口 14746）进行数据交换。

---

## 主框架功能模块

### 1. 开奖服务 (LotteryService)
| 功能 | 说明 |
|------|------|
| 自动获取开奖 | 从 bcapi.cn 获取加拿大28等彩种开奖结果 |
| 倒计时管理 | 精确管理每期倒计时，支持高频模式(开奖前30秒) |
| 历史记录 | 保存最近100期开奖历史 |
| 手动校正 | 支持手动设置开奖号码和倒计时 |
| 多接口支持 | 支持主备接口自动切换 |

**支持彩种：**
- PC蛋蛋/加拿大28 (3.5分钟/期)
- 比特28 (1分钟/期)
- 北京28 (5分钟/期)

### 2. 下注系统 (Betting)

#### 2.1 下注解析 (BetMessageParser)
支持多种下注格式：

| 玩法类型 | 支持格式示例 |
|----------|-------------|
| 大小单双 | `大100`, `XD50`, `dad100`, `大单200` |
| 对子/顺子/豹子 | `对子100`, `DZ50`, `顺子30`, `豹子20` |
| 组合 | `组合50`, `ZH100` |
| 极数 | `极大100`, `JD50`, `极小30` |
| 数字特码 | `操13/100`, `草14 50`, `点27/30`, `T13 50` |
| 龙虎 | `龙100`, `虎50`, `和30` |
| 尾球 | `尾大50`, `尾小30`, `尾单20`, `尾双10` |
| 边中 | `大边100`, `小边50`, `中30` |
| 半顺/杂六 | `半顺50`, `杂30` |

#### 2.2 赔率服务 (OddsService)
| 配置项 | 说明 |
|--------|------|
| 基础赔率 | 大小单双赔率 (默认1.8) |
| 组合赔率 | 大单/大双/小单/小双 (默认1.2) |
| 特殊玩法 | 对子、顺子、豹子、半顺、杂六各自赔率 |
| 数字赔率 | 0-27每个数字可单独配置 |
| 下注限额 | 每种玩法最小/最大限额 |
| 极值设置 | 极大(22-27)、极小(0-5)范围配置 |

#### 2.3 结算服务 (BetSettlementService)

**核心功能：**
- 自动根据开奖结果计算中奖
- 支持多种特殊规则配置
- 自动更新玩家余额
- 生成结算记录和账单

**支持的玩法结算：**
| 玩法类型 | 中奖判定 |
|----------|---------|
| 大小单双(Dxds) | DD/DS/XD/XS 组合匹配 |
| 大小(BigSmall) | sum≥14为大，<14为小 |
| 单双(OddEven) | sum%2==1为单，0为双 |
| 对子(Pair) | 两数相同 |
| 顺子(Straight) | 三数连续 |
| 豹子(Leopard) | 三数相同 |
| 半顺(HalfStraight) | 两数连续 |
| 杂六(Mixed) | 非豹/顺/对/半顺 |
| 数字(Digit) | 精确匹配和值 |
| 极数(Extreme) | 极大22-27/极小0-5 |
| 龙虎(DragonTiger) | 按区域或号码列表判断 |
| 三军(ThreeArmy) | 单个数字出现次数 |
| 边(Edge) | 大边≥22/小边≤5 |
| 尾球(Tail) | 和值个位数判断 |

**特殊规则配置：**
| 规则 | 说明 |
|------|------|
| 豹子通杀 | 开豹子所有玩家全输 |
| 对子回本 | 开对子返还本金 |
| 顺子回本 | 开顺子返还本金 |
| 豹子回本 | 开豹子返还本金 |
| 龙虎开和回本 | 开和龙虎下注回本 |
| 豹子通杀龙虎和 | 开豹子龙虎和全输 |

#### 2.4 自动结算服务 (AutoSettlementService)

**处理流程：**
1. 获取该期所有下注记录
2. 发送开奖消息
3. 计算每个玩家的盈亏
4. 结算到玩家账户
5. 生成账单汇总
6. 发送账单消息
7. 触发结算完成事件
8. 清理下注记录

**账单数据结构：**
```
BillSummary {
    Period        // 期号
    TeamId        // 群号
    LotteryResult // 开奖结果
    PlayerCount   // 玩家数量
    TotalBet      // 总下注
    TotalPayout   // 总派彩
    HouseProfit   // 庄家盈利
    PlayerSettlements // 玩家结算列表
}
```

### 3. 上下分管理 (ScoreService)

| 功能 | 说明 |
|------|------|
| 上分 | 增加玩家余额，记录交易流水 |
| 下分 | 减少玩家余额，支持余额不足检查 |
| 查余额 | 查询玩家当前余额 |
| 今日统计 | 统计玩家今日上分、下分、下注、中奖金额 |
| 回水计算 | 自动计算并发放回水 |

**上分关键字配置：** `查|c|。` (可自定义)
**下分关键字配置：** `回` (可自定义)

### 4. 自动回复服务 (AutoReplyService)

#### 4.1 关键词回复
支持配置多组关键词-回复规则，格式：`关键词1|关键词2` → `回复内容`

#### 4.2 预设模板
| 模板类型 | 默认关键词 |
|----------|-----------|
| 财付通 | `财富|发财富|财付通|发财付通|cft...` |
| 支付宝 | `支付|支付宝|发支付宝|zfb...` |
| 微信 | `微信|发微信|微信多少|微信号` |

#### 4.3 内部回复
| 场景 | 配置项 |
|------|--------|
| 个人数据查询 | 账单0分、有分无攻击、有分有攻击 |
| 进群/群规 | 触发关键词和回复内容 |
| 下注显示 | 下注后的提示消息 |
| 上下分回复 | 次数不足、余额过低等提示 |

### 5. 封盘服务 (SealingService)

| 功能 | 说明 |
|------|------|
| 倒计时提醒 | 封盘前40秒、20秒提醒 |
| 封盘线发送 | 自动发送封盘线消息 |
| 自动禁言 | 封盘时自动禁言群成员 |
| 规则发送 | 开奖前发送注意事项 |
| 核对消息 | 封盘后10秒发送核对 |
| 卡奖提示 | 封盘后20秒发送卡奖提示 |

**消息发送顺序：**
1. 封盘前40秒 → 40秒提醒
2. 封盘前20秒 → 20秒提醒
3. 封盘时刻 → 封盘线 + 禁言
4. 封盘后10秒 → 核对消息
5. 封盘后20秒 → 卡奖提示

### 6. 托管服务 (TrusteeService)

| 功能 | 说明 |
|------|------|
| 分段策略 | 根据余额自动选择下注内容 |
| 自动下注 | 按配置的策略自动执行下注 |
| 止盈止损 | 达到条件自动停止托管 |

### 7. 回水服务 (RebateService)

#### 回水模式

| 模式 | 说明 |
|------|------|
| 模式0 | 按组合比例计算回水 |
| 模式1 | 按下注次数累计回水 |
| 模式2 | 按下注流水比例回水 |
| 模式3 | 按输分金额回水 |

#### 回水配置

| 配置项 | 说明 |
|--------|------|
| Mode | 回水计算模式 |
| DefaultPercent | 默认回水比例 |
| MinBetCount | 最小下注次数 |
| ExcludeMultiCombo | 排除多组合 |
| ExcludeKillCombo | 排除杀组合 |
| ReturnTurnoverPercent | 返还流水百分比 |

#### 阶梯配置

支持多级阶梯回水配置：
| 阶梯 | 流水范围 | 回水比例 |
|------|----------|---------|
| Tier1 | Min-Max | Percent |
| Tier2 | Min-Max | Percent |
| ... | ... | ... |

### 8. 托号服务 (ShillService)

| 功能 | 说明 |
|------|------|
| 托号管理 | 添加/删除托号列表 |
| 托查钱自动上分 | 托号查询时自动上分 |
| 托回钱自动下分 | 托号请求下分时自动处理 |
| 自动同意进群 | 托号申请入群自动同意 |
| 远程账单获取 | 托插件远程获取账单 |

### 9. 猜数字游戏服务 (GuessNumberService)

| 功能 | 说明 |
|------|------|
| 猜数字 | 玩家猜下期和值(0-27)，猜中送分 |
| 禁猜数字 | 可设置不可猜的数字(默认13、14) |
| 每期限猜 | 每期最多猜测次数(默认3次) |
| 触发关键词 | 猜测触发词(默认"猜") |
| 显示中奖 | 开奖后是否显示猜中玩家 |

**奖励阶梯配置示例：**
| 余额阈值 | 奖励金额 |
|----------|---------|
| ≥5000 | 588 |
| ≥1000 | 188 |
| ≥500 | 20 |
| ≥100 | 8 |

### 10. 夜宵/流水返点服务 (BonusService)

#### 夜宵奖励 (按把数)
| 流水范围 | 最小把数 | 奖励 |
|----------|---------|------|
| 30001-50000 | 30把 | 2888 |
| 50001-100000 | 50把 | 5888 |
| 100001-500000 | 100把 | 8888 |

#### 夜宵奖励 (按输赢)
| 赢/输金额 | 奖励 |
|-----------|------|
| 赢≥280000 | 888 |
| 赢≥500000 | 1888 |
| 输≥280000 | 888 |
| 输≥500000 | 1888 |

#### 流水返点
| 流水阈值 | 返点比例 |
|----------|---------|
| ≥100000 | 1.5% |
| ≥50000 | 1.0% |
| ≥10000 | 0.5% |

**返点触发关键词**: `反水`, `返水`, `回水`

### 11. 长龙减赔服务 (DragonReduceService)

当某个结果连续开出时，自动减少该结果的赔率。

| 连开次数 | 减赔幅度 |
|----------|---------|
| ≥3次 | -0.1 |
| ≥6次 | -0.2 |
| ≥9次 | -0.3 |
| ≥12次 | -0.4 |

**跟踪类别：** 大小、单双、组合(大单/大双/小单/小双)

### 12. 刷屏检测 (SpeechDetectionService)

### 13. 刷屏检测 (SpeechDetectionService)

| 检测规则 | 说明 | 默认值 |
|----------|------|--------|
| 禁言字数限制 | 超过字数触发禁言 | 100字 |
| 踢人字数限制 | 超过字数直接踢出 | 200字 |
| 禁言行数限制 | 超过行数触发禁言 | 10行 |
| 图片禁言 | 发送图片触发禁言 | 启用 |
| 图片踢人次数 | 发图达到次数踢出 | 3次 |
| 禁言时长 | 违规禁言分钟数 | 10分钟 |
| 黑名单联动 | 被踢出自动加黑名单 | 启用 |
| 0分发言禁言 | 账单0分用户发言禁言 | 启用 |
| 自动撤回违规消息 | 检测到违规自动撤回 | 启用 |

**违规记录追踪：**
- 记录玩家违规次数和时间
- 累计违规达到阈值升级惩罚
- 支持手动清除违规记录

### 14. 锁名片服务 (CardLockService)

防止玩家频繁修改群名片。

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 启用 | 是否启用锁名片功能 | 是 |
| 最大修改次数 | 允许修改名片的最大次数 | 5次 |
| 超次数踢人 | 超过限制是否踢出 | 是 |
| 群内通知 | 是否在群内发送警告 | 是 |
| 自动重置名片 | 修改后自动恢复原名片 | 否 |
| 重置间隔 | 多久重置修改次数(分钟) | 1440分钟(24小时) |

**警告模板变量：**
- `[旺旺]` - 玩家昵称
- `[次数]` - 已修改次数
- `[剩余]` - 剩余修改机会
- `[限制]` - 最大限制次数

### 11. 进群欢迎服务 (WelcomeService)

#### 欢迎功能

| 功能 | 说明 |
|------|------|
| 私聊欢迎 | 新成员进群后私聊发送欢迎消息 |
| 群内欢迎 | 在群内@新成员欢迎 |
| 好友申请 | 自动同意好友申请 |
| 入群申请 | 账单/托管玩家自动同意入群 |

#### 配置项

| 配置项 | 说明 |
|--------|------|
| PrivateWelcomeEnabled | 启用私聊欢迎 |
| GroupWelcomeEnabled | 启用群内欢迎 |
| PrivateWelcomeMessage | 私聊欢迎内容 |
| GroupWelcomeMessage | 群内欢迎内容 |
| WelcomeSuffixNotSealed | 未封盘时后缀 |
| WelcomeSuffixSealed | 已封盘时后缀 |
| AutoAcceptFriend | 自动同意好友 |
| AutoAcceptJoinFromBill | 账单玩家自动同意入群 |
| AutoAcceptJoinFromTrustee | 托管玩家自动同意入群 |
| WelcomeDelayMs | 欢迎消息延迟(毫秒) |

### 12. 垃圾检测服务 (SpamDetectionService)

#### 检测规则

| 检测项 | 说明 |
|--------|------|
| 字数限制 | 超过字数触发禁言/踢人 |
| 行数限制 | 超过行数触发禁言 |
| 图片/表情 | 数量过多触发惩罚 |
| 关键词规则 | 匹配敏感词触发操作 |
| 0分发言 | 账单0分用户发言禁言 |
| 管理员踢人监控 | 被管理员踢出自动加黑名单 |

#### 上分豁免

正则匹配 `上(?:分)?[\s]*\d+` 的消息会被豁免检测。

#### 功能特点

- 记录每个用户的违规图片/表情次数
- 定时检查被管理员踢出的成员
- 区分机器人踢人和管理员踢人
- 冷却时间防止重复处理

### 15. 管理员命令服务 (AdminCommandService)

#### 基础命令

| 命令 | 功能 | 权限 |
|------|------|------|
| `开机`/`关机` | 启动/停止机器人 | 管理员 |
| `换机器人` | 切换当前机器人账号 | 管理员 |

#### 查询命令

| 命令格式 | 功能 |
|----------|------|
| `今天数据=旺旺号` | 查询玩家今日统计 |
| `昨天数据=旺旺号` | 查询玩家昨日统计 |
| `今天下注=旺旺号` | 查询玩家今日下注记录 |
| `今天上下分=旺旺号` | 查询玩家今日上下分记录 |
| `今天艾特分=旺旺号` | 查询玩家今日艾特分记录 |
| `今天统计=旺旺号` | 查询盈亏和流水 |
| `今天百分比=旺旺号` | 查询盈利率百分比 |
| `日期至日期[类型]=旺旺号` | 日期范围查询 |
| `今天期盈利` | 查询今日每期盈利 |
| `今天盈利` | 查询今日总盈利统计 |

#### 管理命令

| 命令格式 | 功能 |
|----------|------|
| `加黑名单旺旺号` | 添加玩家到黑名单 |
| `减黑名单旺旺号` | 从黑名单移除玩家 |
| `改名旺旺号=新名片` | 修改玩家昵称 |
| `旺旺号+分数理由` | 手动上分 |
| `旺旺号-分数理由` | 手动下分 |
| `旺旺号=分数理由` | 设置分数 |
| `查询邀请旺旺号` | 查询玩家邀请了谁 |
| `查询被邀请旺旺号` | 查询玩家被谁邀请 |

#### 艾特命令 (群聊)

| 命令格式 | 功能 |
|----------|------|
| `@旺旺号+分数` | 艾特加分 |
| `@旺旺号-分数` | 艾特减分 |
| `@旺旺号金额到` | 分数到账确认 |
| `@旺旺号金额查` | 查询分数 |
| `@旺旺号改名=新名` | 艾特改名 |
| `@旺旺号加黑名单` | 艾特加黑名单 |
| `@旺旺号踢` | 艾特踢人 |
| `@旺旺号禁言` | 艾特禁言 |
| `@旺旺号解禁` | 艾特解禁 |

#### 私聊上下分处理

| 命令 | 功能 |
|------|------|
| `查看上分` | 查看待处理上分请求 |
| `查看下分` | 查看待处理下分请求 |
| `到的[N]` | 确认前N条上分到账 |
| `全到` | 确认所有上分到账 |
| `没到[N]` | 取消前N条上分 |
| `回钱[N]` | 确认前N条下分已回 |
| `全回` | 确认所有下分已回 |
| `拒绝[N]` | 拒绝前N条下分 |

**命令频率限制：** 每用户每60秒最多10次命令，防止恶意刷命令

### 16. 账号管理服务 (AccountService)

| 功能 | 说明 |
|------|------|
| 多账号管理 | 支持管理多个机器人账号 |
| 账号添加 | 添加新的机器人账号 |
| 账号删除 | 删除已有账号 |
| 账号复制 | 复制账号配置 |
| 自动登录 | 设置账号自动登录 |
| 状态管理 | 在线/离线状态管理 |

**账号信息结构：**
```
BotAccount {
    Id              // 账号ID
    Nickname        // 昵称
    WangWangId      // 旺旺号
    GroupId         // 绑定群号
    Phone           // 手机号
    Password        // 密码(加密)
    DebugPort       // CDP端口
    ExePath         // 客户端路径
    AutoLogin       // 自动登录
    Status          // 账号状态
    LastLoginTime   // 最后登录时间
}
```

### 17. 下注范围限制服务 (BetAttackRangeSettingsService)

为每种玩法类型配置最小/最大下注金额限制。

#### 下注限额配置

| 玩法分类 | 包含玩法 | 配置项 |
|----------|---------|--------|
| 单注 | 大小单双、组合 | SingleBetMin/Max |
| 对子 | 对子 | PairMin/Max |
| 顺子 | 顺子 | StraightMin/Max |
| 豹子 | 豹子 | LeopardMin/Max |
| 数字 | 0-27特码 | DigitMin/Max |
| 极数 | 极大/极小 | ExtremeMin/Max |
| 龙虎 | 龙/虎/和 | DragonTigerMin/Max |
| 半顺 | 半顺 | HalfStraightMin/Max |
| 杂六 | 杂六 | MixedMin/Max |
| 三军 | 三军 | ThreeArmyMin/Max |
| 尾球 | 尾大小单双/尾组合/尾数字 | TailXxxMin/Max |
| 边 | 大边/小边/边 | EdgeMin/Max |
| 总额 | 单次总下注 | TotalLimit |

**超范围提示模板：**
- 变量: `@qq`, `[下注内容]`, `[高低]`
- 示例: `@qq 您攻击的[下注内容]分数不能[高低],请及时修改攻击`

### 18. 图片生成服务 (ImageGeneratorService)

| 功能 | 说明 |
|------|------|
| 账单图片 | 将账单内容渲染为图片 |
| 下注数据图片 | 每期下注数据图片 |
| 开奖结果图片 | 开奖号码和结果图片 |

**图片配置：**
- 背景色/文字颜色可配置
- 自动计算图片尺寸
- 支持多行文本渲染
- 保存为临时PNG文件

### 19. 开奖延迟服务 (LotteryDelayService)

为不同彩种配置开奖延迟。

| 配置项 | 说明 |
|--------|------|
| DelayEnabled | 延迟开关 |
| IsCountdownMode | 延迟模式(倒计时/开奖) |
| PcEggDelay | PC蛋蛋延迟秒数 |
| CanadaDelay | 加拿大28延迟秒数 |
| BitDelay | 比特28延迟秒数 |
| BeijingDelay | 北京28延迟秒数 |
| AutoAdjustTimeEnabled | 自动调整时间开关 |
| AutoAdjustIntervalHours | 自动调整间隔(小时) |

### 20. 艾特分原因服务 (AtReasonService)

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| Reasons | 艾特加分原因列表 | 红包\|回水\|其他\|邀请 |
| PrivateChatNotifyInGroup | 私聊加分群内提醒 | 是 |
| PrivateChatAllowNoReason | 私聊加分允许无理由 | 是 |
| ActivityReasons | 活动分原因 | (空) |

### 21. 私聊托服务 (PrivateShillService)

私聊版托号自动下注系统。

| 配置项 | 说明 |
|--------|------|
| Enabled | 私聊版托开关 |
| AfterLotteryDelay | 开奖后N秒内不下注 |
| BeforeSealTime | 封盘前停止下注时间 |
| ShillListText | 托号列表(一行一个) |

**分段下注配置：**
| 余额范围 | 下注内容示例 |
|----------|-------------|
| 50-400 | `68x62xs|35xd65ds|da75dd25` |
| 401-800 | `30s110da|sz30dd91|85a95xs` |
| 801-1300 | `165xd85ds90da|dd138x155` |
| 1301-10000 | `xs190da270|200da230xd` |

**余额补充/回收配置：**
| 类型 | 阈值 | 消息 |
|------|------|------|
| 余额过低 | <100 | 发送查钱消息 |
| 余额过高 | >5999 | 发送全回消息 |

### 22. 配置同步管理器 (ConfigSyncManager)

主框架配置自动同步到副框架。

| 功能 | 说明 |
|------|------|
| 全量同步 | 同步全部配置到副框架 |
| 自动同步 | 配置变更时自动同步 |
| 同步内容 | 赔率、封盘、自动回复等 |

**同步配置项：**
- 基础配置 (群号、管理员)
- 赔率配置 (所有玩法赔率)
- 封盘配置 (时间、提醒)
- 自动回复规则
- 下注处理设置
- 特殊规则设置

### 23. 敏感操作服务 (SensitiveOperationService)

保护敏感操作需要密码验证。

| 功能 | 说明 |
|------|------|
| 密码设置 | 设置/修改敏感操作密码 |
| 密码验证 | 验证敏感操作密码 |
| 禁用密码 | 关闭密码保护 |

**密码存储：** SHA256哈希 + 盐值

### 24. 二七玩法服务 (TwoSevenService)

开奖号码为2或7时触发特殊赔率。

| 配置项 | 说明 |
|--------|------|
| Enabled | 二七玩法开关 |
| TwoSevenNumbers | 触发数字 (2, 7) |
| 特殊赔率 | 2/7时使用的赔率 |

### 25. 消息模板服务 (MessageTemplateService)

管理所有场景的消息模板。

#### 下注相关模板

| 模板名称 | 说明 |
|----------|------|
| 下注显示 | 下注成功提示 |
| 重复下注 | 重复下注提示 |
| 余粮不足 | 余额不足提示 |
| 攻击上分有效 | 上分后下注生效 |
| 超出范围 | 超出限额提示 |
| 取消下注 | 取消下注提示 |
| 模糊匹配提醒 | 模糊匹配提示 |
| 已封盘下注无效 | 封盘后下注提示 |

#### 托管相关模板

| 模板名称 | 说明 |
|----------|------|
| 托管成功 | 托管启用提示 |
| 取消托管 | 托管取消提示 |

#### 上下分相关模板

| 模板名称 | 说明 |
|----------|------|
| 上分到词 | 上分到账确认 |
| 上分没到词 | 上分未到提示 |
| 下分查分词 | 下分已回确认 |
| 下分拒绝词 | 下分拒绝提示 |
| 下分正在处理 | 处理中提示 |
| 下分最少下注次数 | 下注次数不足提示 |

#### 封盘相关模板

| 模板名称 | 说明 |
|----------|------|
| 封盘提示 | 封盘倒计时提醒 |
| 封盘内容 | 封盘线消息 |
| 发送规矩内容 | 卡奖提示 |

#### 开奖相关模板

| 模板名称 | 说明 |
|----------|------|
| 开奖发送 | 开奖结果格式 |
| 账单发送 | 账单格式 |

### 26. 发送消息替换服务 (SendMessageReplaceService)

在发送消息前进行关键词替换。

| 功能 | 说明 |
|------|------|
| 替换规则管理 | 添加/删除/清空规则 |
| 自动应用 | 发送前自动替换 |

**用途：** 规避敏感词检测、统一用语等

### 27. 管理命令替换服务 (AdminCommandReplaceService)

将自定义关键词映射到管理命令。

| 功能 | 说明 |
|------|------|
| 命令别名 | 设置命令别名 |
| 自动映射 | 收到消息自动转换为命令 |

### 28. 结算时间服务 (SettlementTimeService)

管理每日结算时间和数据查询。

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| SettlementTime | 每日结算时间 | 20:00:00 |
| PlayerQueryEnabled | 玩家查询开关 | 是 |
| PlayerQueryIntervalMinutes | 查询间隔 | 10分钟 |

**功能：**
- 判断当前是否已过结算时间
- 决定查询今天还是昨天的数据

### 17. 消息调度器 (MessageDispatcher)

负责分发和处理收到的消息，采用优先级队列处理。

| 组件 | 说明 |
|------|------|
| 消息队列 | 线程安全的FIFO队列 |
| 处理器链 | 按优先级排序的处理器列表 |
| 异步处理 | 后台线程循环处理消息 |

**内置处理器及优先级：**
| 处理器 | 优先级 | 功能 |
|--------|--------|------|
| SpeechDetectionHandler | 1000 | 发言检测(最高优先) |
| BetHandler | 100 | 下注处理 |
| ScoreHandler | 90 | 上下分处理 |
| TrusteeHandler | 60 | 托管处理 |
| GuessNumberHandler | 55 | 猜数字处理 |
| BonusHandler | 45 | 返点/夜宵处理 |
| AutoReplyHandler | 10 | 自动回复(最低优先) |

### 18. 下注账本服务 (BetLedgerService)

捕获群聊下注消息并持久化记录。

| 功能 | 说明 |
|------|------|
| 下注捕获 | 实时捕获群内下注消息 |
| 格式解析 | 调用BetMessageParser解析 |
| 账本记录 | 按日期/群/期号存储 |
| 内部回复 | 下注后自动回复确认消息 |
| 重复下注处理 | 4种处理模式可选 |

**重复下注处理模式：**
| 模式 | 说明 |
|------|------|
| 0 | 算成加注(不推荐) |
| 1 | 同注不算，不同等于加注 |
| 2 | 算最后一次下注(推荐) |
| 3 | 算第一次下注 |

**下注处理设置：**
| 配置项 | 说明 |
|--------|------|
| 接收群聊下注 | 是否接收群聊下注 |
| 启用好友私聊下注 | 是否接收私聊下注 |
| 只接群成员下注 | 私聊下注需为群成员 |
| 禁止取消下注 | 是否禁止取消 |
| 允许改注/加注 | 是否允许修改下注 |
| 仅支持拼音下注 | 是否限制使用拼音 |
| 无账单提醒 | 0分用户下注提醒 |
| 杀组合下注无效 | 同时押大小等无效 |
| 单注反下注无效 | 已有大又押小无效 |
| 组合数量限制 | 最大组合数限制 |
| 攻击范围超限 | 单注超过限额处理 |
| 总额封顶超限 | 总额超过限额处理 |
| 全局图片发送 | 账单以图片形式发送 |
| 秒顺回复 | 下注后私聊确认 |

### 19. 机器人主控制器 (BotController)

整合所有服务，提供统一的启动/停止接口。

| 功能 | 说明 |
|------|------|
| 服务整合 | 整合所有处理器和服务 |
| 事件绑定 | 绑定各服务的事件回调 |
| 启动/停止 | 一键启动/停止所有服务 |
| 开奖处理 | 处理开奖结果并触发结算 |
| 期号计算 | 自动计算当前期号 |

**事件流程：**
1. 连接旺商聊
2. 设置当前群
3. 启动消息调度器
4. 订阅消息接收事件
5. 计算当前期号
6. 启动封盘服务
7. 开始正常运行

### 20. 消息模板引擎 (TemplateEngine)

| 变量 | 说明 |
|------|------|
| `[昵称]` | 玩家昵称 |
| `[艾特]` | @玩家 |
| `[分数]` | 玩家余额 |
| `[余粮]` / `[留分]` | 玩家剩余分数 |
| `[期数]` | 当前期号 |
| `[封盘倒计时]` | 距离封盘秒数 |
| `[开奖历史]` | 最近开奖记录 |
| `[今天统计]` | 今日数据统计 |
| `[下注]` | 玩家下注内容 |
| `[换行]` | 换行符 |

---

## 副框架功能模块

副框架 (WSLFramework) 是核心通信和消息处理引擎，负责与旺商聊客户端的底层交互。

### 1. 框架服务端 (FrameworkServer)

| 功能 | 说明 |
|------|------|
| HPSocket PACK服务 | 基于HPSocket的TCP通信服务 |
| 主框架连接管理 | 处理主框架的连接、认证、消息转发 |
| ZCG协议处理 | 完整实现招财狗ZCG协议 |
| 消息广播 | 群消息、私聊消息实时转发 |
| 活跃群管理 | 设置和管理当前活跃群 |

**消息类型支持：**
- Login / Heartbeat / Logout
- SendMessage / ReceiveGroupMessage / ReceivePrivateMessage
- GetUserInfo / GetGroupList / GetGroupMembers
- MuteGroup / UnmuteGroup / StartAccounting / StopAccounting
- SyncOdds / SyncSealing / SyncAutoReply

### 2. CDP桥接服务 (CDPBridge)

| 功能 | 说明 |
|------|------|
| WebSocket连接 | 连接旺商聊客户端CDP调试端口 |
| 消息轮询 | 定时轮询localStorage获取新消息 |
| 加密消息解码 | 解码 type=100 自定义加密消息 (msg_attach.b) |
| 消息发送 | 通过DOM模拟发送群消息/私聊消息 |
| 用户信息获取 | 获取当前登录用户信息、NIM凭证 |
| 群信息获取 | 获取群列表、群成员、当前会话 |
| 群管理操作 | 全体禁言、成员禁言、踢人、修改群名片 |

**消息解码流程：**
1. 检测 type=100 自定义消息
2. 从 attach.b 字段提取Base64数据
3. URL安全Base64解码
4. 跳过16字节头部
5. UTF-8解码获取明文内容

### 3. 开奖周期管理器 (PeriodManager)

| 功能 | 说明 |
|------|------|
| 周期计算 | 基于ZCG协议的210秒周期计算 |
| 期号生成 | 自动计算当前期号 |
| 倒计时管理 | 精确倒计时到下次开奖 |
| 状态管理 | 下注中 / 已封盘 / 结算中 |
| 自动禁言 | 封盘时自动全体禁言 |

**周期常量：**
```
PERIOD_SECONDS = 210     // 每期210秒
CLOSE_BET_SECONDS = 30   // 封盘前30秒
WARNING_40_SECONDS = 40  // 40秒提醒
WARNING_20_SECONDS = 20  // 20秒提醒
```

**消息发送顺序 (完全匹配旧软件)：**
| 时间点 | 消息内容 |
|--------|---------|
| 封盘前40秒 | `--距离封盘时间还有40秒--\n改注加注带改 或者 加` |
| 封盘前20秒 | `--距离封盘时间还有20秒--` |
| 封盘时刻 | `==加封盘线==\n以上有钱的都接\n==庄显为准==` + 禁言 |
| 封盘后10秒 | `核对\n-------------------\n` |
| 封盘后20秒 | `本群如遇卡奖情况，十分钟官网没开奖，本期无效，无需纠结！！！！` |

### 4. 定时消息服务 (TimedMessageService)

| 功能 | 说明 |
|------|------|
| 倒计时提醒 | 40秒、30秒、20秒、10秒提醒 |
| 封盘通知 | 自动发送封盘线消息 |
| 开奖通知 | 新期开始提示 |
| 账单发送 | 开奖后发送完整账单 |
| 禁言/解禁 | 联动禁言解禁操作 |
| 定时消息 | 支持延迟发送和重复发送 |

**发送优先级：**
1. NIM SDK 直接发送 (优先)
2. CDP DOM模拟发送 (备用)

### 5. 群管理服务 (GroupManagementService)

| 功能 | 说明 |
|------|------|
| 全体禁言 | 开启/关闭全体禁言 |
| 成员禁言 | 指定成员禁言/解禁 |
| 群名片修改 | 修改成员群名片 |
| 踢出成员 | 将成员踢出群聊 |
| 状态同步 | 同步NIM群通知消息 |
| 成员获取 | 获取群成员列表 |

**群通知类型：**
- `NOTIFY_TYPE_GROUP_MUTE_1` = 禁言开启
- `NOTIFY_TYPE_GROUP_MUTE_0` = 禁言解除

### 6. 自动回复服务 (AutoReplyService)

| 功能 | 说明 |
|------|------|
| 关键字匹配 | 支持多关键字触发 |
| 精确匹配 | 完全匹配触发 |
| 正则匹配 | 正则表达式匹配 |
| 规则管理 | 添加/删除/启用/禁用规则 |
| 预设模板 | 内置余额、下注、上下分等回复模板 |

**预置关键字规则：**
| 规则名称 | 关键字 |
|----------|--------|
| 撤回通知 | 撤回、收回、撤销、撤单 |
| 支付宝收款 | 支付宝、zfb、ZFB、阿里 |
| 微信收款 | 微信、wx、WX、微信转账 |
| 财付通收款 | 财付通、qq钱包、QQ钱包 |
| 历史查询 | 历史、记录、账单、查账 |
| 余额查询 | 余额、分数、查分、查询 |
| 规则帮助 | 规则、玩法、帮助、说明 |

### 7. NIM服务 (NIMService)

| 功能 | 说明 |
|------|------|
| NIM SDK集成 | 网易云信SDK集成 |
| 消息发送 | 通过NIM SDK直接发送群消息 |
| 消息接收 | 接收NIM推送消息 |
| 登录状态 | 管理NIM登录状态 |

### 8. ZCG响应格式化 (ZCGResponseFormatter)

| 功能 | 说明 |
|------|------|
| 倒计时格式 | 标准倒计时消息格式 |
| 封盘线格式 | 封盘线消息格式 |
| 开奖结果格式 | 开奖号码显示格式 |
| 账单格式 | 完整账单和简化账单格式 |
| 上下分格式 | 上分/下分/余额查询格式 |
| 下注格式 | 下注成功/失败消息格式 |

### 9. ZCG数据存储 (ZCGDataStorage)

| 功能 | 说明 |
|------|------|
| 玩家数据 | 玩家余额、昵称、统计 |
| 托管数据 | 托管玩家配置 |
| 下注记录 | 每期下注记录 |
| 开奖历史 | 开奖结果历史 |

### 10. 账号管理服务 (BotLoginService)

| 功能 | 说明 |
|------|------|
| 账号列表 | 管理多个机器人账号 |
| 登录管理 | 登录/登出/切换账号 |
| CDP凭证获取 | 从旺商聊客户端提取NIM凭证 |
| 消息轮询 | 启动/停止消息轮询 |
| 群绑定 | 绑定活跃群号 |

### 11. 事件驱动系统 (EventDriven)

参考 Lagrange.Core 架构实现的事件驱动系统：

| 组件 | 说明 |
|------|------|
| WSLBotContext | 机器人上下文，管理所有服务和事件 |
| WSLEvents | 事件定义（消息、登录、群操作、开奖等） |
| WSLEventInvoker | 事件触发器 |
| WSLMessageSender | 消息发送器 |
| WSLBotFactory | 机器人工厂，创建Bot实例 |

---

## 详细功能说明

### 经典玩法设置

#### 大小单双超设置
| 配置项 | 说明 |
|--------|------|
| 数字设置 | 大小分界(如13/14) |
| 行1-4阶梯 | 不同金额区间赔率 |
| 算总注/算单注 | 计算方式选择 |

#### 豹/顺/对子设置
| 配置项 | 说明 |
|--------|------|
| 豹顺对开关 | 是否接受此类下注 |
| 对子回本 | 开对子返还本金 |
| 顺子回本 | 开顺子返还本金 |
| 豹子回本/通杀 | 豹子处理方式 |
| 半顺杂开关 | 是否支持半顺/杂六 |
| 890,910算顺子 | 边界顺子判定 |

#### 超无视设置
- 超过指定金额不记录超限
- 杀双多组对压不记超无视

### 尾球玩法
| 配置项 | 说明 |
|--------|------|
| 尾球开关 | 是否启用尾球玩法 |
| 尾大小单双赔率 | 尾数大小单双赔率 |
| 尾组合赔率 | 尾数组合赔率 |
| 尾特码赔率 | 尾数特码赔率 |
| 禁止点09 | 禁止投注尾数0和9 |

### 龙虎玩法
| 配置项 | 说明 |
|--------|------|
| 龙虎模式 | 龙虎斗 / 龙虎豹 |
| 区域比较 | 一区/二区/三区比较 |
| 开和回本 | 开和时处理方式 |
| 豹子通杀龙虎和 | 特殊规则 |

### 二七玩法
- 基于特定算法的玩法
- 单注/组合超阈值赔率设置

### 长龙玩法
- 连续出现相同结果降低赔率
- 支持多级阈值配置

---

## 配置说明

### 基本设置
| 配置项 | 说明 |
|--------|------|
| 我的旺商号 | 机器人账号 |
| 管理旺旺号 | 管理员账号(多个用`,`分隔) |
| 绑定群号 | 工作群号 |
| 旺商聊安装路径 | 客户端路径 |
| CDP调试端口 | 默认9222 |

### 账单设置
| 配置项 | 说明 |
|--------|------|
| 账单列数 | 4/5/6列显示 |
| 账单最小位数 | 金额显示位数 |
| 隐藏输光玩家 | 是否隐藏0分玩家 |
| 保留零分账单 | 是否保留0分记录 |
| 群作业发送 | 是否发送群作业 |

### 禁言核对设置
| 配置项 | 说明 |
|--------|------|
| 提前禁言秒数 | 封盘前多少秒禁言 |
| 下注数据延迟秒数 | 统计延迟 |
| 自动禁言 | 是否自动禁言 |

---

## API接口

### 与副框架通信消息类型
| 消息类型 | 说明 |
|----------|------|
| Login | 登录请求 |
| Heartbeat | 心跳保活 |
| SendMessage | 发送消息 |
| GetUserInfo | 获取用户信息 |
| GetGroupList | 获取群列表 |
| GetGroupMembers | 获取群成员 |
| MuteGroup | 群禁言 |
| UnmuteGroup | 解除禁言 |
| StartAccounting | 开始算账 |
| StopAccounting | 停止算账 |
| SyncOdds | 同步赔率配置 |
| SyncSealing | 同步封盘配置 |

### 开奖接口
- **接口地址**: `https://bcapi.cn/token/{token}/code/jnd28/rows/1.json`
- **请求限制**: 30秒内最多40次，单次间隔≥1秒
- **数据格式**: JSON

---

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| F10 | 隐藏主窗口 |
| F12 | 显示主窗口 |

---

## 数据存储

### 主框架数据目录 (DataService)

| 文件/目录 | 说明 |
|-----------|------|
| `config.xml` | 主配置文件 |
| `Data/数据库/` | 核心数据库目录 |
| `Data/收发日志/` | 消息收发日志 |
| `Data/运行日志/` | 程序运行日志 |
| `Data/玩家资料/` | 玩家详细信息 |
| `Data/群成员缓存/` | 群成员缓存 |
| `Data/图片/` | 图片资源目录 |
| `Data/备份/` | 数据备份目录 |
| `Data/设置.ini` | 扩展设置文件 |
| `Data/上下分.db` | 上下分记录数据库 |
| `Data/攻击.db` | 下注记录数据库 |
| `Data/账单.db` | 账单数据库 |

### 副框架数据目录

| 文件/目录 | 说明 |
|-----------|------|
| `zcg/accounts.json` | 机器人账号配置 |
| `zcg/config.json` | 运行配置 |
| `zcg/玩家数据/` | 玩家余额和统计 |
| `zcg/下注记录/` | 按日期/期号存储 |
| `zcg/开奖历史/` | 开奖结果历史 |
| `zcg/收发日志/` | 消息收发日志 |

### 配置文件详解

#### accounts.json 结构
```json
[
  {
    "Account": "机器人旺旺号",
    "PasswordEncrypted": "加密的密码",
    "BotName": "机器人昵称",
    "NimAccid": "NIM账号ID",
    "NimToken": "NIM Token",
    "GroupId": "绑定群号",
    "LastLogin": "最后登录时间"
  }
]
```

#### 玩家数据结构
```
Player {
    WangWangId      // 旺旺号
    Nickname        // 昵称
    Score           // 当前余额
    ReservedScore   // 预留分数
    BetCount        // 累计下注次数
    TodayBetCount   // 今日下注次数
    LastBetDate     // 最后下注日期
    TodayDeposit    // 今日上分
    TodayWithdraw   // 今日下分
    TodayWin        // 今日中奖
    TodayLose       // 今日亏损
    Remark          // 备注
}
```

---

## 聊天服务 (ChatService)

主框架与旺商聊应用通信的核心服务。

### 连接模式

| 模式 | 说明 |
|------|------|
| CDP模式 | 通过Chrome DevTools Protocol连接 |
| WebSocket模式 | 直接WebSocket通信 |
| Hook模式 | NIM SDK消息Hook |

### 核心功能

| 功能 | 说明 |
|------|------|
| 消息发送 | SendTextAsync/SendImageAsync |
| 消息接收 | OnMessageReceived事件 |
| 连接管理 | ConnectAsync/Disconnect |
| 群成员检查 | IsTeamMemberAsync |
| 昵称解密 | DecryptNickname (AES-256-CBC) |

### 消息轮询

| 配置项 | 说明 |
|--------|------|
| 轮询间隔 | 500ms (默认) |
| 消息去重 | 基于内容Hash防重复 |
| Hook轮询 | NIM SDK Hook消息轮询 |

### 昵称解密

旺商聊昵称使用AES-256-CBC加密：
- Key: `d6ba6647b7c43b79d0e42ceb2790e342`
- IV: `kgWRyiiODMjSCh0m`
- 字段: `nickname_ciphertext`

---

## 错误处理与日志

### 日志级别

| 级别 | 用途 |
|------|------|
| Info | 普通信息日志 |
| Warn | 警告信息 |
| Error | 错误信息 |
| Debug | 调试信息(开发模式) |

### 常见错误处理

| 错误类型 | 处理方式 |
|----------|---------|
| CDP连接失败 | 自动重试3次后切换备用模式 |
| 消息发送失败 | 记录日志并重试 |
| 开奖接口超时 | 切换备用接口 |
| NIM登录失败 | 回退到CDP模式 |

---

## 版本信息

### 主框架 (WangShangLiaoBot)
- **框架版本**: .NET Framework 4.7.2
- **通信库**: HPSocket.Net 6.0.7.1
- **开发语言**: C#
- **界面框架**: Windows Forms

### 副框架 (WSLFramework)
- **框架版本**: .NET Framework 4.7.2
- **通信库**: HPSocket.Net 6.0.7.1
- **CDP协议**: Chrome DevTools Protocol
- **NIM SDK**: NetEase IM SDK
- **协议**: ZCG招财狗协议

### 通信架构
```
┌─────────────────┐     HPSocket TCP     ┌─────────────────┐
│   主框架        │ ◄─────────────────► │   副框架        │
│ WangShangLiaoBot│     端口: 14746      │  WSLFramework   │
└─────────────────┘                      └────────┬────────┘
                                                  │
                                         CDP WebSocket
                                          端口: 9222
                                                  │
                                         ┌────────▼────────┐
                                         │   旺商聊客户端   │
                                         │   (Electron)    │
                                         └─────────────────┘
```

---

---

## 用户界面功能 (Forms)

### 主窗口 (MainForm)

主程序入口，包含所有功能的快捷入口。

| 功能区域 | 说明 |
|----------|------|
| 账号列表 | 显示所有机器人账号和状态 |
| 连接状态 | 显示副框架连接状态 |
| 开奖信息 | 当前期号、倒计时、开奖结果 |
| 快捷操作 | 开始算账、停止算账、发送消息 |
| 日志显示 | 实时显示运行日志 |

### 设置窗口 (SettingsForm)

包含所有配置选项的综合设置界面。

| 设置分类 | 包含内容 |
|----------|---------|
| 基本设置 | 账号、群号、路径 |
| 赔率设置 | 各玩法赔率配置 |
| 下注设置 | 下注规则、格式 |
| 封盘设置 | 封盘时间、提醒 |
| 回复设置 | 关键词、模板 |
| 高级设置 | 特殊规则 |

### 账单设置窗口 (BillSettingsForm)

| 设置分类 | 配置项 |
|----------|--------|
| 开奖发送 | 开奖通知、带8通知、图片发送 |
| 账单格式 | 列数、图片发送、二次回复 |
| 群作业 | 发送开关、隐藏输光玩家、保留零分 |
| 禁言核对 | 提前禁言秒数、数据延迟 |
| 消息反馈 | 反馈旺旺号、反馈群号、反馈类型 |

### 上下分窗口 (ScoreForm)

| 功能 | 说明 |
|------|------|
| 玩家列表 | 显示所有玩家及余额 |
| 上分操作 | 快捷上分 |
| 下分操作 | 快捷下分 |
| 待处理列表 | 显示待处理的上下分请求 |
| 历史记录 | 查看上下分历史 |

### 封盘设置窗口 (SealSettingsForm)

| 配置项 | 说明 |
|--------|------|
| 彩种选择 | 选择当前彩种 |
| 开奖间隔 | 每期开奖间隔秒数 |
| 提醒时间 | 封盘前多少秒提醒 |
| 提醒内容 | 提醒消息模板 |
| 封盘时间 | 封盘前多少秒封盘 |
| 封盘内容 | 封盘消息模板 |
| 规则发送 | 是否发送规则 |
| 自动禁言 | 是否自动禁言 |

### 账单导出窗口 (BillExportForm)

| 功能 | 说明 |
|------|------|
| 导出账单 | 导出当前账单为文本 |
| 导入账单 | 从文本导入账单 |
| 清空文本 | 清空编辑区 |
| 加入文本 | 添加到现有账单 |
| 分析其他机器昵称账单 | 兼容其他机器人格式 |
| 分析昵称账单 | 按昵称分析账单 |

### 账号列表窗口 (AccountListForm)

| 功能 | 说明 |
|------|------|
| 账号列表 | 显示所有机器人账号 |
| 添加账号 | 添加新账号 |
| 删除账号 | 删除选中账号 |
| 复制账号 | 复制账号配置 |
| 编辑账号 | 修改账号信息 |
| 自动登录 | 设置自动登录 |

### 私聊托窗口 (PrivateShillForm)

| 功能区域 | 说明 |
|----------|------|
| 托号列表 | 托号管理 |
| 分段配置 | 4档余额分段下注配置 |
| 时间设置 | 开奖后延迟、封盘前停止 |
| 余额控制 | 过低补充、过高回收 |
| 速度设置 | 下注间隔控制 |

### HPSocket测试窗口 (HPSocketTestForm)

| 功能 | 说明 |
|------|------|
| 连接测试 | 测试与副框架连接 |
| 发送消息 | 测试发送消息 |
| 接收消息 | 显示接收到的消息 |
| 日志显示 | 通信日志 |

---

## 附录

### 支持的下注格式汇总

| 格式类型 | 示例 | 说明 |
|----------|------|------|
| 中文 | `大100`, `小单50` | 标准中文格式 |
| 拼音 | `da100`, `xd50` | 拼音缩写 |
| 英文缩写 | `D100`, `XD50` | 大写缩写 |
| 混合格式 | `大d100`, `Da小100` | 中英混合 |
| 特码格式 | `操13/100`, `草14 50` | 数字特码 |
| 点号格式 | `点13.100`, `T13 50` | 点号分隔 |

### 常用模板变量速查

| 变量 | 说明 | 示例输出 |
|------|------|---------|
| `[昵称]` / `[旺旺]` | 玩家昵称 | 小明 |
| `[艾特]` | @玩家 | @小明 |
| `[分数]` / `[余粮]` | 当前余额 | 1000 |
| `[期数]` | 当前期号 | 2026011301 |
| `[开奖号码]` | 开奖结果 | 3+5+8=16 |
| `[封盘倒计时]` | 距离封盘秒数 | 30 |
| `[下注]` / `[攻击]` | 下注内容 | 大100 小50 |
| `[今日上分]` | 今日上分总额 | 5000 |
| `[今日下分]` | 今日下分总额 | 2000 |
| `[下注核对]` | 本期下注核对 | (多行文本) |
| `[中奖玩家]` | 本期中奖列表 | (多行文本) |
| `[换行]` | 换行符 | \n |

### 快速排障指南

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 无法连接旺商聊 | CDP端口未开放 | 检查是否以调试模式启动 |
| 消息发送失败 | 群号未绑定 | 检查绑定群号配置 |
| 开奖数据获取失败 | 接口限频 | 检查请求频率 |
| 下注无响应 | 已封盘 | 检查封盘状态 |
| 结算金额错误 | 赔率配置问题 | 检查赔率设置 |
| 禁言失败 | 无管理员权限 | 检查机器人群权限 |

---

*文档版本: v3.0*
*更新时间: 2026-01-13*
*包含模块数: 主框架39个 + 副框架14个 = 53个功能模块*
*用户界面: 8个主要窗口*
