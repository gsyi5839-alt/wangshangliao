# 旺商聊通信协议完整解析

> 深度逆向分析 - 连接协议、机器人协议、自动回复协议、群聊协议

---

## 一、连接协议

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                 你的程序 (Python/其他)                       │
│                         ↓                                   │
│         HPSocket TCP连接 → 127.0.0.1:14745                  │
│                         ↓                                   │
│                   xplugin.exe (框架)                        │
│                         ↓                                   │
│              621705120.exe (IM客户端)                       │
│                         ↓                                   │
│                    nim.dll (云信SDK)                        │
│                         ↓                                   │
│               网易云信服务器 (*.netease.im)                  │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 NIM SDK服务器

| 服务 | 地址 | 用途 |
|------|------|------|
| LBS | `lbs.netease.im` | 负载均衡，获取最优节点 |
| 长连接 | `link.netease.im` | 消息实时推送 |
| 文件 | `nos.netease.com` | 文件上传下载 |

### 1.3 登录协议

**登录步骤:**
```
login_step = 0  → 开始登录
login_step = 2  → 连接服务器中  
login_step = 3  → 登录成功
```

**登录成功回调:**
```json
{
    "err_code": 200,
    "login_step": 3,
    "relogin": false,
    "retrying": false
}
```

**通知框架登录结果:**
```json
{
    "id": "1628907626",      // NIM accid
    "ret": "登录成功！",
    "err_code": "200"
}
```

### 1.4 ID映射关系

| 类型 | 旺商聊ID | NIM ID | 说明 |
|------|----------|--------|------|
| 机器人号 | 621705120 | 1948408648 (accid) | 机器人账号 |
| 管理员 | 781361487 | 1628907626 (accid) | 管理账号 |
| 群号 | 3962369093 | 40821608989 (tid) | 群组ID |

---

## 二、消息接收协议

### 2.1 插件投递格式

框架收到消息后，按以下格式投递给插件:

```
机器人账号=621705120，主动账号=982576571，被动账号=3962369093，群号=3962369093，内容=1，消息ID=2739491805904148120，消息类型=1002，消息时间=1768107366074，消息子类型=0，原始消息={...JSON...}
```

**字段说明:**

| 字段 | 说明 | 示例 |
|------|------|------|
| 机器人账号 | 接收消息的机器人旺商聊号 | 621705120 |
| 主动账号 | 发送消息的用户旺商聊号 | 982576571 |
| 被动账号 | 被操作的用户（如@某人） | 3962369093 |
| 群号 | 消息所在群（私聊为空） | 3962369093 |
| 内容 | 解密后的消息文本 | 1 (下注内容) |
| 消息ID | 唯一消息标识 | 2739491805904148120 |
| 消息类型 | 固定1002表示群消息 | 1002 |
| 消息子类型 | 消息具体类型 | 0/NOTIFY_TYPE_* |

### 2.2 消息子类型

| 子类型 | 含义 |
|--------|------|
| `0` | 普通文本消息 |
| `NOTIFY_TYPE_GROUP_MUTE_0` | 群禁言解除 |
| `NOTIFY_TYPE_GROUP_MUTE_1` | 群禁言开启 |
| `NOTIFY_TYPE_USER_UPDATE_NAME` | 用户改名通知 |

### 2.3 原始消息JSON结构

```json
{
    "content": {
        "client_msg_id": "2ca1a3f1-88b8-49ad-99ce-15a7a6bf920d",
        "server_msg_id": 2739491805904148120,
        "time": 1768107366074,
        "from_id": "2092166259",           // 发送者NIM accid
        "from_nick": "加密的昵称MD5",
        "to_accid": "40821608989",         // 接收者(群tid)
        "to_type": 1,                       // 0=私聊, 1=群聊
        "talk_id": "40821608989",          // 会话ID
        "msg_type": 100,                   // 100=自定义消息
        "msg_attach": "{\"b\":\"...\"}",   // 加密的消息内容
        "from_client_type": 2              // 2=iOS, 16=Android, 32=服务端
    },
    "rescode": 200
}
```

### 2.4 消息内容解密

`msg_attach.b` 字段格式:
- 编码: URL安全Base64 (`-` → `+`, `_` → `/`)
- 格式: 前12字节为头部，后续为Protobuf编码的数据

**头部结构:**
```
字节 0-3:  魔数 (09 1A 49 1F)
字节 4-7:  版本标识 
字节 8-11: 消息类型前缀
字节 12+:  Protobuf编码的消息体
```

---

## 三、消息发送协议 (API调用)

### 3.1 API调用格式

```
API名称|参数1|参数2|...|返回结果:Base64编码
```

### 3.2 完整API列表

#### 3.2.1 发送群消息（文本）
```
发送群消息（文本）|机器人号|消息内容|群号|类型|子类型|返回结果:...
```
**参数:**
- 机器人号: 621705120
- 消息内容: 文本（支持\n换行）
- 群号: 3962369093
- 类型: 1（固定）
- 子类型: 0（固定）

**示例:**
```
发送群消息（文本）|621705120|核对\n-------------------\n|3962369093|1|0|返回结果:Dg15wK9Ua6C+fcRgZoN3NQ==
```

#### 3.2.2 发送好友消息
```
发送好友消息|机器人号|消息内容|目标旺商聊号|返回结果:...
```
**示例:**
```
发送好友消息|621705120|法拉(7813)\n攻擊慢了，攻擊要快，姿势要帅！\n未处理：82840376+10000\n作业做题已结束|781361487|返回结果:...
```

#### 3.2.3 群禁言/解禁
```
ww_群禁言解禁|机器人号|群号|操作|返回结果:...
```
**参数:**
- 操作: 1=开启禁言, 2=解除禁言

**示例:**
```
ww_群禁言解禁|621705120|3962369093|1|返回结果:iIEcyahRpLaUj9x+zriHjm1S4/uHjzwXxIvTKtsxAjWRDmEkKr+/mNOeaxfIZl28
```

#### 3.2.4 修改群名片
```
ww_改群名片|机器人号|群号|目标用户旺商聊号|新名片|返回结果:...
```
**示例:**
```
ww_改群名片|621705120|3962369093|982576571|桔子|返回结果:...
```

#### 3.2.5 获取群资料
```
ww_获取群资料|机器人号|群号|返回结果:...
```

#### 3.2.6 ID互查
```
ww_ID互查|机器人号|旺商聊号|返回结果:...
```
**说明:** 旺商聊号 ↔ NIM accid 相互查询

#### 3.2.7 获取在线账号
```
云信_获取在线账号|返回结果:...
```

#### 3.2.8 获取绑定群
```
取绑定群|机器人号|返回结果:...
```

---

## 四、框架通信协议 (HPSocket)

### 4.1 本地通信端口

配置文件: `zcg端口.ini`
```ini
[端口]
端口=14745
```

### 4.2 发送消息到框架

**格式:**
```json
{
    "msg": "{\"b\":\"加密的消息Base64\"}",
    "TYPE": "1",
    "id": "40821608989",
    "msgid": "e06a6f71-eead-11f0-9f53-a3225e568098"
}
```

| 字段 | 说明 |
|------|------|
| msg | 加密的消息内容JSON字符串 |
| TYPE | 消息类型: 1=群消息 |
| id | 目标群tid或用户accid |
| msgid | UUID格式的消息ID |

### 4.3 接收消息从框架

**NIM消息格式:**
```json
{
    "content": {
        "client_msg_id": "UUID",
        "from_id": "发送者accid",
        "to_accid": "接收者",
        "talk_id": "会话ID",
        "msg_type": 100,
        "msg_attach": "{\"b\":\"...\"}",
        "time": 1768109104083
    },
    "rescode": 200
}
```

---

## 五、ZCG收发协议

### 5.1 日志格式

文件: `zcg收发日志\*.log`

```
2026/1/11 12:47:55    
RQQ:621705120
群:3962369093
fromQQ:781361487
beingQQ:
备注：接收群消息
内容：
1
```

### 5.2 备注类型

| 备注 | 说明 | 方向 |
|------|------|------|
| 接收群消息 | 收到群消息 | 接收 |
| 接收好友消息 | 收到私聊 | 接收 |
| 发送群消息 | 发送群消息开始 | 发送 |
| 服务端_发送群消息，开始 | 开始处理 | 发送 |
| 服务端_发送群消息，完成 | 发送完成 | 发送 |
| 发送私聊消息 | 发送私聊开始 | 发送 |
| 服务端_发送私聊消息 | 私聊完成 | 发送 |
| 取QQ昵称 | 查询昵称 | 内部 |
| 取群类型 | 查询群信息 | 内部 |
| 开奖日志 | 开奖处理 | 内部 |

---

## 六、机器人回复协议

### 6.1 消息处理流程

```
1. 收到群消息 (插件投递)
      ↓
2. 解析消息内容
      ↓
3. 匹配关键词/下注格式
      ↓
4. 查询玩家数据 (数据库)
      ↓
5. 生成回复内容
      ↓
6. 调用 发送群消息（文本） API
      ↓
7. 记录日志
```

### 6.2 下注消息识别

**下注格式:** 数字 或 关键词+数字
```
1        → 下注1分
大100    → 下注大100分
小50     → 下注小50分
```

### 6.3 回复消息格式

**余额不足回复:**
```
[@781361487] (7813)
老板，您的账户余额不足！
当前余粮:0
```

**自动改名:**
```
法拉利(7813)群名片自动修改为：法拉
```

---

## 七、自动回复协议

### 7.1 定时任务

| 任务 | 触发条件 | 回复内容 |
|------|----------|----------|
| 封盘提醒 | 距封盘40秒 | `--距离封盘时间还有40秒--\n改注加注带改 或者 加` |
| 封盘通知 | 封盘时间到 | `==加封盘线==\n以上有钱的都接\n==庄显为准==` |
| 开奖通知 | 开奖时间 | `开:9+2+5=16 DAS 第3382933期` |
| 核对 | 开奖后 | `核对\n-------------------\n` |
| 卡奖提示 | 定时 | `本群如遇卡奖情况，十分钟官网没开奖，本期无效！！！！` |

### 7.2 开奖结果格式

```
開:9 + 2 + 5 = 16 DAS -- H
人數:0  總分:0
----------------------

----------------------
ls：03 17 18 17 13 06 09 12 21 16 
龙虎豹ls：L B L B H L L L L H 
尾球ls：2 8 3 5 5 4 0 4 8 5 
豹顺对历史：顺 -- -- -- -- -- -- 顺 -- -- 
```

### 7.3 群禁言控制

**开盘时解禁:**
```
ww_群禁言解禁|621705120|3962369093|2|...
```

**封盘时禁言:**
```
ww_群禁言解禁|621705120|3962369093|1|...
```

---

## 八、关键数据结构

### 8.1 NIM SDK核心函数

```c
// 初始化
int nim_client_init(const char* app_data_dir, const char* app_install_dir, const char* json_extension);

// 登录
void nim_client_login(const char* app_key, const char* json_login_info, const char* json_extension, nim_json_transport_cb_func cb, const void* user_data);

// 发送消息
void nim_talk_send_msg(const char* json_msg, const char* json_extension, nim_talk_ack_cb_func cb, const void* user_data);

// 注册接收回调
void nim_talk_reg_receive_cb(const char* json_extension, nim_talk_receive_cb_func cb, const void* user_data);
```

### 8.2 配置值编码

配置文件中的数值使用特殊编码:
```
原始值    →  编码值
真/开启   →  ACC920CB5D79B
假/关闭   →  C5F620CB5D79B
数字X     →  (X*10+20).toString(16) + "20CB5D79B"
```

---

## 九、协议总结

### 9.1 接入方式

**方式A: 对接xplugin框架 (推荐)**
1. TCP连接到 `127.0.0.1:14745`
2. 接收消息: JSON格式的NIM消息
3. 发送消息: 调用框架API

**方式B: 直接使用NIM SDK**
1. 加载 nim.dll
2. 调用 nim_client_init 初始化
3. 调用 nim_client_login 登录
4. 注册回调接收消息
5. 调用 nim_talk_send_msg 发送消息

### 9.2 核心协议列表

| 协议 | 用途 | 格式 |
|------|------|------|
| 插件投递 | 收消息 | `机器人账号=X，主动账号=Y，内容=Z，...` |
| 发送群消息 | 发消息 | `发送群消息（文本）|机器人号|内容|群号|1|0|` |
| 群禁言 | 控制禁言 | `ww_群禁言解禁|机器人号|群号|1或2|` |
| 改名片 | 修改名片 | `ww_改群名片|机器人号|群号|用户号|新名|` |
| 框架通信 | 底层 | `{msg:"...",TYPE:"1",id:"群tid",msgid:"UUID"}` |

---

*文档版本: 2.0*
*日期: 2026-01-11*
