# 桌面端开奖接口对接文档

## 一、获取开奖接口配置

桌面端启动后，需要从服务器获取开奖接口配置。

### 1.1 接口地址

```
GET https://bocail.com/api/client/lottery-apis
```

### 1.2 请求头

无需认证，公开接口。

### 1.3 返回示例

```json
{
  "ok": true,
  "data": [
    {
      "id": 1,
      "name": "加拿大28",
      "code": "jnd28",
      "token": "314e1914d84711f091245baa515fd558",
      "api_url": "https://bcapi.cn/token/{token}/code/{code}/rows/{rows}.{format}",
      "backup_url": "https://vip.bcapi.cn:2096/token/{token}/code/{code}/rows/{rows}.{format}",
      "format_type": "json",
      "callback_name": "jsonpReturn",
      "rows_count": 1,
      "request_interval": 1000,
      "max_requests_per_30s": 40
    }
  ]
}
```

### 1.4 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | number | 接口ID |
| `name` | string | 接口名称（显示用） |
| `code` | string | 彩票代码，如 `jnd28` |
| `token` | string | API访问令牌 |
| `api_url` | string | 主接口URL模板 |
| `backup_url` | string | 备用接口URL模板（可为null） |
| `format_type` | string | 返回格式：`json` / `jsonp` / `xml` |
| `callback_name` | string | JSONP回调函数名（仅jsonp格式使用） |
| `rows_count` | number | 请求数据行数（1-20） |
| `request_interval` | number | 最小请求间隔（毫秒），**官方要求>=1000** |
| `max_requests_per_30s` | number | 30秒内最大请求次数，**官方限制<=40** |

---

## 二、构建开奖API请求URL

### 2.1 URL模板替换

将 `api_url` 中的占位符替换为实际值：

```
原始模板: https://bcapi.cn/token/{token}/code/{code}/rows/{rows}.{format}

替换后: https://bcapi.cn/token/314e1914d84711f091245baa515fd558/code/jnd28/rows/1.json
```

| 占位符 | 替换值 | 示例 |
|--------|--------|------|
| `{token}` | 配置中的 `token` | `314e1914d84711f091245baa515fd558` |
| `{code}` | 配置中的 `code` | `jnd28` |
| `{rows}` | 配置中的 `rows_count` | `1` |
| `{format}` | 配置中的 `format_type` | `json` |

### 2.2 C# 代码示例

```csharp
private string BuildApiUrl(LotteryApiConfig config, bool useBackup = false)
{
    var urlTemplate = useBackup && !string.IsNullOrEmpty(config.backup_url) 
        ? config.backup_url 
        : config.api_url;
    
    return urlTemplate
        .Replace("{token}", config.token)
        .Replace("{code}", config.code)
        .Replace("{rows}", config.rows_count.ToString())
        .Replace("{format}", config.format_type);
}
```

---

## 三、调用开奖API

### 3.1 请求方式

```
GET https://bcapi.cn/token/314e1914d84711f091245baa515fd558/code/jnd28/rows/1.json
```

### 3.2 请求头（重要！）

**必须设置安全的 User-Agent**，以下 User-Agent 会被封禁：
- `Go-http-client`
- `Apache-HttpClient`
- `Wget`
- `HTTrack`
- 等爬虫工具默认UA

**推荐设置：**
```
User-Agent: BocailBot/1.0 (Windows NT 10.0; Win64; x64)
```

### 3.3 返回数据格式

```json
{
  "rows": 1,
  "info": "数据由bcapi.cn收录，当前访问IP：xxx.xxx.xxx.xxx，服3，菠菜接口网v8.1.1，技术QQ：82279178，30秒内请求次数统计：1次（超40次将会封禁1分钟）",
  "code": "jnd28",
  "data": [
    {
      "expect": "3378346",
      "opencode": "4,3,6",
      "opentime": "2025-12-31 03:47:00"
    }
  ]
}
```

### 3.4 返回字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `rows` | number | 返回的数据行数 |
| `info` | string | 接口信息（含当前请求计数） |
| `code` | string | 彩票代码 |
| `data` | array | 开奖数据数组 |
| `data[].expect` | string | **期号** |
| `data[].opencode` | string | **开奖号码**，格式：`数字1,数字2,数字3` |
| `data[].opentime` | string | **开奖时间**，格式：`YYYY-MM-DD HH:mm:ss` |

### 3.5 解析开奖号码

```csharp
// opencode 格式: "4,3,6"
var numbers = opencode.Split(',');
int n1 = int.Parse(numbers[0]); // 4
int n2 = int.Parse(numbers[1]); // 3
int n3 = int.Parse(numbers[2]); // 6
int sum = n1 + n2 + n3;         // 13
```

---

## 四、请求限制（重要！）

### 4.1 官方限制

| 限制项 | 值 | 超限后果 |
|--------|-----|----------|
| **单次请求间隔** | ≥ 1秒 | 触发防火墙 |
| **30秒内最大请求** | ≤ 40次 | 封禁1分钟 |
| **10分钟内IP绑定** | 1个IP/Token | 多IP会冲突 |

### 4.2 请求频率控制代码

```csharp
private DateTime _lastRequestTime = DateTime.MinValue;
private int _requestsInLast30s = 0;
private DateTime _windowStart = DateTime.Now;

private bool CanMakeRequest(int intervalMs, int maxPer30s)
{
    var now = DateTime.Now;
    
    // 重置30秒窗口
    if ((now - _windowStart).TotalSeconds >= 30)
    {
        _requestsInLast30s = 0;
        _windowStart = now;
    }
    
    // 检查30秒限制
    if (_requestsInLast30s >= maxPer30s)
        return false;
    
    // 检查请求间隔（至少1秒）
    var elapsed = (now - _lastRequestTime).TotalMilliseconds;
    if (elapsed < Math.Max(intervalMs, 1000))
        return false;
    
    return true;
}

private void RecordRequest()
{
    _lastRequestTime = DateTime.Now;
    _requestsInLast30s++;
}
```

---

## 五、主备接口切换

### 5.1 切换逻辑

当主接口连续失败3次时，自动切换到备用接口：

```csharp
private int _consecutiveErrors = 0;
private bool _useBackupUrl = false;

private void OnRequestError()
{
    _consecutiveErrors++;
    
    if (_consecutiveErrors >= 3 && !string.IsNullOrEmpty(_config.backup_url))
    {
        _useBackupUrl = !_useBackupUrl;
        _consecutiveErrors = 0;
        
        Log($"切换到{(_useBackupUrl ? "备用" : "主")}接口");
    }
}

private void OnRequestSuccess()
{
    _consecutiveErrors = 0;
}
```

### 5.2 接口地址

| 类型 | 地址 |
|------|------|
| 主接口 | `https://bcapi.cn/token/{token}/code/{code}/rows/{rows}.{format}` |
| 备用接口 | `https://vip.bcapi.cn:2096/token/{token}/code/{code}/rows/{rows}.{format}` |

---

## 六、完整C#对接示例

```csharp
public class LotteryApiConfig
{
    public long id { get; set; }
    public string name { get; set; }
    public string code { get; set; }
    public string token { get; set; }
    public string api_url { get; set; }
    public string backup_url { get; set; }
    public string format_type { get; set; }
    public int rows_count { get; set; }
    public int request_interval { get; set; }
    public int max_requests_per_30s { get; set; }
}

public class LotteryResult
{
    public string expect { get; set; }     // 期号
    public string opencode { get; set; }   // 开奖号码 "4,3,6"
    public string opentime { get; set; }   // 开奖时间
}

public class LotteryApiResponse
{
    public int rows { get; set; }
    public string info { get; set; }
    public string code { get; set; }
    public List<LotteryResult> data { get; set; }
}

// 获取配置
public async Task<List<LotteryApiConfig>> GetLotteryApisAsync()
{
    using (var client = new HttpClient())
    {
        var response = await client.GetStringAsync("https://bocail.com/api/client/lottery-apis");
        var result = JsonConvert.DeserializeObject<ApiResponse<List<LotteryApiConfig>>>(response);
        return result.data;
    }
}

// 获取开奖数据
public async Task<LotteryResult> FetchLotteryResultAsync(LotteryApiConfig config)
{
    if (!CanMakeRequest(config.request_interval, config.max_requests_per_30s))
        return null;
    
    var url = BuildApiUrl(config, _useBackupUrl);
    
    using (var client = new HttpClient())
    {
        client.DefaultRequestHeaders.Add("User-Agent", "BocailBot/1.0 (Windows NT 10.0)");
        
        try
        {
            RecordRequest();
            var response = await client.GetStringAsync(url);
            var data = JsonConvert.DeserializeObject<LotteryApiResponse>(response);
            
            OnRequestSuccess();
            return data?.data?.FirstOrDefault();
        }
        catch (Exception ex)
        {
            OnRequestError();
            throw;
        }
    }
}
```

---

## 七、测试验证

### 7.1 测试获取配置

```bash
curl -s "https://bocail.com/api/client/lottery-apis" | python3 -m json.tool
```

### 7.2 测试开奖API

```bash
curl -s "https://bcapi.cn/token/314e1914d84711f091245baa515fd558/code/jnd28/rows/1.json" \
  -H "User-Agent: BocailBot/1.0" | python3 -m json.tool
```

### 7.3 预期返回

```json
{
  "rows": 1,
  "code": "jnd28",
  "data": [
    {
      "expect": "3378346",
      "opencode": "4,3,6",
      "opentime": "2025-12-31 03:47:00"
    }
  ]
}
```

---

## 八、常见问题

### Q1: 请求被封禁怎么办？
A: 停止请求10分钟后自动解绑IP，然后降低请求频率。

### Q2: 返回数据为空？
A: 检查token是否正确，是否已过期。

### Q3: 如何获取历史数据？
A: 修改 `rows_count` 为 1-20，可获取最近1-20期数据。

---

**文档版本**: 1.0.0  
**更新时间**: 2025-12-31  
**技术支持**: 管理后台 → 彩票接口管理

