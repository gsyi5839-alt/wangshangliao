# 招财狗框架 v25.12.11 完整逆向分析文档

## 一、系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          招财狗框架系统架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────┐        ┌─────────────┐        ┌─────────────┐            │
│   │ zc25.12.11  │        │   zcg.exe   │        │xplugin.exe  │            │
│   │  (主框架)    │◄──────►│  (服务端)    │◄──────►│ (插件系统)   │            │
│   │  UI界面     │ HP     │  PACK模式   │  TCP   │  扩展功能    │            │
│   └──────┬──────┘ Socket └──────┬──────┘        └─────────────┘            │
│          │                       │                                          │
│          │                       ▼                                          │
│          │             ┌─────────────────┐                                  │
│          │             │ YX_Client.dll   │                                  │
│          │             │ (云信SDK封装)    │                                  │
│          │             │ + nim.dll       │                                  │
│          │             └────────┬────────┘                                  │
│          │                      │                                          │
│          │                      ▼                                          │
│          │             ┌─────────────────┐                                  │
│          └────────────►│    旺商聊服务器  │                                  │
│                        │   (网易云信)     │                                  │
│                        └─────────────────┘                                  │
│                                                                              │
│   数据存储:                                                                   │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│   │  设置.db    │  │  攻击.db    │  │ 上下分.db   │  │  账单.db    │       │
│   │  (配置)     │  │  (下注记录)  │  │ (积分管理)  │  │ (结算记录)  │       │
│   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 二、核心文件清单

### 2.1 可执行文件
| 文件 | 功能 | 说明 |
|------|------|------|
| `zc25.12.11.exe` | 主框架界面 | 招财狗4.29版主程序，GUI界面 |
| `zcg.exe` | 服务端 | 后台服务，处理消息和下注 |
| `xplugin.exe` | 插件系统 | 加载外部插件扩展功能 |
| `621705120.exe` | 云信客户端 | 每个账号一个实例 |

### 2.2 核心DLL
| 文件 | 功能 |
|------|------|
| `HPSocket4C.dll` | HP-Socket高性能网络库 (PACK模式) |
| `HPSocket4C_2.dll` | HP-Socket备用版本 |
| `YX_Client.dll` | 网易云信SDK封装 |
| `nim.dll` | 网易云信核心库 |
| `Module.dll` | 功能模块库 |
| `xplugin.dll` | 插件系统核心 |
| `sqlite3.dll` | SQLite数据库引擎 |

### 2.3 数据库文件 (SQLite)
| 文件 | 存储内容 |
|------|----------|
| `设置.db` | 系统配置、赔率、规则 |
| `攻击.db` | 下注记录(攻击=下注术语) |
| `上下分.db` | 玩家积分管理 |
| `账单.db` | 每期结算账单 |
| `玩家姓名.db` | 玩家昵称映射 |
| `邀请记录.db` | 入群邀请记录 |
| `数据库/2026年1月11日.db` | 每日数据备份 |

## 三、通信协议分析

### 3.1 HPSocket PACK模式
```
端口: 14745
PackHeaderFlag: 0xFF
MaxPackSize: 0x100000 (1MB)

消息格式:
┌──────────┬──────────┬────────────────┐
│ 包头标识  │ 数据长度  │     JSON数据    │
│  0xFF    │  4字节   │    变长内容     │
└──────────┴──────────┴────────────────┘
```

### 3.2 云信消息类型
从日志分析出的消息类型：

| 类型码 | 类型名 | 说明 |
|--------|--------|------|
| 1001 | 私聊消息 | P2P私聊 |
| 1002 | 群消息 | 群聊消息 |
| 1003 | 关系变动 | 好友/群成员变化 |
| NOTIFY_TYPE_GROUP_MUTE_0 | 解除禁言 | 开放下注 |
| NOTIFY_TYPE_GROUP_MUTE_1 | 开启禁言 | 封盘 |
| NOTIFY_TYPE_USER_UPDATE_NAME | 昵称更新 | 群成员改名 |

### 3.3 群信息JSON格式
```json
{
  "code": 0,
  "msg": "OK",
  "data": {
    "groupName": "群名称",
    "groupAvatar": "8671447222758755297",
    "groupNickName": "群内昵称",
    "groupCloudId": "40821608989",
    "ty": "COMMON",
    "groupId": 1176721,
    "groupAccount": "3962369093"
  }
}
```

## 四、核心功能模块

### 4.1 下注系统 (攻击系统)

#### 下注类型支持
```
基础玩法:
- 大(D) / 小(X) / 单(D) / 双(S)
- 大单(DD) / 大双(DS) / 小单(XD) / 小双(XS)
- 极大 / 极小

特殊玩法:
- 数字下注 (0-27)
- 豹子 (三数相同)
- 顺子 (三数连续)
- 半顺 (两数连续)
- 对子 (两数相同)
- 龙/虎

尾数玩法:
- 尾大/尾小/尾单/尾双
```

#### 下注消息格式
```
玩家发送: DD100       (大单100分)
系统回复: [@982576571] (9825)
         余粮不足，上分后录取：DAD100 

玩家发送: 上400       (上分400)
系统回复: 上分成功，当前余额...
```

#### 赔率配置 (从设置.ini解析)
```ini
[赔率]
数字=1.8        # 大小单双赔率
组合=3.8        # 大单/大双等组合
极大极小=11     # 极值玩法
豹子=59         # 豹子赔率
顺子=11         # 顺子赔率
对子=2          # 对子赔率
```

### 4.2 开奖与结算系统

#### 开奖消息格式
```
开:2+7+6=15 DAD 期3382923期

详细账单:
開:2 + 7 + 6 = 15 DAD -- L
人數:0  总分:0
----------------------

----------------------
ls：18 09 16 16 10 08 20 10 11 15 
大小单双ls：L L H H H B B H B L 
尾数ls：4 4 8 4 3 1 9 5 1 6 
对顺杂历史：-- 杂 杂 杂 -- -- -- -- -- -- 
```

#### 结算术语解析
- `L` = 小 (Low)
- `H` = 大 (High)
- `B` = 单 (Big Odd?)
- `DAD` = 大单大
- `DAS` = 大单双
- `XD` = 小单
- `SZ` = 顺子

### 4.3 上下分管理

#### 托管列表
从截图分析，支持：
- 添加托管账号
- 托查钱自动上分 (延迟5-10秒)
- 托回钱自动下分 (延迟10-20秒)
- 自动同意托加群

#### 上分/下分消息
```
上分请求: 82840376+10000
下分请求: 查500

系统私聊回复:
橘子(7813)
上分成功！祝您大吉大利！
余粮:XXX
```

### 4.4 群管理功能

- **自动改群名片**: 新用户入群自动设置昵称
- **全群禁言/解禁**: 封盘期间禁言
- **踢人功能**: 支持踢出违规用户
- **群成员缓存**: 本地缓存群成员信息

### 4.5 自动回复系统

支持关键词触发:
```ini
[自动回复]
支付宝关键词=支付,支付宝余额,余额支付...
微信关键词=微信,微信支付,wx支付...
历史关键词=历史,历史记录,历史开奖...
```

## 五、配置文件解析

### 5.1 config.ini (主配置)
```ini
[登录设置]
账号=621705120
jwtToken=DMKxsh...加密的JWT...
qun=iQEpb67flWe6pIT36InkpA==  # 加密的群ID
nickName=昵称
登录状态=1
自动登录=0

[xplugin]
插件名=是
开关=是
禁止=是

[nim]
版本=1
签场=0
```

### 5.2 设置.ini (功能设置)

主要配置项（值经过编码）：
```
选项框_操作图片发送
选项框_禁止自动上分
选项框_禁止自动下分
选项框_上分消息提示
选项框_下分消息提示
选项框_顺子890910
选项框_龙虎开关
选项框_尾数玩法开关
选项框_极大极小玩法开关
...
```

### 5.3 Plugin.ini (插件配置)
```ini
[Plugin]
46af1699a49d3b343ddf5c1f054e2eea=0           # 插件禁用
b8b077676bd7fd2972beaf9c1aa32b8e=1|zcg.dll   # 插件启用
```

## 六、日志分析

### 6.1 日志格式
```
时间    
RQQ:机器人QQ
群:群号
fromQQ:发送者
beingQQ:目标
日志类型
数据:
消息内容
```

### 6.2 关键日志类型
| 日志标识 | 含义 |
|----------|------|
| 消息_群聊 | 群消息接收 |
| 消息_私聊 | 私聊消息 |
| 发送群消息 | 发送到群 |
| 发送私聊消息 | 发送到个人 |
| 取QQ昵称 | 获取用户信息 |
| 设置群成员名片 | 修改群昵称 |
| 全群禁言 | 封盘操作 |
| 取群信息 | 获取群详情 |

### 6.3 游戏流程日志
```
1. 距离封盘时间还有40秒--下注期
2. ==加分规则== - 加分提示
3. 核对 - 下注确认
4. 全群禁言 - 封盘
5. 开:X+X+X=XX - 开奖
6. 账单发送 - 结算
7. 解除禁言 - 新一期开始
```

## 七、数据流图

```
玩家消息流程:
┌────────┐     ┌──────────┐     ┌─────────┐     ┌──────────┐
│  玩家  │────►│ 旺商聊群  │────►│ YX_Client│────►│  zcg.exe │
│        │     │          │     │  (云信)  │     │  (处理)  │
└────────┘     └──────────┘     └─────────┘     └────┬─────┘
                                                      │
                                                      ▼
┌────────┐     ┌──────────┐     ┌─────────┐     ┌──────────┐
│  玩家  │◄────│ 旺商聊群  │◄────│ YX_Client│◄────│  数据库   │
│        │     │          │     │  (云信)  │     │ (结算)   │
└────────┘     └──────────┘     └─────────┘     └──────────┘

开奖数据流程:
┌──────────┐     ┌──────────┐     ┌──────────┐
│ 开奖接口  │────►│  zcg.exe │────►│  数据库  │
│ (bcapi)  │     │  (拉取)  │     │ (存储)   │
└──────────┘     └─────┬────┘     └──────────┘
                       │
                       ▼
                 ┌──────────┐
                 │  结算引擎 │
                 │ (计算盈亏)│
                 └──────────┘
```

## 八、关键函数功能推测

### 8.1 消息处理
```
收到群消息 → 判断消息类型:
├── 下注消息 → 解析下注内容 → 检查余额 → 记录下注
├── 上分消息 → 解析金额 → 更新余额
├── 下分消息 → 解析金额 → 检查余额 → 处理提现
├── 查询消息 → 返回余额/历史
└── 其他消息 → 检查关键词 → 自动回复
```

### 8.2 开奖结算
```
定时拉取开奖 → 解析开奖号:
├── 计算和值
├── 判断大小单双
├── 判断特殊形态(豹子/顺子/对子)
├── 遍历下注记录
│   ├── 匹配中奖 → 计算派奖
│   └── 未中奖 → 扣除本金
├── 更新玩家余额
├── 生成账单
└── 发送开奖消息到群
```

## 九、安全与加密

### 9.1 配置加密
设置.ini中的值使用自定义编码：
- `20CB5D79B` 后缀看起来是校验码
- 前面的十六进制值是实际数据

### 9.2 通信加密
- JWT Token认证
- 群ID加密存储: `iQEpb67flWe6pIT36InkpA==` (Base64)
- 账号信息加密

## 十、UI界面分析 (从截图)

### 10.1 主框架窗口
```
┌─────────────────────────────────────────────┐
│  招财狗框架          Ver: zc25.12.11  [-][X]│
├─────────────────────────────────────────────┤
│ [运行日志] [账号列表] [系统设置]    [开始游戏]│
├─────────────────────────────────────────────┤
│ ID │ 时间        │ 响应   │ 类型  │ 消息    │
│ 124│ 01-11 13:00 │ 插件   │ 插件  │ 发送... │
│ ...│ ...         │ ...    │ ...   │ ...     │
└─────────────────────────────────────────────┘
```

### 10.2 托管设置窗口
```
┌─────────────────────────────────────────────┐
│ 招财狗4.29篇 [5] 次正常运行                   │
├─────────────────────────────────────────────┤
│ 客户管理 算账设置 封盘设置 回水工具 关于      │
├─────────────────────────────────────────────┤
│ 序 │ 托名单    │ □托查钱自动上分 延迟5-10秒 │
│ 1  │ 82840376  │ □托回钱自动下分 延迟10-20秒│
│    │           │ □自动同意托加群            │
└─────────────────────────────────────────────┘
```

### 10.3 上下分处理窗口
```
┌─────────────────────────────────────────────┐
│ 上下分处理 - F11可隐...                      │
├─────────────────────────────────────────────┤
│ 上分/下分  设置  设置2  提示文本             │
├─────────────────────────────────────────────┤
│ 上分管理                                     │
│ 橘子 (982576571)<12:50>                      │
│ 喊话内容: 查400                              │
│ 请求上分: 400          [修改上分]            │
│ [@喊到] [@喊没到] [忽略]                     │
├─────────────────────────────────────────────┤
│ 玩家     │ 昵称  │ 信息  │ 余粮 │ 次数      │
│ 982576571│ 橘子  │       │ 400  │ 0         │
│ 250416936│ 女拜  │       │ 1000 │ 0         │
└─────────────────────────────────────────────┘
```

## 十一、重建建议

如需重建此系统，需要：

### 11.1 技术栈
- **语言**: C++ 或 易语言 (原版可能是易语言)
- **网络库**: HP-Socket 5.x
- **即时通讯**: 网易云信SDK
- **数据库**: SQLite3
- **UI**: Win32 API 或 易语言组件

### 11.2 核心模块
1. **消息收发模块** - 对接云信SDK
2. **下注解析模块** - 识别各种下注格式
3. **结算引擎** - 计算中奖与派奖
4. **积分管理** - 上下分与余额
5. **定时任务** - 开奖拉取、自动结算
6. **群管理** - 禁言、改名片、踢人

### 11.3 关键数据表
```sql
-- 玩家表
CREATE TABLE players (
    id INTEGER PRIMARY KEY,
    qq VARCHAR(20) UNIQUE,
    nickname VARCHAR(50),
    balance DECIMAL(15,2) DEFAULT 0,
    total_bet DECIMAL(15,2) DEFAULT 0,
    total_win DECIMAL(15,2) DEFAULT 0,
    created_at DATETIME
);

-- 下注表
CREATE TABLE bets (
    id INTEGER PRIMARY KEY,
    period VARCHAR(20),
    player_qq VARCHAR(20),
    bet_type VARCHAR(20),
    bet_code VARCHAR(10),
    amount DECIMAL(15,2),
    odds DECIMAL(8,4),
    is_win BOOLEAN,
    profit DECIMAL(15,2),
    created_at DATETIME
);

-- 开奖表
CREATE TABLE results (
    id INTEGER PRIMARY KEY,
    period VARCHAR(20) UNIQUE,
    dice1 INTEGER,
    dice2 INTEGER,
    dice3 INTEGER,
    sum_value INTEGER,
    is_big BOOLEAN,
    is_odd BOOLEAN,
    special_type VARCHAR(20),
    created_at DATETIME
);
```

## 十二、网易云信协议详解

### 12.1 消息结构
从日志分析出的完整消息结构：
```json
{
  "content": {
    "client_msg_id": "uuid",
    "cloud_history": 1,
    "from_client_type": 2,        // 2=手机, 16=PC, 32=系统
    "from_device_id": "设备ID",
    "from_id": "发送者云信ID",     // 如 "2092166259"
    "from_nick": "发送者昵称hash",
    "is_force_push": 0,
    "log_status": 1,
    "msg_attach": "{\"b\":\"Base64加密内容\"}",
    "msg_body": "",
    "msg_sub_type": 0,
    "msg_type": 100,              // 100=自定义消息
    "offline_msg": 1,
    "push_enable": 1,
    "server_msg_id": 2739491805904148120,
    "talk_id": "40821608989",     // 群云信ID
    "time": 1768107366074,        // 毫秒时间戳
    "to_accid": "40821608989",
    "to_type": 1                  // 0=P2P, 1=群聊
  },
  "feature": 0,
  "rescode": 200
}
```

### 12.2 群通知类型
```
NOTIFY_TYPE_GROUP_MUTE_0    - 解除全群禁言 (封盘结束)
NOTIFY_TYPE_GROUP_MUTE_1    - 开启全群禁言 (开始封盘)
NOTIFY_TYPE_USER_UPDATE_NAME - 群成员改名
```

### 12.3 禁言通知详细结构
```json
{
  "data": {
    "name_cards": [
      {
        "accid": "1948408648",
        "ex": "{\"nickname_ciphertext\":\"mtmQz6FQ9lG6P3ZaOPXWrg==\"}",
        "gender": 0,
        "icon": "791610986162052788",
        "name": "d153f4e86e8c0eda3867e842e507cd93"
      }
    ],
    "team_info": {
      "mute_all": 1,              // 1=禁言, 0=解禁
      "mute_type": 1,
      "tid": "40821608989",
      "update_timetag": 1768107578933
    }
  },
  "id": 3
}
```

### 12.4 改名通知结构
```json
{
  "groupId": 1176721,
  "afterNickname": "橘子",
  "nicknameCiphertext": "EH/R1rUgtNPMlw+fSAIjQg=="
}
```

### 12.5 账号ID映射
```
旺商聊QQ号 → 云信accid映射:
621705120   → 1628907626
781361487   → 1948408648
982576571   → 2092166259
82840376    → 1391351554
250416936   → 1898203199

群号映射:
3962369093  → groupCloudId: 40821608989
            → groupId: 1176721
```

## 十三、启动参数分析

### 13.1 run.cmd 启动参数
```
xplugin.exe [加密参数串]
```
参数格式为 Base64-like 编码的授权信息，包含：
- 授权验证码
- 有效期信息
- 功能权限配置

### 13.2 账号登录流程
1. 读取 `config.ini` 获取 jwtToken
2. 使用 jwtToken 连接云信服务器
3. 获取群列表 (加密存储在 qun 字段)
4. 启动消息监听循环

## 十四、加密算法分析

### 14.1 配置加密
设置.ini 中的值采用简单的异或+偏移加密：
```
原始格式: [HEX编码数据]20CB5D79B
后缀 "20CB5D79B" 可能是版本/校验标识
```

### 14.2 消息内容加密
```
msg_attach 中的 "b" 字段:
Base64编码 + 自定义二进制协议
前缀 "CRpJHwGY4BIC" 等是协议头
```

### 14.3 昵称加密
群成员昵称使用 AES 或类似算法加密：
```
nickname_ciphertext: "mtmQz6FQ9lG6P3ZaOPXWrg=="
实际昵称: "橘子" 等
```

## 十五、功能模块详解

### 15.1 下注处理流程
```
1. 收到群消息 → 解析下注格式
   - "DD100" → 大单100
   - "上400" → 上分400
   - "1" → 查看历史/余额

2. 验证用户权限
   - 检查是否在托管列表
   - 检查余额是否充足

3. 记录下注
   - 写入 攻击.db
   - 更新玩家余额

4. 发送确认消息
   - @ 玩家
   - 显示下注详情
```

### 15.2 开奖结算流程
```
1. 定时拉取开奖号 (每3秒轮询)
   - 从开奖接口获取最新期号
   - 格式: "开:X+X+X=XX"

2. 解析开奖结果
   - 计算和值 (0-27)
   - 判断大小 (14分界)
   - 判断单双
   - 判断特殊形态

3. 结算玩家账单
   - 遍历当期下注记录
   - 计算盈亏
   - 更新余额

4. 发送结果
   - 开奖信息
   - 详细账单
   - 历史走势
```

### 15.3 封盘逻辑
```
游戏周期: 约3.5分钟
├── 下注期: 2分30秒
├── 封盘期: 40秒提示
├── 禁言封盘: 开奖前5-10秒
├── 开奖公布
└── 解除禁言 → 新一期开始

消息时间线:
- "距离封盘时间还有40秒" → 40秒提示
- "==加分规则==" → 封盘通知
- "核对" → 下注核对
- 全群禁言
- "开:X+X+X=XX" → 开奖号
- 详细账单
- 解除禁言
```

## 十六、数据库表结构推测

### 16.1 攻击表 (下注记录)
```sql
CREATE TABLE bets (
    id INTEGER PRIMARY KEY,
    period VARCHAR(20),          -- 期号 "3382923"
    qq VARCHAR(20),              -- 玩家QQ
    nickname VARCHAR(50),        -- 昵称
    bet_type VARCHAR(10),        -- DD/DX/XD/XS...
    amount INTEGER,              -- 下注金额
    create_time DATETIME,        -- 下注时间
    is_settled BOOLEAN,          -- 是否结算
    profit INTEGER               -- 盈亏
);
```

### 16.2 上下分表 (余额管理)
```sql
CREATE TABLE balances (
    id INTEGER PRIMARY KEY,
    qq VARCHAR(20) UNIQUE,       -- 玩家QQ
    nickname VARCHAR(50),        -- 昵称
    balance INTEGER DEFAULT 0,   -- 当前余额
    total_in INTEGER DEFAULT 0,  -- 总上分
    total_out INTEGER DEFAULT 0, -- 总下分
    update_time DATETIME
);
```

### 16.3 账单表 (每期结算)
```sql
CREATE TABLE bills (
    id INTEGER PRIMARY KEY,
    period VARCHAR(20),          -- 期号
    result VARCHAR(20),          -- 开奖结果 "2+7+6=15"
    total_bet INTEGER,           -- 总下注
    total_profit INTEGER,        -- 总盈亏
    player_count INTEGER,        -- 参与人数
    create_time DATETIME
);
```

## 十七、接口调用汇总

### 17.1 内部DLL调用
```
YX_Client.dll 导出函数 (推测):
- Login(token, callback)          // 登录
- SendGroupMsg(groupId, msg)      // 发群消息
- SendP2PMsg(userId, msg)         // 发私聊
- GetGroupList()                  // 获取群列表
- GetGroupMembers(groupId)        // 获取群成员
- SetGroupMuteAll(groupId, flag)  // 全群禁言
- SetMemberCard(groupId, userId, card) // 改名片
```

### 17.2 HPSocket通信
```
端口: 14745
协议: PACK模式
包头: 0xFF + 4字节长度 + JSON数据

消息类型:
- Login: 客户端登录
- Heartbeat: 心跳保活
- Message: 消息转发
- Command: 控制指令
```

---

## 附录A: 常见下注格式

| 输入 | 含义 | 示例 |
|------|------|------|
| D100 | 大100 | 下大100分 |
| X50 | 小50 | 下小50分 |
| DD200 | 大单200 | 下大单200分 |
| DS150 | 大双150 | 下大双150分 |
| XD100 | 小单100 | 下小单100分 |
| XS100 | 小双100 | 下小双100分 |
| 0-27 | 数字 | 下具体数字 |
| 上XXX | 上分 | 请求上分 |
| 查XXX | 下分 | 请求提现 |
| 1/2/3 | 查询 | 查看历史/余额 |

## 附录B: 开奖结果判定

| 和值 | 大小 | 单双 | 特殊 |
|------|------|------|------|
| 0-13 | 小(X) | 看个位 | |
| 14-27 | 大(D) | 看个位 | |
| 0/27 | - | - | 极小/极大 |
| 三同 | - | - | 豹子 |
| 连续 | - | - | 顺子 |
| 两同 | - | - | 对子 |

---

**文档版本**: 2.0  
**分析日期**: 2026-01-11  
**分析工具**: 日志分析 + 配置解析 + 截图分析 + 协议抓包
